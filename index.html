<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <title>Legacy CRM - Enterprise 360 (v6.0 Premium) - Autenticado</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>


    <style>
        :root {
            /* Cores Globais */
            --primary-color: #2563eb;
            --primary-dark: #1e40af;
            --primary-light: #60a5fa;
            --accent-glow: rgba(37, 99, 235, 0.5);
            --secondary-color: #64748b;
            --bg-body: #f8fafc;
            --bg-panel: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border-radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --wa-green: #00a884;
            --wa-bg: #efeae2;
            --wa-sidebar: #ffffff;
            --wa-header: #f0f2f5;
            
            /* Vars Quote Builder */
            --paper-width: 210mm;
            --paper-height: 297mm;
            --quote-accent: #2563eb;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        /* ==========================================================================
           TELA DE LOGIN SUPABASE (NOVO)
           ========================================================================== */
        #supabase-login-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
            z-index: 10000; /* Acima da Intro 3D */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            width: 100%;
            max-width: 400px;
            text-align: center;
            animation: slideUpLogin 0.5s ease;
        }

        @keyframes slideUpLogin { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .login-logo {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .login-title { font-size: 1.5rem; font-weight: 700; color: #1e293b; margin-bottom: 5px; }
        .login-subtitle { color: #64748b; font-size: 0.9rem; margin-bottom: 30px; }

        .login-form-group { margin-bottom: 15px; text-align: left; }
        .login-form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.85rem; color: #475569; }
        .login-input { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; outline: none; transition: 0.3s; }
        .login-input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }

        .btn-login {
            width: 100%; padding: 12px; background: var(--primary-color); color: white; border: none; border-radius: 8px;
            font-weight: 600; cursor: pointer; transition: 0.3s; margin-top: 10px;
        }
        .btn-login:hover { background: var(--primary-dark); }
        .btn-login:disabled { background: #94a3b8; cursor: not-allowed; }

        .login-error {
            color: #ef4444; font-size: 0.85rem; margin-top: 15px; display: none; background: #fef2f2; padding: 10px; border-radius: 6px; border: 1px solid #fecaca;
        }

        /* Ocultar elementos do sistema enquanto não logado */
        body.not-authenticated aside,
        body.not-authenticated main,
        body.not-authenticated #mobile-menu-trigger,
        body.not-authenticated #mobile-tab-bar,
        body.not-authenticated #intro-screen {
            display: none !important;
        }
        
        /* Ocultar login quando autenticado */
        body.authenticated #supabase-login-overlay {
            display: none !important;
        }

        /* ==========================================================================
           NOVA INTRODUÇÃO 3D PREMIUM ENTERPRISE
           ========================================================================== */
        #intro-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            perspective: 1200px; /* Profundidade 3D */
            overflow: hidden;
            animation: introExit 0.8s ease-in-out 3s forwards; /* Duração ajustada para 3s */
            pointer-events: none;
        }
        
        @keyframes introExit {
            0% { opacity: 1; transform: scale(1); filter: blur(0); }
            100% { opacity: 0; transform: scale(1.1); filter: blur(10px); visibility: hidden; }
        }

        /* Cubo 3D Central */
        .intro-3d-wrapper {
            position: relative;
            width: 100px;
            height: 100px;
            transform-style: preserve-3d;
            animation: floatCube 4s ease-in-out infinite;
            margin-bottom: 40px;
        }

        .cube {
            width: 100%;
            height: 100%;
            position: absolute;
            transform-style: preserve-3d;
            animation: rotateCube 10s infinite linear;
        }

        .cube-face {
            position: absolute;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 20px var(--accent-glow);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: var(--primary-light);
            font-weight: bold;
        }

        .face-front  { transform: rotateY(0deg) translateZ(50px); }
        .face-back   { transform: rotateY(180deg) translateZ(50px); }
        .face-right  { transform: rotateY(90deg) translateZ(50px); }
        .face-left   { transform: rotateY(-90deg) translateZ(50px); }
        .face-top    { transform: rotateX(90deg) translateZ(50px); }
        .face-bottom { transform: rotateX(-90deg) translateZ(50px); }

        /* Partículas de Fundo */
        .particles {
            position: absolute;
            width: 100%; height: 100%;
            top: 0; left: 0;
            z-index: -1;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(37, 99, 235, 0.1) 0%, transparent 10%),
                radial-gradient(circle at 80% 70%, rgba(37, 99, 235, 0.1) 0%, transparent 10%);
            animation: pulseBg 5s ease infinite alternate;
        }

        /* Texto e Loader */
        .intro-content {
            text-align: center;
            z-index: 10;
            position: relative;
        }

        .intro-title {
            font-size: 2.5rem;
            font-weight: 800;
            color: white;
            margin-bottom: 5px;
            letter-spacing: -1px;
            background: linear-gradient(to right, #ffffff, #94a3b8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            opacity: 0;
            animation: textFadeIn 0.8s ease forwards 0.5s;
        }

        .intro-subtitle {
            font-size: 0.9rem;
            color: #94a3b8;
            letter-spacing: 3px;
            text-transform: uppercase;
            margin-bottom: 30px;
            opacity: 0;
            animation: textFadeIn 0.8s ease forwards 0.8s;
        }

        /* Loader Circular Premium */
        .loading-ring {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
            opacity: 0;
            animation: spin 1s ease-in-out infinite, textFadeIn 0.5s ease forwards 1s;
        }

        .loading-text {
            display: block;
            margin-top: 15px;
            font-size: 0.75rem;
            color: #64748b;
            font-family: monospace;
            opacity: 0;
            animation: textFadeIn 0.5s ease forwards 1.2s;
        }

        @keyframes rotateCube {
            0% { transform: rotateX(0deg) rotateY(0deg); }
            100% { transform: rotateX(360deg) rotateY(360deg); }
        }
        @keyframes floatCube {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        @keyframes textFadeIn { to { opacity: 1; } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulseBg {
            0% { opacity: 0.5; transform: scale(1); }
            100% { opacity: 1; transform: scale(1.05); }
        }

        /* --- FIM CSS INTRO --- */

        /* --- Layout Principal --- */
        aside {
            width: 260px;
            background: #1e293b;
            color: white;
            display: flex;
            flex-direction: column;
            padding: 20px 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            transition: var(--transition);
            z-index: 10;
        }

        .brand {
            padding: 0 24px 24px;
            border-bottom: 1px solid #334155;
            margin-bottom: 20px;
        }
        .brand h2 { font-size: 1.2rem; font-weight: 600; letter-spacing: 0.5px; }
        .brand span { font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; }

        nav button {
            background: none;
            border: none;
            width: 100%;
            padding: 14px 24px;
            text-align: left;
            color: #94a3b8;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.95rem;
        }
        nav button:hover, nav button.active {
            color: white;
            background: #334155;
            border-right: 4px solid var(--primary-color);
        }

        main {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            position: relative;
        }

        /* --- Abas --- */
        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;
        }
        header h1 { font-size: 1.8rem; font-weight: 700; color: #0f172a; }

        /* --- Cards e Grids --- */
        .grid-cards {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px;
        }
        .card {
            background: var(--bg-panel); padding: 24px; border-radius: var(--border-radius);
            box-shadow: var(--shadow); position: relative; overflow: hidden;
            transition: var(--transition);
        }
        .card h3 { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 10px; font-weight: 500; }
        .card .number { font-size: 2rem; font-weight: 700; color: var(--text-main); }
        .card-icon {
            position: absolute; right: 20px; top: 20px; font-size: 2.5rem; opacity: 0.1; color: var(--primary-color);
        }

        /* --- Tabelas --- */
        .data-table-container {
            background: var(--bg-panel); border-radius: var(--border-radius); box-shadow: var(--shadow); overflow: hidden; overflow-x: auto;
        }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 16px 24px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background: #f8fafc; font-weight: 600; color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; }
        tr:hover { background: #f8fafc; }
        .status-badge {
            padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;
        }
        .status-badge.active { background: #dcfce7; color: #166534; }
        .status-badge.lead { background: #dbeafe; color: #1e40af; }
        .status-badge.pending { background: #fef3c7; color: #92400e; }
        .status-badge.closed { background: #e2e8f0; color: #475569; }
        .status-badge.danger { background: #fecaca; color: #ef4444; }

        /* --- Botões --- */
        .btn {
            padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 500;
            display: inline-flex; align-items: center; gap: 8px; transition: var(--transition);
        }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-primary:hover { background: var(--primary-dark); box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2); }
        .btn-outline { background: transparent; border: 1px solid var(--secondary-color); color: var(--text-main); }
        .btn-outline.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        .btn-outline:hover { background: #f8fafc; border-color: var(--primary-color); color: var(--primary-color); }
        .btn-wa { background: #25D366; color: white; border:none; }
        .btn-wa:hover { background: #128C7E; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
        .btn-icon { padding: 8px; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center;}
        .btn-danger-outline { border: 1px solid #fecaca; color: #ef4444; background: white; }
        .btn-danger-outline:hover { background: #fef2f2; border-color: #ef4444; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-glass { background: rgba(255,255,255,0.8); backdrop-filter: blur(4px); border: 1px solid rgba(0,0,0,0.05); color: var(--text-main); }
        .btn-glass:hover { background: rgba(255,255,255,1); box-shadow: var(--shadow); }
        .btn-clean { background: none; border: none; color: #64748b; cursor: pointer; font-size: 0.9rem; }
        .btn-clean:hover { color: var(--primary-color); }

        /* --- Modais --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            display: none; justify-content: center; align-items: center; z-index: 1000;
            backdrop-filter: blur(4px);
        }
        .modal {
            background: white; width: 90%; max-width: 900px; border-radius: 16px; 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s ease;
            display: flex; flex-direction: column;
        }
        .modal-sm { max-width: 500px; }
        .modal-lg { max-width: 1100px; height: 85vh; }
        .modal-xl { max-width: 1400px; height: 90vh; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px; }
        .form-tri { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-top: 10px; }
        .form-full { grid-column: span 2; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-size: 0.85rem; font-weight: 600; color: #475569; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 0.95rem; outline: none; transition: border-color 0.2s; background-color: #f8fafc;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { 
            border-color: var(--primary-color); background: #fff; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); 
        }
        .input-money { font-family: monospace; font-weight: 700; color: #334155; }
        .color-picker-wrapper { display: flex; gap: 10px; align-items: center; }
        .color-picker-wrapper input[type=color] { width: 50px; padding: 0; height: 45px; cursor: pointer; border: none; background: none; }
        .modal-header-premium { padding: 25px; background: linear-gradient(to right, #ffffff, #f8fafc); border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .profile-header-info { display: flex; align-items: center; gap: 20px; }
        .avatar-circle { width: 70px; height: 70px; background: #e0e7ff; color: var(--primary-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; font-weight: bold; border: 2px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .modal-tabs-nav { display: flex; padding: 0 25px; border-bottom: 1px solid #e2e8f0; background: white; gap: 30px; }
        .modal-tab-btn { padding: 15px 0; background: none; border: none; color: #64748b; font-weight: 500; font-size: 0.9rem; cursor: pointer; position: relative; transition: all 0.2s; }
        .modal-tab-btn:hover { color: var(--primary-color); }
        .modal-tab-btn.active { color: var(--primary-color); font-weight: 600; }
        .modal-tab-btn.active::after { content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 2px; background: var(--primary-color); }
        .modal-body-content { padding: 30px; background: #fff; min-height: 300px; flex: 1; overflow-y: auto;}
        .inner-tab { display: none; animation: fadeIn 0.3s; }
        .inner-tab.active { display: block; }
        .section-title { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; color: #94a3b8; font-weight: 700; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 10px; }
        
        /* --- Timeline --- */
        .timeline { position: relative; margin-top: 10px; padding-left: 10px; }
        .timeline-item { position: relative; margin-bottom: 25px; padding-left: 25px; }
        .timeline-item::before { content: ''; position: absolute; left: 0px; top: 25px; bottom: -25px; width: 2px; background: #e2e8f0; z-index: 0; }
        .timeline-item:last-child::before { display: none; }
        .timeline-icon { position: absolute; left: -9px; top: 0; width: 20px; height: 20px; background: white; border-radius: 50%; z-index: 2; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; box-shadow: 0 0 0 2px white; }
        .t-call { background: #dbeafe; color: #2563eb; }
        .t-whatsapp { background: #dcfce7; color: #166534; }
        .t-email { background: #f3e8ff; color: #7e22ce; }
        .t-meeting { background: #ffedd5; color: #c2410c; }
        .t-note { background: #f1f5f9; color: #64748b; }
        .timeline-content { background: #ffffff; padding: 12px 15px; border-radius: 8px; border: 1px solid #e2e8f0; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .timeline-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.8rem; }
        .timeline-date { color: var(--text-muted); font-weight: 500; }
        .timeline-type { font-weight: 700; text-transform: uppercase; font-size: 0.65rem; letter-spacing: 0.5px; opacity: 0.7; }

        /* ==========================================================================
           PREMIUM PROJECT MANAGEMENT STYLES (ENTERPRISE 2.0)
           ========================================================================== */
        #albums-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px; padding-bottom: 40px; }
        .project-card-premium { background: white; border-radius: 16px; box-shadow: var(--shadow); transition: var(--transition); border: 1px solid #f1f5f9; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .project-card-premium:hover { transform: translateY(-5px); box-shadow: var(--shadow-hover); border-color: #cbd5e1; }
        .pcp-stripe { height: 6px; width: 100%; background: linear-gradient(90deg, var(--primary-color), var(--primary-dark)); }
        .pcp-header { padding: 20px 20px 10px 20px; display: flex; justify-content: space-between; align-items: flex-start; }
        .pcp-info h4 { font-size: 1.05rem; font-weight: 700; color: #1e293b; margin-bottom: 4px; line-height: 1.3; }
        .pcp-client { font-size: 0.85rem; color: #64748b; display: flex; align-items: center; gap: 6px; }
        .pcp-client i { color: var(--primary-color); opacity: 0.7; }
        .pcp-actions { display: flex; gap: 8px; }
        .pcp-btn-action { width: 32px; height: 32px; border-radius: 8px; border: 1px solid #e2e8f0; background: white; color: #64748b; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
        .pcp-btn-action:hover { background: #f1f5f9; color: var(--primary-color); border-color: #cbd5e1; }
        .pcp-btn-action.delete:hover { background: #fef2f2; color: #ef4444; border-color: #fca5a5; }
        .pcp-body { padding: 15px 20px; flex: 1; }
        .pcp-stage-info { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 8px; }
        .pcp-stage-label { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: #94a3b8; letter-spacing: 0.5px; }
        .pcp-stage-current { font-size: 0.9rem; font-weight: 700; color: var(--primary-color); }
        .pcp-progress-track { height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; width: 100%; }
        .pcp-progress-fill { height: 100%; background: linear-gradient(90deg, #3b82f6, #2563eb); border-radius: 4px; transition: width 0.5s ease; }
        .pcp-footer { padding: 15px 20px; background: #f8fafc; border-top: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
        .pcp-date { font-size: 0.75rem; color: #94a3b8; }
        .pcp-btn-advance { background: white; border: 1px solid #cbd5e1; color: #475569; font-size: 0.8rem; font-weight: 600; padding: 6px 14px; border-radius: 6px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
        .pcp-btn-advance:hover { background: var(--primary-color); border-color: var(--primary-color); color: white; }
        
        .prj-timeline { display: flex; flex-direction: column; position: relative; padding: 10px 0 10px 25px; }
        .prj-timeline::before { content: ''; position: absolute; left: 20px; top: 10px; bottom: 30px; width: 3px; background: #e2e8f0; z-index: 0; transform: translateX(-50%); }
        .prj-event { display: flex; align-items: center; gap: 20px; margin-bottom: 25px; position: relative; z-index: 1; opacity: 0.6; transition: all 0.3s; }
        .prj-event.completed { opacity: 1; }
        .prj-event.active { opacity: 1; transform: translateX(5px); }
        .prj-dot { width: 40px; height: 40px; border-radius: 50%; background: #ffffff; border: 3px solid #cbd5e1; display: flex; align-items: center; justify-content: center; font-weight: 700; color: #64748b; flex-shrink: 0; position: relative; z-index: 2; }
        .prj-event.completed .prj-dot { background: #dcfce7; border-color: #10b981; color: #166534; }
        .prj-event.active .prj-dot { background: var(--primary-color); border-color: var(--primary-dark); color: white; box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.2); }
        .prj-card { flex: 1; background: white; padding: 16px 20px; border-radius: 12px; border: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .prj-event.active .prj-card { border-color: var(--primary-color); box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.1); }
        .prj-info h4 { margin: 0; font-size: 0.95rem; font-weight: 600; color: #334155; }
        .prj-info p { margin: 2px 0 0 0; font-size: 0.8rem; color: #94a3b8; }
        .workflow-setup-container { display: flex; gap: 30px; height: 100%; }
        .ws-sidebar { width: 30%; border-right: 1px solid #e2e8f0; padding-right: 20px; display:flex; flex-direction:column; gap:20px; }
        .ws-content { flex: 1; overflow-y: auto; }
        .type-card { border: 1px solid #e2e8f0; border-radius: 10px; padding: 15px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 12px; background: white; margin-bottom: 10px; }
        .type-card:hover { border-color: var(--primary-color); transform: translateX(5px); }
        .type-card.selected { border-color: var(--primary-color); background: #eff6ff; }
        .type-icon { width: 40px; height: 40px; border-radius: 8px; background: #e0e7ff; color: var(--primary-color); display: flex; align-items: center; justify-content: center; font-size: 1.1rem; }
        .type-info h4 { font-size: 0.9rem; font-weight: 600; color: #334155; margin-bottom: 2px; }
        .type-info p { font-size: 0.75rem; color: #94a3b8; }
        .step-list-editable { list-style: none; display: flex; flex-direction: column; gap: 10px; }
        .step-item-edit { display: flex; align-items: center; gap: 15px; padding: 12px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; position: relative; }
        .step-num-badge { width: 24px; height: 24px; background: #cbd5e1; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 700; }
        .step-content-edit { flex: 1; }
        .step-content-edit input { border: none; background: transparent; font-size: 0.9rem; width: 100%; color: #334155; font-weight: 500; }
        .step-content-edit input:focus { border-bottom: 1px solid var(--primary-color); outline: none; }
        .prj-action-btn { background: #e2e8f0; color: #475569; border:none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600; transition: all 0.2s; }
        .prj-event.active .prj-action-btn { background: var(--primary-color); color: white; }
        .prj-event.active .prj-action-btn:hover { background: var(--primary-dark); }
        
        /* --- CALENDÁRIO & AGENDA --- */
        .calendar-full-container { display: flex; flex-direction: column; height: 100%; }
        .cal-controls { display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; border-bottom: 1px solid #f1f5f9; margin-bottom: 15px; }
        .cal-controls h3 { font-size: 1.1rem; color: var(--text-main); font-weight: 600; margin: 0; text-transform: capitalize; }
        .cal-btn-group button { background: white; border: 1px solid #e2e8f0; padding: 6px 12px; border-radius: 6px; cursor: pointer; color: var(--text-muted); transition: all 0.2s; }
        .cal-btn-group button:hover { border-color: var(--primary-color); color: var(--primary-color); }
        .cal-month-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #e2e8f0; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; }
        .cal-day-header { background: #f8fafc; padding: 12px 0; text-align: center; font-size: 0.75rem; font-weight: 700; color: #64748b; text-transform: uppercase; }
        .cal-cell { background: white; min-height: 100px; padding: 10px; position: relative; transition: background 0.2s; cursor: pointer; }
        .cal-cell:hover { background: #fdfdfd; }
        .cal-cell-num { font-size: 0.9rem; font-weight: 600; color: #475569; margin-bottom: 5px; display: block; }
        .cal-cell.other-month { background: #fbfbfc; color: #cbd5e1; }
        .cal-cell.other-month .cal-cell-num { color: #cbd5e1; }
        .cal-cell.today { background: #eff6ff; }
        .cal-cell.today .cal-cell-num { color: var(--primary-color); display: inline-block; background: #dbeafe; width: 24px; height: 24px; text-align: center; line-height: 24px; border-radius: 50%; }
        .cal-event-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 3px; }
        .agenda-layout { display: grid; grid-template-columns: 280px 1fr; gap: 20px; height: calc(100vh - 120px); }
        .agenda-sidebar { background: white; border-radius: 12px; padding: 20px; display: flex; flex-direction: column; gap: 20px; box-shadow: var(--shadow); overflow-y: auto;}
        .agenda-main { background: white; border-radius: 12px; padding: 20px; box-shadow: var(--shadow); display: flex; flex-direction: column; }
        .agenda-event-pill { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: white; cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,0.1); opacity: 0.9; }
        .agenda-event-pill:hover { opacity: 1; transform: scale(1.02); }
        .mini-list-item { padding: 10px; border-bottom: 1px solid #f1f5f9; display: flex; gap: 10px; align-items: flex-start; }
        .mini-list-item:last-child { border-bottom: none; }
        .mini-time { font-size: 0.75rem; color: #64748b; font-weight: 600; min-width: 40px; }
        .mini-desc h4 { font-size: 0.85rem; margin-bottom: 2px; color: #334155; }
        .mini-desc p { font-size: 0.75rem; color: #94a3b8; }
        .mini-tag { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-top: 5px; }

        /* --- GESTÃO NAV --- */
        .mgmt-nav { display: flex; gap: 10px; margin-bottom: 25px; background: white; padding: 10px; border-radius: 12px; box-shadow: var(--shadow); overflow-x: auto; }
        .mgmt-nav button { padding: 10px 20px; border: none; background: transparent; border-radius: 8px; color: var(--text-muted); font-weight: 500; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
        .mgmt-nav button:hover { background: #f1f5f9; color: var(--primary-color); }
        .mgmt-nav button.active { background: var(--primary-color); color: white; shadow: 0 4px 6px rgba(37, 99, 235, 0.2); }
        .mgmt-section { display: none; animation: fadeIn 0.3s ease; }
        .mgmt-section.active { display: block; }

        /* --- ESTOQUE & DRE --- */
        .stock-kpi { display: flex; gap: 20px; margin-bottom: 20px; }
        .stock-kpi-card { flex: 1; background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; display:flex; align-items: center; justify-content: space-between; }
        .stock-kpi-card .val { font-size: 1.4rem; font-weight: 700; }
        .stock-kpi-card .label { font-size: 0.8rem; color: #64748b; }
        .dre-table { width: 100%; border-collapse: collapse; font-family: 'Courier New', monospace; }
        .dre-table td, .dre-table th { padding: 12px 15px; border-bottom: 1px solid #e2e8f0; }
        .dre-table tr.total-row { background: #f8fafc; font-weight: bold; }
        .dre-table .val-neg { color: #ef4444; }
        .dre-table .val-pos { color: #166534; }
        .dre-indent { padding-left: 30px; }

        /* =================================================================
           NOVO CSS: CRIADOR DE ORÇAMENTOS PREMIUM (SPLIT VIEW)
           ================================================================= */
        .quote-builder-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 30px;
            height: calc(100vh - 200px);
            min-height: 600px;
        }

        /* --- Barra Lateral de Configuração --- */
        .quote-sidebar {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 20px;
            overflow-y: auto;
            border: 1px solid #f1f5f9;
        }
        
        .q-config-group {
            margin-bottom: 25px;
            border-bottom: 1px solid #f1f5f9;
            padding-bottom: 20px;
        }
        .q-config-group:last-child { border:none; }
        .q-config-title {
            font-size: 0.85rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; margin-bottom: 15px;
            display: flex; align-items: center; gap: 8px;
        }

        .upload-box {
            border: 2px dashed #cbd5e1; border-radius: 8px; padding: 15px; text-align: center;
            cursor: pointer; transition: all 0.2s; background: #f8fafc; position: relative;
        }
        .upload-box:hover { border-color: var(--primary-color); background: #eff6ff; }
        .upload-box input[type="file"] {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;
        }
        .upload-preview {
            max-height: 60px; display: block; margin: 10px auto 0; border-radius: 4px; border: 1px solid #e2e8f0;
        }

        .layout-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .layout-opt {
            border: 2px solid #e2e8f0; border-radius: 8px; padding: 10px; text-align: center; cursor: pointer; opacity: 0.7;
        }
        .layout-opt:hover { opacity: 1; border-color: #94a3b8; }
        .layout-opt.active { border-color: var(--primary-color); opacity: 1; background: #eff6ff; color: var(--primary-color); font-weight: 600; }

        /* --- Área de Preview (Papel) --- */
        .quote-preview-container {
            background: #cbd5e1;
            border-radius: 12px;
            padding: 40px;
            overflow-y: auto;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
        }

        .quote-paper {
            width: var(--paper-width);
            min-height: var(--paper-height);
            background: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            padding: 0; /* Layout controla padding */
            position: relative;
            color: #1e293b;
            font-size: 12pt;
            display: flex; flex-direction: column;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        /* --- Layout Moderno --- */
        .quote-paper.layout-modern { padding: 50px; }
        .quote-paper.layout-modern .q-header { display: flex; justify-content: space-between; margin-bottom: 40px; border-bottom: 2px solid var(--quote-accent); padding-bottom: 20px; }
        .quote-paper.layout-modern .q-logo { max-height: 80px; max-width: 200px; object-fit: contain; }
        .quote-paper.layout-modern .q-title { font-size: 24pt; font-weight: 800; color: var(--quote-accent); text-transform: uppercase; margin-top: 10px; }
        .quote-paper.layout-modern table { margin-top: 30px; width: 100%; border-collapse: collapse; }
        .quote-paper.layout-modern th { background: var(--quote-accent); color: white; padding: 10px; text-transform: uppercase; font-size: 0.9rem; }
        .quote-paper.layout-modern td { padding: 12px 10px; border-bottom: 1px solid #e2e8f0; }
        .quote-paper.layout-modern .q-total-area { margin-top: 40px; text-align: right; font-size: 1.5rem; font-weight: bold; color: var(--quote-accent); }

        /* --- Layout Enterprise (Clean / Folder) --- */
        .quote-paper.layout-enterprise { padding: 0; }
        .quote-paper.layout-enterprise .q-top-bar { height: 15px; background: var(--quote-accent); width: 100%; }
        .quote-paper.layout-enterprise .q-content-pad { padding: 50px; flex: 1; background: rgba(255,255,255,0.9); /* Opacidade para ver fundo */ }
        .quote-paper.layout-enterprise .q-header { display: grid; grid-template-columns: 100px 1fr; gap: 20px; margin-bottom: 50px; align-items: center; }
        .quote-paper.layout-enterprise .q-logo { width: 100px; height: 100px; object-fit: contain; background: #f8fafc; border-radius: 50%; padding: 5px; }
        .quote-paper.layout-enterprise .q-info-box { border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; background: #fff; margin-bottom: 20px; }
        .quote-paper.layout-enterprise th { border-bottom: 2px solid var(--quote-accent); color: var(--quote-accent); text-align: left; padding: 10px; font-weight: 700; }
        .quote-paper.layout-enterprise tr:nth-child(even) { background: #f8fafc; }
        .quote-paper.layout-enterprise .q-footer { background: #1e293b; color: white; padding: 20px 50px; font-size: 0.8rem; text-align: center; margin-top: auto; }

        @media print {
            body * { visibility: hidden; }
            .quote-paper, .quote-paper * { visibility: visible; }
            .quote-paper { position: absolute; left: 0; top: 0; margin: 0; box-shadow: none; width: 100%; height: auto; min-height: auto; print-color-adjust: exact; -webkit-print-color-adjust: exact; }
            .modal-overlay, aside, header { display: none !important; }
        }

        /* --- Outros Styles do Sistema --- */
        .report-grid-premium { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .kpi-report-card { background: white; border-radius: 12px; padding: 20px; border: 1px solid #f1f5f9; box-shadow: var(--shadow); position: relative; overflow: hidden; display: flex; flex-direction: column; height: 100%; min-height: 200px; }
        .kpi-report-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-hover); border-color: #cbd5e1; }
        .kpi-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .kpi-head h4 { font-size: 0.95rem; color: #1e293b; font-weight: 700; }
        .kpi-head i { font-size: 1.2rem; color: var(--text-muted); opacity: 0.5; }
        .chart-container { flex: 1; display: flex; align-items: flex-end; justify-content: space-around; gap: 8px; padding-top: 10px; padding-bottom: 10px; min-height: 120px; }
        .chart-bar-group { display: flex; flex-direction: column; align-items: center; width: 100%; height: 100%; justify-content: flex-end; }
        .chart-bar { width: 100%; background: #e2e8f0; border-radius: 4px 4px 0 0; position: relative; transition: height 0.5s cubic-bezier(0.4, 0, 0.2, 1); min-width: 20px; max-width: 40px; }
        .chart-bar:hover { opacity: 0.8; }
        .chart-bar.c-primary { background: var(--primary-color); }
        .chart-bar.c-success { background: #10b981; }
        .chart-bar.c-danger { background: #ef4444; }
        .chart-bar.c-warning { background: #f59e0b; }
        .chart-label { font-size: 0.65rem; color: #64748b; margin-top: 6px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; font-weight: 500;}
        .chart-val-tooltip { position: absolute; top: -25px; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; opacity: 0; transition: opacity 0.2s; pointer-events: none; white-space: nowrap; }
        .chart-bar:hover .chart-val-tooltip { opacity: 1; top: -30px; }
        .report-builder-box { background: linear-gradient(135deg, #f8fafc 0%, #eff6ff 100%); border: 1px dashed #cbd5e1; border-radius: 12px; padding: 30px; text-align: center; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 200px; }
        .report-builder-box:hover { background: #fff; border-color: var(--primary-color); box-shadow: var(--shadow); }
        .report-builder-box i { font-size: 2.5rem; color: var(--primary-color); margin-bottom: 15px; opacity: 0.8; }
        .report-builder-box span { font-weight: 600; color: #1e293b; margin-bottom: 5px; }
        .report-builder-box small { color: #64748b; font-size: 0.8rem; }
        .wa-layout { display: flex; height: 100%; width: 100%; background: #fff; overflow: hidden; border-radius: 0 0 16px 16px; }
        .wa-sidebar { width: 300px; border-right: 1px solid #e2e8f0; display: flex; flex-direction: column; background: white; }
        .wa-header { padding: 10px 16px; background: var(--wa-header); height: 60px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #d1d7db; }
        .wa-search-box { padding: 10px; background: white; border-bottom: 1px solid #f1f5f9; }
        .wa-search-input { width: 100%; background: #f0f2f5; border: none; padding: 8px 15px; border-radius: 8px; outline: none; font-size: 0.9rem; }
        .wa-list { flex: 1; overflow-y: auto; }
        .wa-list-item { padding: 12px 15px; display: flex; align-items: center; gap: 12px; cursor: pointer; border-bottom: 1px solid #f1f5f9; transition: background 0.2s; position: relative;}
        .wa-list-item:hover { background: #f5f6f6; }
        .wa-list-item.active { background: #f0f2f5; }
        .wa-avatar { width: 45px; height: 45px; background: #dfe4ea; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 1.2rem; }
        .wa-list-action-btn { opacity: 0; transition: opacity 0.2s; padding: 4px; margin-left: 5px; cursor: pointer; color: #8696a0; z-index: 10; font-size: 0.9rem;}
        .wa-list-item:hover .wa-list-action-btn { opacity: 1; }
        .wa-list-action-btn:hover { color: var(--primary-color); }
        .wa-chat-area { flex: 1; display: flex; flex-direction: column; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-color: var(--wa-bg); }
        .wa-chat-header { height: 60px; background: var(--wa-header); padding: 10px 16px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #d1d7db; }
        .wa-chat-body { flex: 1; padding: 20px 40px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .wa-msg { max-width: 65%; padding: 8px 12px; border-radius: 8px; font-size: 0.9rem; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); line-height: 1.4; }
        .wa-msg.sent { align-self: flex-end; background: #d9fdd3; }
        .wa-msg.received { align-self: flex-start; background: #ffffff; }
        .wa-msg-meta { font-size: 0.65rem; color: #667781; text-align: right; margin-top: 4px; display: block; }
        .wa-footer { min-height: 62px; background: var(--wa-header); padding: 10px 16px; display: flex; align-items: center; gap: 10px; border-top: 1px solid #d1d7db; }
        .wa-input { flex: 1; background: white; border: none; padding: 12px 15px; border-radius: 8px; outline: none; font-size: 0.95rem; }
        .wa-btn-send { background: none; border: none; color: #54656f; font-size: 1.5rem; cursor: pointer; }
        .wa-btn-send.ready { color: var(--wa-green); }
        .customizer-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; margin-top: 15px; }
        .customizer-item { border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); position: relative; background: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 140px; }
        .customizer-item:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05); border-color: #cbd5e1; }
        .customizer-item.selected { border-color: var(--primary-color); background: #eff6ff; color: var(--primary-color); }
        .customizer-item i { font-size: 2rem; margin-bottom: 12px; color: #94a3b8; transition: color 0.2s; }
        .customizer-item.selected i { color: var(--primary-color); }
        .customizer-item span { font-weight: 600; font-size: 0.9rem; }
        .check-badge { position: absolute; top: 10px; right: 10px; width: 24px; height: 24px; background: var(--primary-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.7rem; opacity: 0; transform: scale(0); transition: all 0.2s; }
        .customizer-item.selected .check-badge { opacity: 1; transform: scale(1); }
        .home-grid-layout { display: grid; grid-template-columns: 2.5fr 1fr; gap: 30px; }
        @media (max-width: 600px) { .home-grid-layout { grid-template-columns: 1fr; } }

        /* --- FINANCEIRO PREMIUM --- */
        .fin-bi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .fin-card { background: white; border-radius: 12px; padding: 25px; box-shadow: var(--shadow); position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: space-between; height: 160px; }
        .fin-card-title { font-size: 0.9rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; z-index: 2; }
        .fin-card-value { font-size: 2.2rem; font-weight: 700; color: #1e293b; z-index: 2; margin-top: 10px; }
        .fin-card-bg-icon { position: absolute; right: -10px; bottom: -10px; font-size: 6rem; opacity: 0.05; z-index: 1; transform: rotate(-15deg); }
        .fin-card-trend { font-size: 0.8rem; margin-top: 10px; font-weight: 500; z-index: 2; display: flex; align-items: center; gap: 5px; }
        .fin-card.income { background: linear-gradient(135deg, #ffffff 0%, #f0fdf4 100%); border-bottom: 4px solid #10b981; }
        .fin-card.expense { background: linear-gradient(135deg, #ffffff 0%, #fef2f2 100%); border-bottom: 4px solid #ef4444; }
        .fin-card.balance { background: linear-gradient(135deg, #ffffff 0%, #eff6ff 100%); border-bottom: 4px solid #3b82f6; }
        .fin-progress-container { width: 100%; background: #e2e8f0; height: 6px; border-radius: 3px; margin-top: 15px; overflow: hidden; }
        .fin-progress-bar { height: 100%; border-radius: 3px; }
        .status-badge.paid { background: #dcfce7; color: #166534; }
        .status-badge.received { background: #dcfce7; color: #166534; }
        .status-badge.pending-pay { background: #fef3c7; color: #92400e; }
        .status-badge.late { background: #fee2e2; color: #991b1b; }
        .fin-type-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; }
        .type-in { background: #dcfce7; color: #166534; }
        .type-out { background: #fee2e2; color: #991b1b; }
        .fin-filter-bar { display: flex; gap: 15px; margin-bottom: 20px; background: white; padding: 15px; border-radius: 12px; box-shadow: var(--shadow); align-items: center; flex-wrap: wrap; }
        .fin-select { padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.9rem; outline: none; background: #f8fafc; }
        .fin-integration-box { background: linear-gradient(145deg, #f8fafc, #f1f5f9); border: 1px solid #e2e8f0; border-radius: 10px; padding: 15px; margin-bottom: 15px; position: relative; }
        .fin-integration-box::before { content: 'Integração Financeira'; position: absolute; top: -10px; left: 15px; background: var(--primary-color); color: white; font-size: 0.65rem; padding: 2px 8px; border-radius: 10px; font-weight: 600; text-transform: uppercase; }
        .fin-auto-badge { display: inline-flex; align-items: center; gap: 4px; background: #eff6ff; color: #2563eb; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; border: 1px solid #dbeafe; }
        .var-chip { background: #f1f5f9; color: #475569; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; cursor: pointer; border: 1px solid #e2e8f0; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; user-select: none; }
        .var-chip:hover { background: #e0e7ff; color: var(--primary-color); border-color: #cbd5e1; transform: translateY(-1px); }
        .var-chip i { opacity: 0.6; }
        .var-chip.finance { background: #dcfce7; color: #166534; border-color: #bbf7d0; }
        .var-chip.finance:hover { background: #bbf7d0; }
        .var-chip.event { background: #eff6ff; color: #1e40af; border-color: #bfdbfe; }
        .var-chip.event:hover { background: #bfdbfe; }
        .var-list-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; padding: 10px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0; }
        .var-list-title { font-size: 0.75rem; text-transform: uppercase; font-weight: 700; color: #94a3b8; margin-bottom: 8px; display: block; }
        
        /* --- Mobile Responsive Fixes --- */
        @media (max-width: 768px) {
            body { flex-direction: column; overflow-x: hidden; overflow-y: auto; padding-bottom: 80px; }
            #mobile-tab-bar { display: grid; }
            #mobile-menu-trigger { display: flex; }
            aside { position: fixed !important; left: -100% !important; top: 0; width: 85% !important; height: 100vh !important; z-index: 5000 !important; transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1) !important; background: var(--bg-panel) !important; border-radius: 0 24px 24px 0; display: block !important; padding: 20px !important; box-shadow: 10px 0 30px rgba(0,0,0,0.2); }
            aside.open { transform: translateX(100%); }
            main { padding: 15px !important; width: 100% !important; margin: 0 !important; }
            .grid-cards, .home-grid-layout, .form-grid, .form-tri, .agenda-layout, .fin-bi-grid, .workflow-setup-container, .report-grid-premium { grid-template-columns: 1fr !important; display: flex; flex-direction: column; gap: 15px; }
            header { flex-direction: column; align-items: flex-start; gap: 15px; background: white; margin: -15px -15px 15px -15px; padding: 20px 15px; border-bottom: 1px solid #edf2f7; }
            header div { width: 100%; }
            .data-table-container { border: 1px solid #e2e8f0; overflow-x: auto; background: white; border-radius: 16px; }
            table { min-width: 600px; }
            .quote-builder-container { display: flex; flex-direction: column; height: auto; }
            .quote-paper { transform: scale(0.6); transform-origin: top center; margin-bottom: -100px; }
            .modal, .modal-lg, .modal-xl, .modal-sm { width: 100% !important; height: 100% !important; top: 0 !important; left: 0 !important; transform: none !important; max-width: 100% !important; max-height: 100% !important; border-radius: 0; display: flex; flex-direction: column; position: fixed; }
            .modal-overlay { z-index: 6000; padding: 0; align-items: flex-start; }
            .wa-layout { flex-direction: column; height: 100%; }
            .wa-sidebar { width: 100%; height: 40%; border-right: none; border-bottom: 1px solid #eee; }
            .wa-chat-area { flex: 1; height: 60%; }
            .intro-title { font-size: 1.8rem; }
        }
    </style>
</head>
<body class="not-authenticated">

    <div id="supabase-login-overlay">
        <div class="login-card">
            <div class="login-logo"><i class="fas fa-chart-line"></i></div>
            <h1 class="login-title">Legacy CRM</h1>
            <p class="login-subtitle">Enterprise Edition 360</p>
            
            <div class="login-form-group">
                <label>Email de Acesso</label>
                <input type="email" id="login-email" class="login-input" placeholder="seu@email.com" onkeydown="if(event.key === 'Enter') document.getElementById('login-password').focus()">
            </div>
            
            <div class="login-form-group">
                <label>Senha</label>
                <input type="password" id="login-password" class="login-input" placeholder="••••••••" onkeydown="if(event.key === 'Enter') authManager.login()">
            </div>

            <div class="login-error" id="login-error-msg"></div>

            <button class="btn-login" onclick="authManager.login()" id="btn-do-login">Entrar no Sistema</button>
            <button class="btn btn-outline" style="width:100%; margin-top:10px; justify-content:center;"
            
            <p style="margin-top:20px; font-size:0.75rem; color:#94a3b8;">Sistema protegido e criptografado.</p>
        </div>
    </div>
<div id="intro-screen">
        <div class="particles"></div>
        
        <div class="intro-3d-wrapper">
            <div class="cube">
                <div class="cube-face face-front"><i class="fas fa-chart-line"></i></div>
                <div class="cube-face face-back"><i class="fas fa-users"></i></div>
                <div class="cube-face face-right"><i class="fas fa-project-diagram"></i></div>
                <div class="cube-face face-left"><i class="fas fa-wallet"></i></div>
                <div class="cube-face face-top"><i class="fas fa-cube"></i></div>
                <div class="cube-face face-bottom"><i class="fas fa-database"></i></div>
            </div>
        </div>

        <div class="intro-content">
            <h1 class="intro-title">Legacy CRM</h1>
            <p class="intro-subtitle">Enterprise Edition 360</p>
            
            <div class="loading-ring"></div>
            <span class="loading-text">Carregando Módulos...</span>
        </div>
    </div>

    <aside>
        <div class="brand">
            <h2>Legacy CRM</h2>
            <span>Enterprise Edition</span>
        </div>
        <nav>
            <button class="active" onclick="app.nav('home')"><i class="fas fa-home"></i> Início</button>
            <button onclick="app.nav('contacts')"><i class="fas fa-users"></i> Contatos 360º</button>
            <button onclick="app.nav('agenda')"><i class="fas fa-calendar-alt"></i> Agenda</button>
            <button onclick="app.nav('management')"><i class="fas fa-tasks"></i> Gestão Enterprise</button>
            <button onclick="app.nav('config')"><i class="fas fa-cog"></i> Config. Global</button>
            
            <button onclick="authManager.logout()" style="margin-top: auto; border-top: 1px solid #334155; color: #fca5a5;">
                <i class="fas fa-sign-out-alt"></i> Sair do Sistema
            </button>
        </nav>
    </aside>

    <main>
        <section id="tab-home" class="tab-content active">
            <header>
                <div>
                    <h1>Dashboard Principal</h1>
                    <p style="color: var(--text-muted)">Visão geral do sistema</p>
                </div>
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div style="text-align: right;">
                        <h3><i class="far fa-clock"></i> <span id="clock">00:00</span></h3>
                        <small id="date-display">Carregando data...</small>
                    </div>
                    <button class="btn btn-glass btn-sm" onclick="dashboardManager.openModal()">
                        <i class="fas fa-sliders-h"></i> Personalizar
                    </button>
                </div>
            </header>

            <div class="grid-cards">
                <div class="card" id="dash-card-calls">
                    <h3>Atendimentos Hoje</h3>
                    <div class="number">0</div>
                    <i class="fas fa-headset card-icon"></i>
                </div>
                <div class="card" id="dash-card-albums">
                    <h3>Projetos Ativos</h3>
                    <div class="number">0</div>
                    <i class="fas fa-tasks card-icon"></i>
                </div>
                <div class="card" id="dash-card-revenue">
                    <h3>Faturamento Mês</h3>
                    <div class="number" style="color: var(--success)">R$ 0,00</div>
                    <i class="fas fa-wallet card-icon"></i>
                </div>
            </div>

            <div class="home-grid-layout">
                <div class="card" id="dash-card-calendar">
                    <div class="calendar-full-container">
                        <div class="cal-controls">
                            <h3 id="cal-month-year">Janeiro 2024</h3>
                            <div class="cal-btn-group">
                                <button onclick="calendarManager.changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                                <button onclick="calendarManager.changeMonth(0)">Hoje</button>
                                <button onclick="calendarManager.changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
                            </div>
                        </div>
                        <div class="cal-day-header-row" style="display: grid; grid-template-columns: repeat(7, 1fr); text-align: center;">
                             <div class="cal-day-header">Dom</div>
                             <div class="cal-day-header">Seg</div>
                             <div class="cal-day-header">Ter</div>
                             <div class="cal-day-header">Qua</div>
                             <div class="cal-day-header">Qui</div>
                             <div class="cal-day-header">Sex</div>
                             <div class="cal-day-header">Sab</div>
                        </div>
                        <div class="cal-month-grid" id="calendar-grid"></div>
                    </div>
                </div>
                
                <div class="card" id="dash-card-events">
                    <h3>Lembretes & Próximos Eventos</h3>
                    <div id="home-agenda-widget" style="margin-top:20px; max-height: 300px; overflow-y: auto;">
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 150px; color: var(--text-muted); text-align: center;">
                            <i class="far fa-calendar-check" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.3;"></i>
                            <small>Carregando eventos...</small>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="tab-agenda" class="tab-content">
            <header>
                <h1>Agenda Enterprise</h1>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-wa" onclick="msgManager.openModal()"><i class="fab fa-whatsapp"></i> Central WhatsApp</button>
                    <button class="btn btn-outline" onclick="agendaManager.openSettings()"><i class="fas fa-sliders-h"></i> Configurar Tipos</button>
                    <button class="btn btn-primary" onclick="agendaManager.openModal()"><i class="fas fa-plus"></i> Novo Agendamento</button>
                </div>
            </header>
            
            <div class="agenda-layout">
                <div class="agenda-sidebar">
                    <div style="border-bottom:1px solid #e2e8f0; padding-bottom:15px; margin-bottom:15px;">
                        <h4 style="margin-bottom:10px; color:#334155;">Filtros de Visualização</h4>
                        <div style="display:flex; flex-direction:column; gap:8px;">
                            <label style="font-size:0.8rem; display:flex; align-items:center; gap:8px;">
                                <input type="checkbox" checked onchange="agendaManager.render()"> Exibir Cancelados
                            </label>
                            <label style="font-size:0.8rem; display:flex; align-items:center; gap:8px;">
                                <input type="checkbox" checked onchange="agendaManager.render()"> Apenas Visitas Externas
                            </label>
                        </div>
                    </div>
                    
                    <h4 style="margin-bottom:15px; color:#334155;">Próximos 7 Dias</h4>
                    <div id="agenda-sidebar-list"></div>
                </div>

                <div class="agenda-main">
                    <div class="cal-controls">
                        <h3 id="agenda-month-year">Janeiro 2024</h3>
                        <div class="cal-btn-group">
                            <button onclick="agendaManager.changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                            <button onclick="agendaManager.changeMonth(0)">Hoje</button>
                            <button onclick="agendaManager.changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                     <div class="cal-day-header-row" style="display: grid; grid-template-columns: repeat(7, 1fr); text-align: center;">
                             <div class="cal-day-header">Dom</div>
                             <div class="cal-day-header">Seg</div>
                             <div class="cal-day-header">Ter</div>
                             <div class="cal-day-header">Qua</div>
                             <div class="cal-day-header">Qui</div>
                             <div class="cal-day-header">Sex</div>
                             <div class="cal-day-header">Sab</div>
                        </div>
                    <div class="cal-month-grid" id="agenda-grid" style="flex:1;"></div>
                </div>
            </div>
        </section>

        <section id="tab-contacts" class="tab-content">
            <header>
                <h1>Contatos 360º</h1>
                <button class="btn btn-primary" onclick="contactManager.openModal()"><i class="fas fa-plus"></i> Novo Cadastro</button>
            </header>

            <div class="card" style="margin-bottom: 20px;">
                <div class="form-grid" style="margin-top: 0; display: flex; gap: 10px;">
                    <input type="text" id="searchContact" placeholder="Buscar por nome, email ou telefone..." onkeyup="contactManager.search()" style="flex:1; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px;">
                    <select id="filterType" onchange="contactManager.search()" style="padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px;">
                        <option value="">Todos os Tipos</option>
                        <option value="Cliente">Cliente</option>
                        <option value="Prospect">Prospect</option>
                        <option value="Lead">Lead</option>
                        <option value="Fornecedor">Fornecedor</option>
                    </select>
                </div>
            </div>

            <div class="data-table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Tipo</th>
                            <th>Contato</th>
                            <th>Status (Funil)</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="contacts-list"></tbody>
                </table>
            </div>
        </section>

        <section id="tab-management" class="tab-content">
            <header>
                <h1>Gestão & Estratégia</h1>
                <p style="color: var(--text-muted);">Controle total de projetos, financeiro e estoque</p>
            </header>
            
            <div class="mgmt-nav">
                <button class="active" onclick="mgmt.switch('albums')"><i class="fas fa-project-diagram"></i> Projetos & Workflow</button>
                <button onclick="financeManager.openDashboard()"><i class="fas fa-chart-line"></i> Financeiro PRO</button>
                <button onclick="mgmt.switch('stock')"><i class="fas fa-boxes"></i> Estoque</button>
                <button onclick="mgmt.switch('opps')"><i class="fas fa-funnel-dollar"></i> Oportunidades</button>
                <button onclick="mgmt.switch('dre')"><i class="fas fa-balance-scale"></i> DRE Contábil</button>
                <button onclick="mgmt.switch('reports')"><i class="fas fa-chart-pie"></i> Relatórios</button>
                <button onclick="mgmt.switch('quotes')"><i class="fas fa-file-invoice-dollar"></i> Orçamentos Premium</button>
                <button onclick="mgmt.switch('company')"><i class="fas fa-building"></i> Dados Empresa</button>
            </div>
            
            <div id="mgmt-albums" class="mgmt-section active">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center;">
                    <div>
                        <h3>Acompanhamento de Projetos</h3>
                        <p style="font-size: 0.8rem; color: #64748b;">Gerencie etapas, prazos e entregas.</p>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-outline btn-sm" onclick="albumManager.openConfig()"><i class="fas fa-cogs"></i> Configurar Workflows</button>
                        <button class="btn btn-primary" onclick="albumManager.openModal()"><i class="fas fa-plus"></i> Novo Projeto</button>
                    </div>
                </div>
                <div id="albums-container"></div>
            </div>

            <div id="mgmt-stock" class="mgmt-section">
                <div class="stock-kpi">
                    <div class="stock-kpi-card">
                        <div>
                            <div class="label">Total de Produtos</div>
                            <div class="val" id="stk-total-count">0</div>
                        </div>
                        <i class="fas fa-box" style="color: var(--primary-color); opacity: 0.5;"></i>
                    </div>
                    <div class="stock-kpi-card">
                        <div>
                            <div class="label">Valuation (Custo)</div>
                            <div class="val" id="stk-valuation" style="color: var(--success);">R$ 0,00</div>
                        </div>
                        <i class="fas fa-dollar-sign" style="color: var(--success); opacity: 0.5;"></i>
                    </div>
                    <div class="stock-kpi-card">
                        <div>
                            <div class="label">Baixo Estoque</div>
                            <div class="val" id="stk-low-alert" style="color: var(--danger);">0</div>
                        </div>
                        <i class="fas fa-exclamation-triangle" style="color: var(--danger); opacity: 0.5;"></i>
                    </div>
                </div>

                <div class="card">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap:10px;">
                        <div style="display: flex; gap: 10px; flex: 1;">
                            <input type="text" id="stock-search" placeholder="Buscar produto..." style="padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; flex: 1;" onkeyup="stockManager.load()">
                            <button class="btn btn-outline" onclick="stockManager.load()"><i class="fas fa-search"></i></button>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-outline" onclick="stockManager.openMovementModal()"><i class="fas fa-exchange-alt"></i> Movimentação</button>
                            <button class="btn btn-primary" onclick="stockManager.openProductModal()"><i class="fas fa-plus"></i> Novo Produto</button>
                        </div>
                    </div>

                    <div class="data-table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>SKU / Nome</th>
                                    <th>Categoria</th>
                                    <th>Estoque Atual</th>
                                    <th>Preço Venda</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="stock-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="mgmt-opps" class="mgmt-section">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                    <h3>Funil de Vendas</h3>
                    <button class="btn btn-primary btn-sm" onclick="oppManager.openModal()"><i class="fas fa-plus"></i> Nova Oportunidade</button>
                </div>
                <div class="data-table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Título</th>
                                <th>Cliente</th>
                                <th>Valor Est.</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="opps-list">
                            <tr><td colspan="5" style="text-align:center; padding:20px; color:#64748b;">Nenhuma oportunidade registrada.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="mgmt-dre" class="mgmt-section">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                        <h3>Demonstrativo do Resultado do Exercício (DRE)</h3>
                        <div style="font-size:0.9rem; color:#64748b;">Simulação Contábil (Baseado no Financeiro)</div>
                    </div>
                    <table class="dre-table">
                        <tr><td>(+) RECEITA OPERACIONAL BRUTA</td><td class="text-right val-pos" id="dre-receita">R$ 0,00</td></tr>
                        <tr><td class="dre-indent">(-) Deduções / Impostos (Simulado 6%)</td><td class="text-right val-neg" id="dre-impostos">(R$ 0,00)</td></tr>
                        <tr class="total-row"><td>(=) RECEITA LÍQUIDA</td><td class="text-right" id="dre-rec-liq">R$ 0,00</td></tr>
                        <tr><td class="dre-indent">(-) Custos Operacionais</td><td class="text-right val-neg" id="dre-custos">(R$ 0,00)</td></tr>
                        <tr class="total-row"><td>(=) LUCRO BRUTO</td><td class="text-right val-pos" id="dre-lucro-bruto">R$ 0,00</td></tr>
                        <tr><td class="dre-indent">(-) Despesas Administrativas/Fixas</td><td class="text-right val-neg" id="dre-despesas">(R$ 0,00)</td></tr>
                        <tr class="total-row" style="background: #ecfdf5; font-size:1.1rem;"><td>(=) RESULTADO LÍQUIDO (LUCRO/PREJUÍZO)</td><td class="text-right val-pos" id="dre-resultado">R$ 0,00</td></tr>
                    </table>
                </div>
            </div>

            <div id="mgmt-reports" class="mgmt-section">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <div>
                        <h3>Central de Inteligência (BI)</h3>
                        <p style="font-size:0.85rem; color:#64748b;">Análise em tempo real dos seus dados.</p>
                    </div>
                    <button class="btn btn-primary" onclick="reportManager.openBuilder()"><i class="fas fa-plus"></i> Criar Relatório Personalizado</button>
                </div>
                <div class="report-grid-premium">
                    <div class="kpi-report-card">
                        <div class="kpi-head"><h4>Fluxo de Caixa (Ult. 6 Meses)</h4><i class="fas fa-chart-line"></i></div>
                        <div class="chart-container" id="chart-revenue"></div>
                    </div>
                    <div class="kpi-report-card">
                        <div class="kpi-head"><h4>Origem de Clientes</h4><i class="fas fa-users"></i></div>
                        <div class="chart-container" id="chart-clients"></div>
                    </div>
                    <div class="kpi-report-card">
                        <div class="kpi-head"><h4>Status de Projetos</h4><i class="fas fa-tasks"></i></div>
                        <div class="chart-container" id="chart-projects"></div>
                    </div>
                </div>
                <h4 class="section-title" style="margin-top:30px;">Relatórios Personalizados Salvos</h4>
                <div id="saved-reports-container" class="grid-cards" style="grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));">
                    <div class="report-builder-box" onclick="reportManager.openBuilder()">
                        <i class="fas fa-plus-circle"></i>
                        <span>Novo Relatório</span>
                        <small>Customizar filtros e dados</small>
                    </div>
                </div>
            </div>

            <div id="mgmt-quotes" class="mgmt-section">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                    <h3>Construtor de Propostas Premium</h3>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-outline" onclick="document.getElementById('quotes-history').style.display='block'; document.getElementById('quote-builder-area').style.display='none';"><i class="fas fa-history"></i> Histórico</button>
                        <button class="btn btn-primary" onclick="quoteManager.newQuote()"><i class="fas fa-file-alt"></i> Novo Orçamento</button>
                    </div>
                </div>
                
                <div id="quotes-history" class="data-table-container" style="display:none;">
                     <table>
                        <thead>
                            <tr><th>ID</th><th>Cliente</th><th>Data</th><th>Total</th><th>Ações</th></tr>
                        </thead>
                        <tbody id="quote-history-body">
                            <tr><td colspan="5" style="text-align:center; padding:20px; color:#64748b;">Nenhum orçamento gerado.</td></tr>
                        </tbody>
                     </table>
                </div>

                <div id="quote-builder-area">
                    <div class="quote-builder-container">
                        <div class="quote-sidebar">
                            <div class="q-config-group">
                                <div class="q-config-title"><i class="fas fa-palette"></i> Identidade Visual</div>
                                <div class="form-group">
                                    <label>Cor de Destaque</label>
                                    <div class="color-picker-wrapper">
                                        <input type="color" id="q-accent-color" value="#2563eb" onchange="quoteManager.updateSettings()">
                                        <small style="color:#64748b;">Aplica em bordas e títulos</small>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Logotipo da Empresa</label>
                                    <div class="upload-box">
                                        <i class="fas fa-cloud-upload-alt"></i> Importar Logo
                                        <input type="file" accept="image/*" onchange="quoteManager.handleLogoUpload(this)">
                                    </div>
                                    <img id="q-logo-preview" class="upload-preview" style="display:none;">
                                </div>
                                <div class="form-group">
                                    <label>Fundo do Papel (Folder Base)</label>
                                    <div class="upload-box">
                                        <i class="fas fa-image"></i> Importar Arte de Fundo
                                        <input type="file" accept="image/*" onchange="quoteManager.handleBgUpload(this)">
                                    </div>
                                    <div style="margin-top:5px; display:flex; justify-content:space-between;">
                                        <small style="color:#64748b;">Transparência:</small>
                                        <input type="range" id="q-bg-opacity" min="0" max="1" step="0.1" value="1" onchange="quoteManager.updateSettings()">
                                    </div>
                                </div>
                            </div>

                            <div class="q-config-group">
                                <div class="q-config-title"><i class="fas fa-layer-group"></i> Layout</div>
                                <div class="layout-selector">
                                    <div class="layout-opt active" onclick="quoteManager.setLayout('modern')" id="layout-btn-modern">Moderno</div>
                                    <div class="layout-opt" onclick="quoteManager.setLayout('enterprise')" id="layout-btn-enterprise">Enterprise</div>
                                </div>
                            </div>

                            <div class="q-config-group">
                                <div class="q-config-title"><i class="fas fa-user-tie"></i> Dados do Cliente</div>
                                <div class="form-group">
                                    <input type="text" id="q-client-name" placeholder="Nome do Cliente" oninput="quoteManager.updatePreview()">
                                </div>
                                <div class="form-group">
                                    <input type="text" id="q-client-doc" placeholder="CPF/CNPJ (Opcional)" oninput="quoteManager.updatePreview()">
                                </div>
                            </div>

                            <div class="q-config-group">
                                <div class="q-config-title"><i class="fas fa-list"></i> Itens do Orçamento</div>
                                <button class="btn btn-sm btn-outline" style="width:100%; margin-bottom:10px;" onclick="quoteManager.addItem()"><i class="fas fa-plus"></i> Adicionar Item</button>
                                <div id="q-items-list-sidebar" style="font-size:0.8rem; color:#64748b;">
                                    </div>
                            </div>

                            <button class="btn btn-success" style="width:100%;" onclick="quoteManager.printPdf()"><i class="fas fa-print"></i> Imprimir / PDF</button>
                        </div>

                        <div class="quote-preview-container">
                            <div id="paper-preview" class="quote-paper layout-modern">
                                </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="mgmt-company" class="mgmt-section">
                <div class="card">
                    <h3>Dados da Organização</h3>
                    <p style="color:var(--text-muted); margin-bottom:20px;">Esses dados aparecerão no cabeçalho dos orçamentos e relatórios.</p>
                    <div class="form-grid">
                        <div class="form-group form-full">
                            <label>Razão Social / Nome Fantasia</label>
                            <input type="text" id="conf-company-name" value="RC Sistemas" oninput="quoteManager.updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>CNPJ</label>
                            <input type="text" id="conf-company-cnpj" value="00.000.000/0001-00" oninput="quoteManager.updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>Telefone / Contato</label>
                            <input type="text" id="conf-company-phone" value="(21) 99999-9999" oninput="quoteManager.updatePreview()">
                        </div>
                        <div class="form-group form-full">
                            <label>Endereço Completo</label>
                            <input type="text" id="conf-company-addr" value="Av. Comercial, 1000 - Centro, RJ" oninput="quoteManager.updatePreview()">
                        </div>
                        <div class="form-group form-full">
                             <button class="btn btn-primary"><i class="fas fa-save"></i> Salvar Configurações</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="tab-config" class="tab-content">
            <header>
                <h1>Configurações Globais</h1>
                <p style="color:var(--text-muted)">Personalização visual e comportamento do sistema</p>
            </header>

            <div class="card">
                <h3>Aparência do Sistema</h3>

                <div class="form-grid">
                    <div class="form-group">
                        <label>Cor Primária</label>
                        <input type="color" id="cfg-primary">
                    </div>

                    <div class="form-group">
                        <label>Cor Secundária</label>
                        <input type="color" id="cfg-secondary">
                    </div>

                    <div class="form-group">
                        <label>Tamanho da Fonte</label>
                        <select id="cfg-font">
                            <option value="14">Pequena</option>
                            <option value="16">Normal</option>
                            <option value="18">Grande</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Modo Escuro</label>
                        <select id="cfg-theme">
                            <option value="light">Claro</option>
                            <option value="dark">Escuro</option>
                        </select>
                    </div>

                    <div class="form-group form-full">
                        <button class="btn btn-primary" onclick="globalConfig.save()">
                            <i class="fas fa-save"></i> Salvar Personalização
                        </button>
                    </div>
              </div>
            </div>

            <div class="card" style="margin-top: 20px; border-top: 4px solid var(--warning);">
                <h3 style="display:flex; align-items:center; gap:10px;"><i class="fas fa-database"></i> Backup & Restauração de Dados</h3>
                <p style="color:var(--text-muted); margin-bottom:15px; font-size: 0.9rem;">
                    Exporte todos os dados do sistema (Clientes, Financeiro, Estoque, etc.) para um arquivo JSON seguro.
                    Utilize o botão "Restaurar" para carregar um arquivo previamente salvo.
                </p>
                <div style="display:flex; gap:15px; flex-wrap:wrap;">
                    <button class="btn btn-primary" onclick="backupManager.exportData()">
                        <i class="fas fa-download"></i> Baixar Backup Completo
                    </button>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <button class="btn btn-outline" onclick="document.getElementById('restore-file-input').click()">
                            <i class="fas fa-upload"></i> Restaurar Arquivo
                        </button>
                        <input type="file" id="restore-file-input" style="display:none" accept=".json" onchange="backupManager.importData(this)">
                    </div>
                </div>
                <p id="backup-status" style="margin-top:10px; font-size:0.8rem; color:var(--text-muted);"></p>
            </div>
                </div>
            </div>
        </section>

    </main>

    <div id="custom-report-modal" class="modal-overlay">
        <div class="modal modal-lg">
            <div class="modal-header-premium">
                <h3>Construtor de Relatório</h3>
                <button class="btn btn-sm btn-outline" onclick="document.getElementById('custom-report-modal').style.display='none'">Fechar</button>
            </div>
            <div class="modal-body-content">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nome do Relatório</label>
                        <input type="text" id="rep-name" placeholder="Ex: Vendas de Janeiro">
                    </div>
                    <div class="form-group">
                        <label>Tipo de Dados</label>
                        <select id="rep-source">
                            <option value="financial">Financeiro (Receitas/Despesas)</option>
                            <option value="contacts">Contatos (Clientes/Leads)</option>
                            <option value="stock">Estoque (Inventário)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Filtrar Data Início</label>
                        <input type="date" id="rep-start">
                    </div>
                    <div class="form-group">
                        <label>Filtrar Data Fim</label>
                        <input type="date" id="rep-end">
                    </div>
                </div>
                <button class="btn btn-primary" style="width:100%; margin-bottom:20px;" onclick="reportManager.generatePreview()">Gerar Pré-visualização</button>
                <div id="rep-preview-area" class="data-table-container" style="display:none; margin-bottom:20px; max-height:300px; overflow-y:auto;">
                    <table id="rep-preview-table"></table>
                </div>
                <div style="text-align:right;">
                    <button class="btn btn-success" onclick="reportManager.saveReport()"><i class="fas fa-save"></i> Salvar nos Relatórios</button>
                </div>
            </div>
        </div>
    </div>

    <div id="financial-dashboard-modal" class="modal-overlay">
        <div class="modal modal-xl">
            <div class="modal-header-premium">
                <div>
                    <h3 style="font-size: 1.2rem; color: #1e293b;">Financeiro Enterprise Pro</h3>
                    <p style="font-size: 0.85rem; color: #64748b;">Gestão completa de Contas a Pagar e Receber (BI)</p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="financeManager.openForm()"><i class="fas fa-plus"></i> Novo Lançamento</button>
                    <button class="btn btn-sm btn-outline" onclick="document.getElementById('financial-dashboard-modal').style.display='none'">Fechar</button>
                </div>
            </div>
            <div class="modal-body-content" style="background: #f8fafc;">
                <div class="fin-bi-grid">
                    <div class="fin-card income">
                        <div class="fin-card-title">Receitas Realizadas</div>
                        <div class="fin-card-value" id="bi-income">R$ 0,00</div>
                        <div class="fin-card-trend"><i class="fas fa-arrow-up" style="color:#166534"></i> Entradas do período</div>
                        <i class="fas fa-coins fin-card-bg-icon"></i>
                        <div class="fin-progress-container"><div class="fin-progress-bar" style="background: #10b981; width: 0%" id="bi-bar-income"></div></div>
                    </div>
                    <div class="fin-card expense">
                        <div class="fin-card-title">Despesas Pagas</div>
                        <div class="fin-card-value" id="bi-expense">R$ 0,00</div>
                        <div class="fin-card-trend"><i class="fas fa-arrow-down" style="color:#ef4444"></i> Saídas do período</div>
                        <i class="fas fa-file-invoice-dollar fin-card-bg-icon"></i>
                         <div class="fin-progress-container"><div class="fin-progress-bar" style="background: #ef4444; width: 0%" id="bi-bar-expense"></div></div>
                    </div>
                    <div class="fin-card balance">
                        <div class="fin-card-title">Saldo Líquido</div>
                        <div class="fin-card-value" id="bi-balance">R$ 0,00</div>
                        <div class="fin-card-trend" id="bi-balance-txt">Resultado Operacional</div>
                        <i class="fas fa-scale-balanced fin-card-bg-icon"></i>
                         <div class="fin-progress-container"><div class="fin-progress-bar" style="background: #3b82f6; width: 0%" id="bi-bar-balance"></div></div>
                    </div>
                </div>
                <div class="fin-filter-bar">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <label style="font-size:0.85rem; font-weight:600; color:#475569;">Período:</label>
                        <input type="month" id="fin-filter-month" class="fin-select" onchange="financeManager.render()">
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <label style="font-size:0.85rem; font-weight:600; color:#475569;">Tipo:</label>
                        <select id="fin-filter-type" class="fin-select" onchange="financeManager.render()">
                            <option value="all">Todas</option>
                            <option value="in">Entradas</option>
                            <option value="out">Saídas</option>
                        </select>
                    </div>
                    <div style="flex:1;"></div>
                    <button class="btn btn-sm btn-outline" onclick="financeManager.render()"><i class="fas fa-sync-alt"></i> Atualizar</button>
                </div>
                <div class="data-table-container">
                    <table>
                        <thead>
                            <tr><th style="width: 50px;">Tipo</th><th>Descrição</th><th>Categoria</th><th>Vencimento</th><th>Valor</th><th>Status</th><th style="text-align: right;">Ações</th></tr>
                        </thead>
                        <tbody id="fin-list-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="financial-form-modal" class="modal-overlay" style="z-index: 1100;">
        <div class="modal modal-sm">
            <div class="modal-header-premium">
                <h3>Lançamento Financeiro</h3>
                <button class="btn btn-sm btn-outline" onclick="document.getElementById('financial-form-modal').style.display='none'">X</button>
            </div>
            <div class="modal-body-content">
                <form id="fin-form" onsubmit="financeManager.save(event)">
                    <div class="form-group">
                        <label>Tipo de Movimento</label>
                        <select id="fin-type" required onchange="financeManager.updateCategories()">
                            <option value="in">Receita / Entrada (+)</option>
                            <option value="out">Despesa / Saída (-)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Descrição</label>
                        <input type="text" id="fin-desc" placeholder="Ex: Pagamento Cliente X ou Conta Luz" required>
                    </div>
                     <div class="form-group">
                        <label>Categoria</label>
                        <select id="fin-cat" required></select>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Valor (R$)</label>
                            <input type="number" step="0.01" id="fin-value" class="input-money" required>
                        </div>
                        <div class="form-group">
                            <label>Vencimento / Data</label>
                            <input type="date" id="fin-date" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Status Inicial</label>
                         <select id="fin-status">
                            <option value="paid">Pago / Recebido</option>
                            <option value="pending">Pendente / A Pagar</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Salvar Lançamento</button>
                </form>
            </div>
        </div>
    </div>

    <div id="dashboard-customizer-modal" class="modal-overlay">
        <div class="modal modal-lg" style="max-width: 800px; height: auto; max-height: 80vh;">
            <div class="modal-header-premium">
                <div>
                    <h3 style="font-size: 1.2rem; color: #1e293b;">Personalizar Dashboard</h3>
                    <p style="font-size: 0.85rem; color: #64748b;">Selecione os widgets que deseja exibir na tela inicial</p>
                </div>
                <button class="btn btn-sm btn-outline" onclick="dashboardManager.closeModal()">Fechar</button>
            </div>
            <div class="modal-body-content" style="background: #f8fafc;">
                <div class="customizer-grid" id="customizer-grid-container"></div>
                <div style="margin-top: 30px; text-align: right; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                    <button class="btn btn-outline" style="margin-right: 10px;" onclick="dashboardManager.resetDefaults()">Restaurar Padrão</button>
                    <button class="btn btn-primary" onclick="dashboardManager.saveSettings()">Salvar Alterações</button>
                </div>
            </div>
        </div>
    </div>

    <div id="event-modal" class="modal-overlay">
        <div class="modal modal-sm" style="max-width: 600px;">
            <div class="modal-header-premium">
                <h3 id="evt-modal-title">Novo Agendamento</h3>
                <button class="btn btn-sm btn-outline" onclick="document.getElementById('event-modal').style.display='none'">X</button>
            </div>
            <div class="modal-body-content">
                <form id="event-form" onsubmit="agendaManager.saveEvent(event)">
                    <input type="hidden" id="evt-id">
                    <div class="form-group">
                        <label>Título do Evento</label>
                        <input type="text" id="evt-title" required placeholder="Ex: Reunião de Alinhamento">
                    </div>
                    <div class="form-group">
                        <label>Cliente</label>
                        <select id="evt-client" onchange="agendaManager.populateClientData()">
                            <option value="">Selecione um cliente...</option>
                        </select>
                    </div>
                    <div class="form-group">
                         <label>Endereço da Visita/Evento</label>
                         <input type="text" id="evt-address" placeholder="Rua, Número, Bairro...">
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Tipo Agendamento</label>
                            <select id="evt-type" required></select>
                        </div>
                        <div class="form-group">
                             <label>Tipo de Visita</label>
                             <select id="evt-visit-type" required></select>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Data</label>
                            <input type="date" id="evt-date" required>
                        </div>
                        <div class="form-group">
                            <label>Hora</label>
                            <input type="time" id="evt-time" required>
                        </div>
                    </div>
                    <div class="fin-integration-box">
                        <div class="form-tri">
                            <div class="form-group">
                                <label style="color:#2563eb;">Valor Total</label>
                                <input type="number" id="evt-val-total" class="input-money" step="0.01" placeholder="0.00" oninput="agendaManager.calcFinancials()" style="background:white; border-color:#bfdbfe;">
                            </div>
                            <div class="form-group">
                                <label style="color:#166534;">Sinal / Entrada <i class="fas fa-arrow-down" style="font-size:0.7rem;"></i></label>
                                <input type="number" id="evt-val-signal" class="input-money" step="0.01" placeholder="0.00" oninput="agendaManager.calcFinancials()" style="background:white; border-color:#bbf7d0;">
                            </div>
                            <div class="form-group">
                                <label style="color:#b91c1c;">Restante (Auto)</label>
                                <input type="number" id="evt-val-rest" class="input-money" readonly style="background:#fef2f2; color: #b91c1c; border-color:#fecaca;">
                            </div>
                        </div>
                        <small style="display:block; margin-top:5px; color:#64748b; font-size:0.75rem;">
                            <i class="fas fa-info-circle"></i> O sistema lançará o <strong>Sinal</strong> como Receita Hoje e o <strong>Restante</strong> para a Data do Evento no Financeiro Pro.
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Observações</label>
                        <textarea id="evt-notes" rows="3"></textarea>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                         <button type="button" id="btn-delete-event" class="btn btn-danger-outline" style="display:none;" onclick="agendaManager.deleteEvent()">Excluir</button>
                         <button type="submit" class="btn btn-primary" style="flex: 1;"><i class="fas fa-save"></i> Salvar na Agenda</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="whatsapp-modal" class="modal-overlay">
        <div class="modal modal-lg">
             <div class="modal-header-premium" style="padding: 15px 20px; background: var(--wa-header);">
                <div style="display:flex; align-items:center; gap:10px;">
                    <i class="fab fa-whatsapp" style="font-size: 1.5rem; color: #25D366;"></i>
                    <h3 style="margin:0; font-size:1rem;">Central WhatsApp Integrada</h3>
                </div>
                <button class="btn btn-sm btn-outline" onclick="document.getElementById('whatsapp-modal').style.display='none'">Fechar</button>
            </div>
            
            <div class="wa-layout">
                <div class="wa-sidebar">
                    <div class="wa-header">
                        <div class="wa-avatar"><i class="fas fa-user"></i></div>
                        <div style="display:flex; gap:15px; color: #54656f;">
                            <i class="fas fa-circle-notch"></i>
                            <i class="fas fa-comment-alt"></i>
                            <i class="fas fa-ellipsis-v"></i>
                        </div>
                    </div>
                    <div class="wa-search-box">
                         <div style="display:flex; gap:10px; margin-bottom:10px; justify-content:center;">
                            <button class="btn btn-sm btn-outline active" id="btn-wa-view-contacts" onclick="msgManager.switchView('contacts')">Contatos</button>
                            <button class="btn btn-sm btn-outline" id="btn-wa-view-templates" onclick="msgManager.switchView('templates')">Modelos</button>
                         </div>
                         <input type="text" class="wa-search-input" id="wa-search-input" placeholder="Pesquisar..." onkeyup="msgManager.search()">
                    </div>
                    <div class="wa-list" id="wa-list-container"></div>
                </div>

                <div class="wa-chat-area" id="wa-main-area">
                    <div id="wa-view-chat" style="display:flex; flex-direction:column; height:100%;">
                        <div class="wa-chat-header">
                            <div class="wa-avatar" id="wa-chat-avatar"><i class="fas fa-user"></i></div>
                            <div style="flex:1;">
                                <h4 id="wa-chat-name" style="font-size:0.95rem; font-weight:500;">Selecione um contato</h4>
                                <small id="wa-chat-phone" style="color: #667781;">-</small>
                            </div>
                            <div style="color: #54656f; font-size:1.2rem;">
                                <i class="fas fa-search"></i>
                            </div>
                        </div>
                        <div class="wa-chat-body" id="wa-chat-body">
                             <div style="align-self:center; background:#ffebb6; padding:5px 10px; border-radius:8px; font-size:0.75rem; color:#555; margin-bottom:20px; text-align:center; box-shadow: 0 1px 1px rgba(0,0,0,0.1);">
                                 <i class="fas fa-lock" style="font-size:0.7rem; margin-right:4px;"></i> As mensagens são enviadas via API oficial do seu dispositivo.
                             </div>
                             <div class="wa-msg sent">
                                Selecione um contato na esquerda para iniciar a conversa.
                                <span class="wa-msg-meta">10:00 <i class="fas fa-check-double" style="color:#53bdeb;"></i></span>
                             </div>
                        </div>
                        <div class="wa-footer">
                            <i class="far fa-smile" style="color:#54656f; font-size:1.5rem; cursor:pointer;"></i>
                            <input type="text" class="wa-input" id="wa-input-msg" placeholder="Digite uma mensagem" onkeyup="msgManager.checkInput()">
                            <button class="wa-btn-send" id="wa-btn-send" onclick="msgManager.sendMessage()"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>

                    <div id="wa-view-new-template" style="display:none; height:100%; flex-direction:column; background: #fff;">
                        <div style="padding: 20px; border-bottom: 1px solid #e2e8f0; background: #f8fafc;">
                            <h3 style="margin-bottom: 5px; color: #1e293b;" id="tpl-editor-title">Novo Modelo de Mensagem</h3>
                            <p style="font-size: 0.8rem; color: #64748b;">As variáveis buscam automaticamente dados do <strong>próximo evento</strong> do cliente.</p>
                        </div>
                        <div style="padding: 20px; flex: 1; overflow-y: auto;">
                            <input type="hidden" id="tpl-edit-id">
                            <div class="form-group">
                                <label>Título do Modelo (Interno)</label>
                                <input type="text" id="tpl-new-title" placeholder="Ex: Cobrança Suave">
                            </div>
                            <div class="form-group">
                                <label style="display:flex; justify-content:space-between;">
                                    <span>Conteúdo da Mensagem</span>
                                    <span style="font-size:0.7rem; color:var(--primary-color);">Clique nas variáveis abaixo para inserir</span>
                                </label>
                                <div class="var-list-container">
                                    <span class="var-list-title"><i class="fas fa-user-tag"></i> Dados Básicos:</span>
                                    <div class="var-chip" onclick="msgManager.insertVar('Nome')"><i class="fas fa-user"></i> [Nome]</div>
                                    <div class="var-chip" onclick="msgManager.insertVar('Empresa')"><i class="fas fa-building"></i> [Empresa]</div>
                                    <div class="var-chip" onclick="msgManager.insertVar('Telefone')"><i class="fas fa-phone"></i> [Telefone]</div>
                                </div>
                                <div class="var-list-container">
                                    <span class="var-list-title"><i class="far fa-calendar-alt"></i> Próximo Evento:</span>
                                    <div class="var-chip event" onclick="msgManager.insertVar('Data')"><i class="far fa-calendar"></i> [Data]</div>
                                    <div class="var-chip event" onclick="msgManager.insertVar('Hora')"><i class="far fa-clock"></i> [Hora]</div>
                                    <div class="var-chip event" onclick="msgManager.insertVar('Endereco')"><i class="fas fa-map-marker-alt"></i> [Endereco]</div>
                                </div>
                                <div class="var-list-container">
                                    <span class="var-list-title"><i class="fas fa-dollar-sign"></i> Financeiro (Evento):</span>
                                    <div class="var-chip finance" onclick="msgManager.insertVar('Sinal')"><i class="fas fa-hand-holding-usd"></i> [Sinal]</div>
                                    <div class="var-chip finance" onclick="msgManager.insertVar('Restante')"><i class="fas fa-money-bill-wave"></i> [Restante]</div>
                                    <div class="var-chip finance" onclick="msgManager.insertVar('Total')"><i class="fas fa-calculator"></i> [Total]</div>
                                </div>
                                <textarea id="tpl-new-text" rows="8" placeholder="Olá [Nome], tudo bem?..." style="font-family:inherit; line-height:1.5;"></textarea>
                            </div>
                        </div>
                        <div style="padding: 20px; border-top: 1px solid #e2e8f0; background: #f8fafc; text-align: right; display: flex; justify-content: flex-end; gap: 10px;">
                            <button class="btn btn-outline" onclick="msgManager.cancelTemplateCreation()">Cancelar</button>
                            <button class="btn btn-primary" onclick="msgManager.saveNewTemplate()">Salvar Modelo</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="contact-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header-premium">
                <div class="profile-header-info">
                    <div class="avatar-circle" id="header-avatar"><i class="fas fa-user"></i></div>
                    <div>
                        <h2 id="header-name" style="font-size: 1.4rem; color: #1e293b; margin-bottom: 2px;">Novo Contato</h2>
                        <span id="header-id" style="font-size: 0.8rem; color: #64748b; background: #f1f5f9; padding: 2px 8px; border-radius: 4px;">ID: #NOVO</span>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-outline" onclick="contactManager.closeModal()">Cancelar</button>
                    <button class="btn btn-primary" onclick="document.getElementById('main-submit-btn').click()"><i class="fas fa-save"></i> Salvar Ficha</button>
                </div>
            </div>
            <div class="modal-tabs-nav">
                <button class="modal-tab-btn active" onclick="contactManager.switchTab('basic')"><i class="far fa-id-card"></i> Dados Principais</button>
                <button class="modal-tab-btn" onclick="contactManager.switchTab('address')"><i class="fas fa-map-marker-alt"></i> Endereço</button>
                <button class="modal-tab-btn" onclick="contactManager.switchTab('profile')"><i class="fas fa-network-wired"></i> Social & Mídia</button>
                <button class="modal-tab-btn" onclick="contactManager.switchTab('history')"><i class="fas fa-history"></i> Histórico & Timeline</button>
            </div>
            <div class="modal-body-content">
                <form id="contact-form" onsubmit="contactManager.save(event)">
                    <input type="hidden" id="c-id">
                    <button type="submit" id="main-submit-btn" style="display:none;"></button>

                    <div id="modal-tab-basic" class="inner-tab active">
                        <div class="section-title"><i class="fas fa-info-circle"></i> Informações Cadastrais</div>
                        <div class="form-grid">
                            <div class="form-group form-full">
                                <label>Nome Completo / Razão Social</label>
                                <input type="text" id="c-name" required oninput="document.getElementById('header-name').innerText = this.value || 'Novo Contato'">
                            </div>
                            <div class="form-group"><label>CPF / CNPJ</label><input type="text" id="c-cpf"></div>
                            <div class="form-group"><label>Cargo / Função</label><input type="text" id="c-job"></div>
                            <div class="form-group">
                                <label>Tipo de Cadastro</label>
                                <select id="c-type" required><option value="Cliente">Cliente</option><option value="Prospect">Prospect</option><option value="Lead">Lead</option><option value="Fornecedor">Fornecedor</option><option value="Parceiro">Parceiro</option></select>
                            </div>
                            <div class="form-group">
                                <label>Status</label>
                                <select id="c-status"><option value="Ativo">Ativo</option><option value="Negociacao">Em Negociação</option><option value="Pendente">Pagamento Pendente</option><option value="Inativo">Inativo</option></select>
                            </div>
                            <div class="section-title form-full" style="margin-top: 20px;"><i class="fas fa-phone-alt"></i> Contato Direto</div>
                            <div class="form-group"><label>Celular / WhatsApp</label><input type="text" id="c-phone"></div>
                            <div class="form-group"><label>Email Principal</label><input type="email" id="c-email"></div>
                        </div>
                    </div>

                    <div id="modal-tab-address" class="inner-tab">
                        <div class="section-title"><i class="fas fa-map-signs"></i> Localização</div>
                        <div class="form-grid">
                            <div class="form-group"><label>CEP</label><input type="text" id="c-cep"></div>
                            <div class="form-group"><label>Cidade</label><input type="text" id="c-city"></div>
                            <div class="form-group form-full"><label>Logradouro</label><input type="text" id="c-address"></div>
                            <div class="form-group"><label>Número</label><input type="text" id="c-number"></div>
                            <div class="form-group"><label>Bairro</label><input type="text" id="c-district"></div>
                            <div class="form-group form-full"><label>Complemento</label><input type="text" id="c-complement"></div>
                        </div>
                    </div>

                    <div id="modal-tab-profile" class="inner-tab">
                        <div class="section-title"><i class="fas fa-share-alt"></i> Redes Sociais & Origem</div>
                        <div class="form-grid">
                            <div class="form-group"><label>Instagram</label><input type="text" id="c-insta"></div>
                            <div class="form-group"><label>LinkedIn / Facebook</label><input type="text" id="c-social2"></div>
                            <div class="form-group"><label>Data Nascimento/Fundação</label><input type="date" id="c-birth"></div>
                            <div class="form-group"><label>Origem</label><select id="c-source"><option value="Google">Google / Site</option><option value="Indicação">Indicação</option><option value="Instagram">Instagram</option><option value="Outro">Outro</option></select></div>
                            <div class="form-group form-full"><label>Bio / Notas</label><textarea id="c-notes" rows="3"></textarea></div>
                        </div>
                    </div>

                    <div id="modal-tab-history" class="inner-tab">
                        <div id="timeline-controls" style="background: #f8fafc; border: 1px solid #e2e8f0; padding: 15px; margin-bottom: 20px; border-radius: 8px;">
                            <h4 style="margin-bottom: 10px; font-size: 0.9rem;">Adicionar Interação</h4>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <select id="note-type" style="padding: 10px; border-radius: 6px; border: 1px solid #cbd5e1; width: 140px; background:white;">
                                    <option value="note">📝 Nota</option>
                                    <option value="call">📞 Ligação</option>
                                    <option value="whatsapp">💬 WhatsApp</option>
                                    <option value="meeting">🤝 Reunião</option>
                                    <option value="email">📧 Email</option>
                                </select>
                                <input type="text" id="new-note" placeholder="Descreva o que foi conversado..." style="flex: 1; min-width: 250px; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; outline: none;">
                                <button type="button" class="btn btn-primary btn-sm" onclick="contactManager.addTimeline()">Registrar</button>
                            </div>
                        </div>
                        <div class="timeline" id="c-timeline-display" style="max-height: 350px; overflow-y: auto;"></div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div id="album-modal" class="modal-overlay">
        <div class="modal modal-lg">
            <div class="modal-header-premium">
                <div>
                    <h3 style="font-size: 1.2rem; color: #1e293b;">Central de Projetos & Workflow</h3>
                    <p style="font-size: 0.85rem; color: #64748b;" id="alb-modal-subtitle">Gestão de Workflow</p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-outline btn-sm" onclick="document.getElementById('album-modal').style.display='none'">Fechar</button>
                    <button class="btn btn-primary btn-sm" onclick="albumManager.saveMainForm()"><i class="fas fa-save"></i> Salvar</button>
                </div>
            </div>
            <div class="modal-tabs-nav" id="alb-tabs-nav"></div>
            
            <div class="modal-body-content">
                <div id="alb-view-config" style="display:none; height:100%;">
                    <div class="workflow-setup-container">
                        <div class="ws-sidebar">
                            <button class="btn btn-primary btn-sm" onclick="albumManager.newType()" style="width:100%"><i class="fas fa-plus"></i> Novo Tipo de Projeto</button>
                            <div id="alb-types-list" style="overflow-y:auto; flex:1;"></div>
                        </div>
                        <div class="ws-content" id="alb-config-content">
                            <div style="text-align:center; padding-top:50px; color:#94a3b8;">
                                <i class="fas fa-tasks" style="font-size:3rem; margin-bottom:20px; opacity:0.3;"></i>
                                <p>Selecione um tipo de projeto à esquerda para editar suas fases.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="alb-view-project" style="display:none;">
                    <form id="album-form"> <input type="hidden" id="alb-id">
                        <div class="form-grid" style="margin-bottom:20px;">
                            <div class="form-group">
                                <label>Cliente</label>
                                <select id="alb-client-select" style="width:100%"></select>
                            </div>
                            <div class="form-group">
                                <label>Tipo de Projeto</label>
                                <select id="alb-type-select" onchange="albumManager.updateStagesPreview()"></select>
                            </div>
                             <div class="form-group form-full">
                                <label>Nome do Projeto</label>
                                <input type="text" id="alb-name" placeholder="Ex: Casamento Silva e Souza">
                            </div>
                        </div>
                        <div class="card" style="box-shadow:none; border:1px solid #e2e8f0; padding:0;">
                            <div style="padding:15px; background:#f8fafc; border-bottom:1px solid #e2e8f0;">
                                <h4 style="font-size:0.9rem; font-weight:600;">Linha do Tempo (Workflow)</h4>
                            </div>
                            <div style="padding:20px; background:white;">
                                <div class="prj-timeline" id="alb-timeline-preview"></div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="agenda-settings-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header-premium">
                <h3>Configurações de Agenda</h3>
                <button class="btn btn-sm btn-outline" onclick="document.getElementById('agenda-settings-modal').style.display='none'">X</button>
            </div>
            <div class="modal-tabs-nav">
                <button class="modal-tab-btn active" onclick="agendaManager.switchSettingsTab('types')">Tipos e Legendas</button>
                <button class="modal-tab-btn" onclick="agendaManager.switchSettingsTab('visits')">Tipos de Visita</button>
            </div>
            <div class="modal-body-content">
                <div id="set-tab-types" class="inner-tab active">
                    <div class="form-grid" style="align-items: end; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #f1f5f9;">
                        <div class="form-group">
                            <label>Novo Tipo / Legenda</label>
                            <input type="text" id="new-type-name" placeholder="Ex: Instalação">
                        </div>
                        <div class="form-group">
                            <label>Cor da Legenda</label>
                            <div class="color-picker-wrapper">
                                <input type="color" id="new-type-color" value="#2563eb">
                                <span style="font-size: 0.8rem; color: #64748b;">Escolha a cor</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" onclick="agendaManager.addType()">Adicionar</button>
                        </div>
                    </div>
                    <div class="data-table-container">
                        <table>
                            <thead><tr><th>Legenda</th><th>Cor</th><th>Ação</th></tr></thead>
                            <tbody id="agenda-types-list"></tbody>
                        </table>
                    </div>
                </div>
                <div id="set-tab-visits" class="inner-tab">
                    <div class="form-grid" style="align-items: end; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #f1f5f9;">
                        <div class="form-group form-full">
                            <label>Novo Tipo de Visita</label>
                            <input type="text" id="new-visit-name" placeholder="Ex: Presencial / Online">
                        </div>
                        <div class="form-group">
                             <button class="btn btn-primary" onclick="agendaManager.addVisitType()">Adicionar</button>
                        </div>
                    </div>
                    <div class="data-table-container">
                        <table>
                            <thead><tr><th>Tipo de Visita</th><th>Ação</th></tr></thead>
                            <tbody id="agenda-visits-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="opp-modal" class="modal-overlay">
        <div class="modal modal-sm">
            <div class="modal-header-premium">
                <h3>Nova Oportunidade</h3>
                <button class="btn btn-sm btn-outline" onclick="oppManager.closeModal()">X</button>
            </div>
            <div class="modal-body-content">
                <form id="opp-form" onsubmit="oppManager.save(event)">
                    <div class="form-group">
                        <label>Título da Oportunidade</label>
                        <input type="text" id="opp-title" placeholder="Ex: Projeto Casamento Silva" required>
                    </div>
                    <div class="form-group">
                        <label>Cliente</label>
                        <input type="text" id="opp-client" placeholder="Nome do Cliente" required>
                    </div>
                    <div class="form-group">
                        <label>Valor Estimado</label>
                        <input type="number" id="opp-value" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="opp-status">
                            <option value="Prospect">Prospecção</option>
                            <option value="Proposal">Proposta Enviada</option>
                            <option value="Negotiation">Negociação</option>
                            <option value="Closed">Fechado</option>
                            <option value="Lost">Perdido</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width:100%">Salvar Oportunidade</button>
                </form>
            </div>
        </div>
    </div>

    <div id="product-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header-premium">
                <h3 id="prod-modal-title">Novo Produto</h3>
                <button class="btn btn-sm btn-outline" onclick="document.getElementById('product-modal').style.display='none'">X</button>
            </div>
            <div class="modal-body-content">
                <form id="product-form" onsubmit="stockManager.saveProduct(event)">
                    <input type="hidden" id="prod-id">
                    <div class="form-grid">
                        <div class="form-group form-full">
                            <label>Nome do Produto</label>
                            <input type="text" id="prod-name" required placeholder="Ex: Álbum 20x20 Couro">
                        </div>
                        <div class="form-group">
                            <label>SKU / Código</label>
                            <input type="text" id="prod-sku">
                        </div>
                        <div class="form-group">
                            <label>Categoria</label>
                            <input type="text" id="prod-category" placeholder="Ex: Álbuns, Pendrives, Molduras">
                        </div>
                        <div class="form-group">
                            <label>Preço de Custo (R$)</label>
                            <input type="number" step="0.01" id="prod-cost">
                        </div>
                        <div class="form-group">
                            <label>Preço de Venda (R$)</label>
                            <input type="number" step="0.01" id="prod-price" required>
                        </div>
                        <div class="form-group">
                            <label>Estoque Mínimo</label>
                            <input type="number" id="prod-min" value="5">
                        </div>
                        <div class="form-group">
                            <label>Fornecedor (Opcional)</label>
                            <input type="text" id="prod-supplier" placeholder="Nome do Fornecedor">
                        </div>
                        <div class="form-group form-full">
                            <label>Descrição / Detalhes</label>
                            <textarea id="prod-desc" rows="2"></textarea>
                        </div>
                        <div class="form-group form-full">
                            <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Salvar Produto</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="movement-modal" class="modal-overlay">
        <div class="modal modal-sm">
            <div class="modal-header-premium">
                <h3>Movimentação de Estoque</h3>
                <button class="btn btn-sm btn-outline" onclick="document.getElementById('movement-modal').style.display='none'">X</button>
            </div>
            <div class="modal-body-content">
                <form id="movement-form" onsubmit="stockManager.saveMovement(event)">
                    <div class="form-group">
                        <label>Produto</label>
                        <select id="mov-product" required onchange="stockManager.updateCurrentStockDisplay()">
                            <option value="">Selecione...</option>
                            </select>
                        <small id="mov-current-stock-display" style="color:var(--text-muted)">Saldo Atual: -</small>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Movimento</label>
                        <select id="mov-type" required>
                            <option value="entry">Entrada (+)</option>
                            <option value="exit">Saída (-)</option>
                            <option value="adjust">Ajuste de Inventário (=)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quantidade</label>
                        <input type="number" id="mov-qty" min="1" required>
                    </div>
                    <div class="form-group">
                        <label>Motivo / Observação</label>
                        <input type="text" id="mov-reason" placeholder="Ex: Compra NF 123 ou Venda Balcão">
                    </div>
                    <button type="submit" class="btn btn-primary" style="width:100%">Confirmar Movimento</button>
                </form>
            </div>
        </div>
    </div>
  
<script>
// =========================================================================
       // CONFIGURAÇÃO SUPABASE & AUTENTICAÇÃO
// =========================================================================
const SUPABASE_URL = 'https://rjyxkouegrropsarrhje.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJqeXhrb3VlZ3Jyb3BzYXJyaGplIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1NjYxNjcsImV4cCI6MjA4NTE0MjE2N30.UjNPnVBVhQcUSirXeWZ3RmYmAhDMqqbbVUChG_Mv57U';

// Inicializa Cliente (FORMA CORRETA v2)
window.supabaseClient = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_KEY
);
       
           const authManager = {
            // Verifica sessão atual ao carregar
            init: async () => {
                const { data: { session } } = await supabaseClient.auth.getSession();
                authManager.updateUI(session);

                // Escuta mudanças de estado (Login/Logout)
                supabaseClient.auth.onAuthStateChange((event, session) => {
                    authManager.updateUI(session);
                });
            },

            // Atualiza a interface (Mostra/Esconde Login)
            updateUI: (session) => {
                const body = document.body;
                if (session) {
                    body.classList.remove('not-authenticated');
                    body.classList.add('authenticated');
                    // Inicia o app original se ainda não iniciou
                    if (typeof app !== 'undefined' && !app.initialized) {
                        app.init(); 
                        app.initialized = true;
                    }
                } else {
                    body.classList.remove('authenticated');
                    body.classList.add('not-authenticated');
                }
            },

            // Realiza Login
            login: async () => {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const errorMsg = document.getElementById('login-error-msg');
                const btn = document.getElementById('btn-do-login');

                if (!email || !password) {
                    authManager.showError('Preencha email e senha.');
                    return;
                }

                btn.innerText = 'Autenticando...';
                btn.disabled = true;
                errorMsg.style.display = 'none';

                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                btn.innerText = 'Entrar no Sistema';
                btn.disabled = false;

                if (error) {
                    authManager.showError('Erro: ' + error.message);
                } else {
                    // Sucesso: O listener onAuthStateChange cuidará da UI
                }
            },

         

            // Logout
            logout: async () => {
                if(confirm("Deseja sair do sistema?")) {
                    await supabaseClient.auth.signOut();
                    // O listener atualiza a UI automaticamente
                }
            },

            showError: (msg) => {
                const el = document.getElementById('login-error-msg');
                el.innerText = msg;
                el.style.display = 'block';
            }
        };

        // Inicia verificação de Auth imediatamente
        authManager.init();
        

        // =========================================================================
        // LÓGICA ORIGINAL DO SISTEMA (INTACTA)
        // =========================================================================

        // --- Configuração e Utilidades do DB (IndexedDB) - INTACTO ---
        const DB_NAME = 'lg_crmDB';
        const DB_VERSION = 9;

        class DB {
            constructor() { this.db = null; }

            async connect() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('contacts')) db.createObjectStore('contacts', { keyPath: 'id', autoIncrement: true });
                        if (!db.objectStoreNames.contains('albums')) db.createObjectStore('albums', { keyPath: 'id', autoIncrement: true });
                        if (!db.objectStoreNames.contains('opps')) db.createObjectStore('opps', { keyPath: 'id', autoIncrement: true });
                        if (!db.objectStoreNames.contains('products')) db.createObjectStore('products', { keyPath: 'id', autoIncrement: true });
                        if (!db.objectStoreNames.contains('movements')) db.createObjectStore('movements', { keyPath: 'id', autoIncrement: true });
                        if (!db.objectStoreNames.contains('events')) db.createObjectStore('events', { keyPath: 'id', autoIncrement: true });
                        if (!db.objectStoreNames.contains('eventTypes')) db.createObjectStore('eventTypes', { keyPath: 'id', autoIncrement: true });
                        if (!db.objectStoreNames.contains('visitTypes')) db.createObjectStore('visitTypes', { keyPath: 'id', autoIncrement: true });
                        if (!db.objectStoreNames.contains('transactions')) db.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
                        if (!db.objectStoreNames.contains('customReports')) db.createObjectStore('customReports', { keyPath: 'id', autoIncrement: true });
                    };
                    request.onsuccess = (e) => {
                        this.db = e.target.result;
                        console.log(".");
                        resolve(this.db);
                    };
                    request.onerror = (e) => reject(e);
                });
            }

            async getAll(storeName) {
                return new Promise((resolve) => {
                    const transaction = this.db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                });
            }

            async put(storeName, data) {
                return new Promise((resolve) => {
                    const transaction = this.db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.put(data);
                    request.onsuccess = () => resolve(request.result);
                });
            }

            async delete(storeName, id) {
                return new Promise((resolve) => {
                    const transaction = this.db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    store.delete(id);
                    transaction.oncomplete = () => resolve();
                });
            }
        }
        const db = new DB();
      // --- BACKUP MANAGER (NOVO RECURSO IMPLEMENTADO) ---
        const backupManager = {
            exportData: async () => {
                try {
                    const stores = ['contacts', 'albums', 'opps', 'products', 'movements', 'events', 'eventTypes', 'visitTypes', 'transactions', 'customReports'];
                    const backupData = {
                        timestamp: new Date().toISOString(),
                        version: '6.0',
                        data: {}
                    };
                    
                    document.getElementById('backup-status').innerText = "Gerando arquivo de backup...";

                    for (const store of stores) {
                        backupData.data[store] = await db.getAll(store);
                    }

                    // Salvar configurações do localStorage também
                    backupData.localStorage = {
                        'dashboardSettings': localStorage.getItem('dashboardSettings'),
                        'rc_global_config': localStorage.getItem('rc_global_config'),
                        'projectTypes': localStorage.getItem('projectTypes'),
                        'waTemplates': localStorage.getItem('waTemplates')
                    };

                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupData));
                    const downloadAnchorNode = document.createElement('a');
                    downloadAnchorNode.setAttribute("href", dataStr);
                    downloadAnchorNode.setAttribute("download", "backup_crm_rc_" + new Date().toISOString().slice(0,10) + ".json");
                    document.body.appendChild(downloadAnchorNode);
                    downloadAnchorNode.click();
                    downloadAnchorNode.remove();

                    document.getElementById('backup-status').innerText = "Backup baixado com sucesso!";
                    setTimeout(() => document.getElementById('backup-status').innerText = "", 3000);

                } catch (e) {
                    alert("Erro ao exportar dados: " + e.message);
                }
            },

            importData: async (input) => {
                const file = input.files[0];
                if (!file) return;

                if (!confirm("ATENÇÃO: Isso irá adicionar/sobrescrever dados no sistema atual. Recomenda-se fazer um backup antes. Continuar?")) {
                    input.value = '';
                    return;
                }

                const reader = new FileReader();
                document.getElementById('backup-status').innerText = "Lendo arquivo...";

                reader.onload = async (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        
                        if (!json.data) throw new Error("Arquivo de backup inválido.");

                        // Restaurar IndexedDB
                        for (const storeName in json.data) {
                            const items = json.data[storeName];
                            if (Array.isArray(items)) {
                                for (const item of items) {
                                    await db.put(storeName, item);
                                }
                            }
                        }

                        // Restaurar LocalStorage
                        if (json.localStorage) {
                            for (const key in json.localStorage) {
                                if (json.localStorage[key]) {
                                    localStorage.setItem(key, json.localStorage[key]);
                                }
                            }
                        }

                        alert("Dados restaurados com sucesso! O sistema será recarregado.");
                        window.location.reload();

                    } catch (err) {
                        alert("Erro ao processar backup: " + err.message);
                        document.getElementById('backup-status').innerText = "Erro na restauração.";
                    }
                };
                reader.readAsText(file);
            }
        };
        // --- QUOTE MANAGER (PREMIUM) ---
        const quoteManager = {
            state: {
                items: [],
                color: '#2563eb',
                logo: null,
                bg: null,
                opacity: 1,
                layout: 'modern'
            },
            
            newQuote: () => {
                document.getElementById('quotes-history').style.display = 'none';
                document.getElementById('quote-builder-area').style.display = 'block';
                // Reset básico
                quoteManager.state.items = [];
                document.getElementById('q-items-list-sidebar').innerHTML = '';
                document.getElementById('q-client-name').value = '';
                document.getElementById('q-client-doc').value = '';
                quoteManager.updatePreview();
            },

            handleLogoUpload: (input) => {
                if(input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        quoteManager.state.logo = e.target.result;
                        document.getElementById('q-logo-preview').src = e.target.result;
                        document.getElementById('q-logo-preview').style.display = 'block';
                        quoteManager.updatePreview();
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            },

            handleBgUpload: (input) => {
                if(input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        quoteManager.state.bg = e.target.result;
                        quoteManager.updatePreview();
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            },

            updateSettings: () => {
                quoteManager.state.color = document.getElementById('q-accent-color').value;
                quoteManager.state.opacity = document.getElementById('q-bg-opacity').value;
                quoteManager.updatePreview();
            },

            setLayout: (layout) => {
                quoteManager.state.layout = layout;
                document.querySelectorAll('.layout-opt').forEach(el => el.classList.remove('active'));
                document.getElementById('layout-btn-' + layout).classList.add('active');
                quoteManager.updatePreview();
            },

            addItem: () => {
                const desc = prompt("Descrição do Item:");
                if(!desc) return;
                const price = parseFloat(prompt("Valor Unitário:", "0") || 0);
                const qty = parseInt(prompt("Quantidade:", "1") || 1);
                quoteManager.state.items.push({ desc, price, qty });
                quoteManager.renderSidebarItems();
                quoteManager.updatePreview();
            },

            renderSidebarItems: () => {
                const container = document.getElementById('q-items-list-sidebar');
                container.innerHTML = '';
                quoteManager.state.items.forEach((item, idx) => {
                    container.innerHTML += `
                        <div style="display:flex; justify-content:space-between; border-bottom:1px dashed #e2e8f0; padding:5px 0;">
                            <span>${item.qty}x ${item.desc}</span>
                            <span>R$ ${(item.price * item.qty).toFixed(2)} <i class="fas fa-trash" style="cursor:pointer; color:#ef4444; margin-left:5px;" onclick="quoteManager.removeItem(${idx})"></i></span>
                        </div>
                    `;
                });
            },

            removeItem: (idx) => {
                quoteManager.state.items.splice(idx, 1);
                quoteManager.renderSidebarItems();
                quoteManager.updatePreview();
            },

            updatePreview: () => {
                const paper = document.getElementById('paper-preview');
                const conf = quoteManager.state;
                const clientName = document.getElementById('q-client-name').value || 'Nome do Cliente';
                const clientDoc = document.getElementById('q-client-doc').value || '';
                
                const myName = document.getElementById('conf-company-name').value;
                const myCnpj = document.getElementById('conf-company-cnpj').value;
                const myPhone = document.getElementById('conf-company-phone').value;
                const myAddr = document.getElementById('conf-company-addr').value;

                // Set Vars
                paper.style.setProperty('--quote-accent', conf.color);
                paper.className = `quote-paper layout-${conf.layout}`;
                
                if(conf.bg) {
                    paper.style.backgroundImage = `url(${conf.bg})`;
                    paper.style.backgroundColor = `rgba(255,255,255,${1 - conf.opacity})`; // Trick for opacity handling
                } else {
                    paper.style.backgroundImage = 'none';
                    paper.style.backgroundColor = 'white';
                }

                // Table Rows
                let total = 0;
                const rows = conf.items.map(i => {
                    total += i.qty * i.price;
                    return `<tr><td>${i.desc}</td><td>${i.qty}</td><td>R$ ${i.price.toFixed(2)}</td><td>R$ ${(i.qty * i.price).toFixed(2)}</td></tr>`;
                }).join('');

                const dateStr = new Date().toLocaleDateString();

                if(conf.layout === 'modern') {
                    paper.innerHTML = `
                        <div class="q-header">
                            <div>
                                ${conf.logo ? `<img src="${conf.logo}" class="q-logo">` : `<h2>${myName}</h2>`}
                                <p style="font-size:0.8rem; color:#64748b;">${myCnpj} | ${myPhone}<br>${myAddr}</p>
                            </div>
                            <div style="text-align:right;">
                                <div class="q-title">Orçamento</div>
                                <p>Data: ${dateStr}</p>
                                <p>Cliente: <strong>${clientName}</strong><br><small>${clientDoc}</small></p>
                            </div>
                        </div>
                        <table>
                            <thead><tr><th>Descrição</th><th>Qtd</th><th>Unit.</th><th>Total</th></tr></thead>
                            <tbody>${rows || '<tr><td colspan="4" style="text-align:center; padding:30px; color:#cbd5e1;">Adicione itens ao lado...</td></tr>'}</tbody>
                        </table>
                        <div class="q-total-area">Total: R$ ${total.toFixed(2)}</div>
                    `;
                } else {
                    // Enterprise Layout
                    paper.innerHTML = `
                        <div class="q-top-bar"></div>
                        <div class="q-content-pad">
                            <div class="q-header">
                                ${conf.logo ? `<img src="${conf.logo}" class="q-logo">` : `<div style="background:${conf.color}; width:80px; height:80px; border-radius:50%;"></div>`}
                                <div>
                                    <h2 style="color:${conf.color}; font-size:2rem; margin-bottom:5px;">${myName}</h2>
                                    <p style="color:#64748b; font-size:0.9rem;">Soluções Profissionais</p>
                                </div>
                            </div>
                            
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                                <div class="q-info-box">
                                    <small style="color:#94a3b8; text-transform:uppercase; font-weight:700;">De:</small><br>
                                    <strong>${myName}</strong><br>
                                    ${myCnpj}<br>${myPhone}
                                </div>
                                <div class="q-info-box">
                                    <small style="color:#94a3b8; text-transform:uppercase; font-weight:700;">Para:</small><br>
                                    <strong>${clientName}</strong><br>
                                    ${clientDoc}<br>Data: ${dateStr}
                                </div>
                            </div>

                            <table style="width:100%; margin-top:30px; border-collapse:collapse;">
                                <thead><tr><th>Item</th><th>Qtd</th><th>Unitário</th><th>Subtotal</th></tr></thead>
                                <tbody>${rows || '<tr><td colspan="4" style="text-align:center; padding:30px; color:#cbd5e1;">Adicione itens...</td></tr>'}</tbody>
                            </table>

                            <div style="text-align:right; margin-top:30px; font-size:1.8rem; font-weight:800; color:${conf.color};">
                                R$ ${total.toFixed(2)}
                            </div>
                        </div>
                        <div class="q-footer">
                            Documento gerado digitalmente por Legacy CRM Enterprise.
                        </div>
                    `;
                }
            },

            printPdf: () => {
                window.print();
            }
        };

        // --- REPORT MANAGER (BI) ---
        const reportManager = {
            init: async () => { await reportManager.loadSaved(); await reportManager.renderCharts(); },
            loadSaved: async () => {
                const reports = await db.getAll('customReports');
                const container = document.getElementById('saved-reports-container');
                container.innerHTML = `<div class="report-builder-box" onclick="reportManager.openBuilder()"><i class="fas fa-plus-circle"></i><span>Novo Relatório</span><small>Customizar filtros e dados</small></div>`;
                reports.forEach(r => {
                    const html = `<div class="card" style="cursor:pointer; transition:all 0.2s; border:1px solid #e2e8f0;" onclick="alert('Visualização Detalhada em breve')"><div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;"><div style="width:35px; height:35px; background:#eff6ff; color:var(--primary-color); border-radius:8px; display:flex; align-items:center; justify-content:center;"><i class="fas fa-chart-pie"></i></div><h4 style="margin:0; font-size:0.95rem;">${r.name}</h4></div><p style="font-size:0.8rem; color:#64748b;">Fonte: ${r.source} <br> Criado em: ${new Date(r.createdAt).toLocaleDateString()}</p></div>`;
                    container.insertAdjacentHTML('beforeend', html);
                });
            },
            openBuilder: () => { document.getElementById('custom-report-modal').style.display = 'flex'; document.getElementById('rep-name').value = ''; document.getElementById('rep-preview-area').style.display = 'none'; },
            generatePreview: async () => {
                const source = document.getElementById('rep-source').value;
                const start = document.getElementById('rep-start').value;
                const end = document.getElementById('rep-end').value;
                let data = [], headers = [], rows = [];
                if(source === 'financial') {
                    const all = await db.getAll('transactions');
                    data = all.filter(t => (!start || t.date >= start) && (!end || t.date <= end));
                    headers = ['Data', 'Descrição', 'Valor', 'Tipo'];
                    rows = data.map(d => `<tr><td>${d.date}</td><td>${d.desc}</td><td>R$ ${d.value}</td><td>${d.type}</td></tr>`);
                } else if (source === 'contacts') {
                    const all = await db.getAll('contacts');
                    data = all; 
                    headers = ['Nome', 'Tipo', 'Email', 'Telefone'];
                    rows = data.map(d => `<tr><td>${d.name}</td><td>${d.type}</td><td>${d.email}</td><td>${d.phone}</td></tr>`);
                } else if (source === 'stock') {
                    const all = await db.getAll('products');
                    data = all;
                    headers = ['Produto', 'Estoque', 'Preço', 'Custo'];
                    rows = data.map(d => `<tr><td>${d.name}</td><td>${d.stock}</td><td>${d.price}</td><td>${d.cost}</td></tr>`);
                }
                const tableHtml = `<thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead><tbody>${rows.join('')}</tbody>`;
                document.getElementById('rep-preview-table').innerHTML = tableHtml;
                document.getElementById('rep-preview-area').style.display = 'block';
            },
            saveReport: async () => {
                const name = document.getElementById('rep-name').value;
                if(!name) return alert('Dê um nome ao relatório');
                const report = { id: Date.now(), name: name, source: document.getElementById('rep-source').value, start: document.getElementById('rep-start').value, end: document.getElementById('rep-end').value, createdAt: new Date() };
                await db.put('customReports', report);
                document.getElementById('custom-report-modal').style.display = 'none';
                reportManager.loadSaved();
            },
            renderCharts: async () => {
                const transactions = await db.getAll('transactions');
                const months = {}; 
                transactions.forEach(t => { const m = t.date.substring(0, 7); if(!months[m]) months[m] = 0; if(t.type === 'in' && t.status === 'paid') months[m] += t.value; });
                const keys = Object.keys(months).sort().slice(-6);
                let barsHtml = '';
                const maxVal = Math.max(...Object.values(months)) || 1;
                keys.forEach(k => { const h = (months[k] / maxVal) * 100; barsHtml += `<div class="chart-bar-group"><div class="chart-bar c-success" style="height: ${h}%"><span class="chart-val-tooltip">R$ ${months[k]}</span></div><span class="chart-label">${k.split('-')[1]}</span></div>`; });
                document.getElementById('chart-revenue').innerHTML = barsHtml || '<small>Sem dados</small>';
                const contacts = await db.getAll('contacts');
                const types = {}; contacts.forEach(c => { types[c.type] = (types[c.type] || 0) + 1; });
                let clientBars = ''; const totalC = contacts.length || 1;
                Object.keys(types).forEach(t => { const h = (types[t] / totalC) * 100; clientBars += `<div class="chart-bar-group"><div class="chart-bar c-primary" style="height: ${h}%"><span class="chart-val-tooltip">${types[t]}</span></div><span class="chart-label">${t.substring(0,6)}</span></div>`; });
                document.getElementById('chart-clients').innerHTML = clientBars || '<small>Sem dados</small>';
                const albums = await db.getAll('albums');
                let projBars = `<div class="chart-bar-group"><div class="chart-bar c-warning" style="height: 50%"><span class="chart-val-tooltip">${albums.length}</span></div><span class="chart-label">Ativos</span></div>`;
                document.getElementById('chart-projects').innerHTML = projBars;
            }
        };

        // --- FINANCEIRO MANAGER ---
        const financeManager = {
            transactions: [],
            init: async () => { const now = new Date(); const month = String(now.getMonth() + 1).padStart(2, '0'); const year = now.getFullYear(); document.getElementById('fin-filter-month').value = `${year}-${month}`; },
            openDashboard: async () => { document.getElementById('financial-dashboard-modal').style.display = 'flex'; await financeManager.render(); },
            openForm: () => { document.getElementById('fin-form').reset(); financeManager.updateCategories(); document.getElementById('financial-form-modal').style.display = 'flex'; },
            updateCategories: () => { const type = document.getElementById('fin-type').value; const catSel = document.getElementById('fin-cat'); catSel.innerHTML = ''; const catsIn = ['Venda de Serviço', 'Venda de Produto', 'Adiantamento', 'Outras Receitas']; const catsOut = ['Aluguel', 'Fornecedores', 'Material', 'Marketing', 'Impostos', 'Salários', 'Software', 'Outras Despesas']; const list = type === 'in' ? catsIn : catsOut; list.forEach(c => catSel.innerHTML += `<option value="${c}">${c}</option>`); },
            save: async (e) => { e.preventDefault(); const data = { id: Date.now(), type: document.getElementById('fin-type').value, desc: document.getElementById('fin-desc').value, category: document.getElementById('fin-cat').value, value: parseFloat(document.getElementById('fin-value').value), date: document.getElementById('fin-date').value, status: document.getElementById('fin-status').value }; await db.put('transactions', data); document.getElementById('financial-form-modal').style.display = 'none'; financeManager.render(); },
            render: async () => {
                const all = await db.getAll('transactions');
                const filterDate = document.getElementById('fin-filter-month').value; 
                const filterType = document.getElementById('fin-filter-type').value;
                let filtered = all;
                if(filterDate) filtered = filtered.filter(t => t.date.startsWith(filterDate));
                if(filterType !== 'all') filtered = filtered.filter(t => t.type === filterType);
                filtered.sort((a,b) => b.date.localeCompare(a.date));
                let totalIncome = 0; let totalExpense = 0;
                const tbody = document.getElementById('fin-list-body'); tbody.innerHTML = '';
                if(filtered.length === 0) tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:30px; color:#64748b;">Nenhum lançamento encontrado.</td></tr>';
                filtered.forEach(t => {
                    if(t.type === 'in' && t.status === 'paid') totalIncome += t.value;
                    if(t.type === 'out' && t.status === 'paid') totalExpense += t.value;
                    const typeIcon = t.type === 'in' ? '<div class="fin-type-icon type-in"><i class="fas fa-arrow-up"></i></div>' : '<div class="fin-type-icon type-out"><i class="fas fa-arrow-down"></i></div>';
                    let statusBadge = ''; const today = new Date().toISOString().split('T')[0];
                    if(t.status === 'paid') statusBadge = t.type === 'in' ? '<span class="status-badge received">Recebido</span>' : '<span class="status-badge paid">Pago</span>';
                    else { if(t.date < today) statusBadge = '<span class="status-badge late">Atrasado</span>'; else statusBadge = '<span class="status-badge pending-pay">Pendente</span>'; }
                    let integrationBadge = ''; if(t.eventId) integrationBadge = `<span class="fin-auto-badge" title="Lançamento automático via Agenda"><i class="fas fa-link"></i> Auto</span>`;
                    tbody.innerHTML += `<tr><td>${typeIcon}</td><td style="font-weight:600;">${t.desc}<div>${integrationBadge}</div></td><td style="color:#64748b; font-size:0.85rem;">${t.category}</td><td>${new Date(t.date).toLocaleDateString('pt-BR', {timeZone:'UTC'})}</td><td style="font-weight:700; color: ${t.type === 'in' ? '#166534' : '#ef4444'}">R$ ${t.value.toFixed(2)}</td><td>${statusBadge}</td><td style="text-align:right;">${t.status === 'pending' ? `<button class="btn btn-sm btn-outline" title="Marcar Pago" onclick="financeManager.markPaid(${t.id})"><i class="fas fa-check"></i></button>` : ''} <button class="btn btn-sm btn-danger-outline" onclick="financeManager.delete(${t.id})"><i class="fas fa-trash"></i></button></td></tr>`;
                });
                const balance = totalIncome - totalExpense;
                document.getElementById('bi-income').innerText = totalIncome.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
                document.getElementById('bi-expense').innerText = totalExpense.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
                document.getElementById('bi-balance').innerText = balance.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
                document.getElementById('bi-balance').style.color = balance >= 0 ? '#1e293b' : '#ef4444';
                document.getElementById('bi-balance-txt').innerHTML = balance >= 0 ? '<i class="fas fa-smile" style="color:#10b981"></i> Resultado Positivo' : '<i class="fas fa-frown" style="color:#ef4444"></i> Prejuízo no Período';
                const maxVal = Math.max(totalIncome, totalExpense) || 1;
                document.getElementById('bi-bar-income').style.width = ((totalIncome / maxVal) * 100) + '%';
                document.getElementById('bi-bar-expense').style.width = ((totalExpense / maxVal) * 100) + '%';
                let balancePct = totalIncome > 0 ? (balance / totalIncome) * 100 : 0; if(balancePct < 0) balancePct = 0; 
                document.getElementById('bi-bar-balance').style.width = balancePct + '%';
                mgmt.updateDRE(totalIncome, totalExpense);
            },
            markPaid: async (id) => { const all = await db.getAll('transactions'); const t = all.find(x => x.id === id); if(t) { t.status = 'paid'; await db.put('transactions', t); financeManager.render(); } },
            delete: async (id) => { if(confirm("Excluir este lançamento?")) { await db.delete('transactions', id); financeManager.render(); } }
        };

        // --- GESTÃO MANAGER ---
        const mgmt = {
            switch: (subTabId) => {
                document.querySelectorAll('.mgmt-nav button').forEach(b => b.classList.remove('active'));
                event.currentTarget.classList.add('active');
                document.querySelectorAll('.mgmt-section').forEach(s => s.classList.remove('active'));
                const target = document.getElementById('mgmt-'+subTabId);
                if(target) target.classList.add('active');
                if(subTabId === 'stock') stockManager.load();
                if(subTabId === 'albums') albumManager.load();
                if(subTabId === 'opps') oppManager.load();
                if(subTabId === 'reports') reportManager.init();
            },
            updateDRE: (inc, exp) => {
                const recBruta = inc;
                const impostos = recBruta * 0.06; 
                const recLiq = recBruta - impostos;
                const custos = exp * 0.4; 
                const lucroBruto = recLiq - custos;
                const despesas = exp * 0.6;
                const resultado = lucroBruto - despesas;
                const fmt = (v) => v.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
                document.getElementById('dre-receita').innerText = fmt(recBruta);
                document.getElementById('dre-impostos').innerText = `(${fmt(impostos)})`;
                document.getElementById('dre-rec-liq').innerText = fmt(recLiq);
                document.getElementById('dre-custos').innerText = `(${fmt(custos)})`;
                document.getElementById('dre-lucro-bruto').innerText = fmt(lucroBruto);
                document.getElementById('dre-despesas').innerText = `(${fmt(despesas)})`;
                document.getElementById('dre-resultado').innerText = fmt(resultado);
                const resElem = document.getElementById('dre-resultado');
                if(resultado < 0) { resElem.style.color = 'red'; } else { resElem.style.color = '#166534'; }
            }
        };

        // --- DASHBOARD MANAGER ---
        const dashboardManager = {
            widgets: [ {id: 'dash-card-calls', name: 'Atendimentos do Dia', icon: 'fas fa-headset'}, {id: 'dash-card-albums', name: 'Projetos Ativos', icon: 'fas fa-tasks'}, {id: 'dash-card-revenue', name: 'Faturamento Mensal', icon: 'fas fa-wallet'}, {id: 'dash-card-calendar', name: 'Calendário Principal', icon: 'far fa-calendar-alt'}, {id: 'dash-card-events', name: 'Lista de Eventos', icon: 'fas fa-list-ul'} ],
            settings: ['dash-card-calls', 'dash-card-albums', 'dash-card-revenue', 'dash-card-calendar', 'dash-card-events'],
            init: () => { const saved = localStorage.getItem('dashboardSettings'); if (saved) { dashboardManager.settings = JSON.parse(saved); } dashboardManager.applySettings(); },
            applySettings: () => { dashboardManager.widgets.forEach(w => { const el = document.getElementById(w.id); if (el) { if (dashboardManager.settings.includes(w.id)) { el.style.display = 'block'; } else { el.style.display = 'none'; } } }); },
            openModal: () => { const grid = document.getElementById('customizer-grid-container'); grid.innerHTML = ''; dashboardManager.widgets.forEach(w => { const isSelected = dashboardManager.settings.includes(w.id) ? 'selected' : ''; grid.innerHTML += `<div class="customizer-item ${isSelected}" onclick="dashboardManager.toggleItem('${w.id}', this)"><div class="check-badge"><i class="fas fa-check"></i></div><i class="${w.icon}"></i><span>${w.name}</span></div>`; }); document.getElementById('dashboard-customizer-modal').style.display = 'flex'; },
            closeModal: () => { document.getElementById('dashboard-customizer-modal').style.display = 'none'; },
            toggleItem: (id, element) => { element.classList.toggle('selected'); },
            saveSettings: () => { const newSettings = []; const items = document.querySelectorAll('.customizer-item'); items.forEach((item, index) => { if (item.classList.contains('selected')) { newSettings.push(dashboardManager.widgets[index].id); } }); dashboardManager.settings = newSettings; localStorage.setItem('dashboardSettings', JSON.stringify(newSettings)); dashboardManager.applySettings(); dashboardManager.closeModal(); },
            resetDefaults: () => { const items = document.querySelectorAll('.customizer-item'); items.forEach(i => i.classList.add('selected')); }
        };

        // --- AGENDA MANAGER ---
        const agendaManager = {
            currentDate: new Date(), events: [], types: [], visits: [],
            init: async () => { await agendaManager.loadSettings(); agendaManager.render(); },
            loadSettings: async () => { const types = await db.getAll('eventTypes'); agendaManager.types = types.length ? types : [ {id: 1, name: 'Reunião', color: '#2563eb'}, {id: 2, name: 'Instalação', color: '#166534'}, {id: 3, name: 'Entrega', color: '#f59e0b'} ]; if(!types.length) agendaManager.types.forEach(async t => await db.put('eventTypes', t)); const visits = await db.getAll('visitTypes'); agendaManager.visits = visits.length ? visits : [ {id: 1, name: 'Presencial'}, {id: 2, name: 'Online / Remoto'} ]; if(!visits.length) agendaManager.visits.forEach(async v => await db.put('visitTypes', v)); },
            changeMonth: (delta) => { if (delta === 0) agendaManager.currentDate = new Date(); else agendaManager.currentDate.setMonth(agendaManager.currentDate.getMonth() + delta); agendaManager.render(); },
            render: async () => { agendaManager.events = await db.getAll('events'); const dt = agendaManager.currentDate; const year = dt.getFullYear(), month = dt.getMonth(); const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"]; document.getElementById('agenda-month-year').innerText = `${monthNames[month]} ${year}`; const firstDay = new Date(year, month, 1); const lastDay = new Date(year, month + 1, 0); const startDayIndex = firstDay.getDay(); const totalDays = lastDay.getDate(); const prevMonthLastDay = new Date(year, month, 0).getDate(); let html = ''; for (let i = startDayIndex; i > 0; i--) { html += `<div class="cal-cell other-month"><span class="cal-cell-num">${prevMonthLastDay - i + 1}</span></div>`; } const today = new Date(); for (let i = 1; i <= totalDays; i++) { const currentDayStr = `${year}-${String(month+1).padStart(2, '0')}-${String(i).padStart(2, '0')}`; let isToday = (i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) ? 'today' : ''; const dayEvents = agendaManager.events.filter(e => e.date === currentDayStr); let eventHtml = ''; dayEvents.forEach(evt => { const typeObj = agendaManager.types.find(t => t.id == evt.typeId) || {color: '#ccc'}; eventHtml += `<div class="agenda-event-pill" style="background:${typeObj.color}" onclick="agendaManager.viewEvent(${evt.id})">${evt.time} ${evt.title}</div>`; }); html += `<div class="cal-cell ${isToday}" onclick="agendaManager.dayClick('${currentDayStr}')"><span class="cal-cell-num">${i}</span><div style="display:flex; flex-direction:column; gap:2px;">${eventHtml}</div></div>`; } const totalSlots = startDayIndex + totalDays; const remaining = 42 - totalSlots; if(remaining < 7) for(let j = 1; j <= remaining; j++) html += `<div class="cal-cell other-month"><span class="cal-cell-num">${j}</span></div>`; document.getElementById('agenda-grid').innerHTML = html; agendaManager.renderSidebarList(); },
            renderSidebarList: () => { const list = document.getElementById('agenda-sidebar-list'); list.innerHTML = ''; const todayStr = new Date().toISOString().split('T')[0]; const upcoming = agendaManager.events.filter(e => e.date >= todayStr).sort((a,b) => (a.date + a.time).localeCompare(b.date + b.time)).slice(0, 10); if(!upcoming.length) { list.innerHTML = '<p style="color:#94a3b8; font-size:0.8rem; text-align:center;">Sem eventos próximos.</p>'; return; } upcoming.forEach(e => { const typeObj = agendaManager.types.find(t => t.id == e.typeId) || {color: '#ccc'}; const dateFormatted = new Date(e.date).toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'}); list.innerHTML += `<div class="mini-list-item"><div class="mini-time">${dateFormatted}<br>${e.time}</div><div class="mini-desc"><h4>${e.title}</h4><p>${e.clientName || 'Sem cliente'}</p><span class="mini-tag" style="background:${typeObj.color}"></span></div></div>`; }); },
            openModal: async (datePreSet = null) => { document.getElementById('event-form').reset(); document.getElementById('evt-id').value = ''; document.getElementById('evt-modal-title').innerText = "Novo Agendamento"; document.getElementById('btn-delete-event').style.display = 'none'; if(datePreSet) document.getElementById('evt-date').value = datePreSet; else document.getElementById('evt-date').value = new Date().toISOString().split('T')[0]; const clients = await db.getAll('contacts'); const clientSel = document.getElementById('evt-client'); clientSel.innerHTML = '<option value="">Selecione um cliente...</option>'; clients.forEach(c => clientSel.innerHTML += `<option value="${c.id}">${c.name}</option>`); const typeSel = document.getElementById('evt-type'); typeSel.innerHTML = ''; agendaManager.types.forEach(t => typeSel.innerHTML += `<option value="${t.id}">${t.name}</option>`); const visitSel = document.getElementById('evt-visit-type'); visitSel.innerHTML = ''; agendaManager.visits.forEach(v => visitSel.innerHTML += `<option value="${v.id}">${v.name}</option>`); document.getElementById('event-modal').style.display = 'flex'; },
            populateClientData: async () => { const clientId = document.getElementById('evt-client').value; if(clientId) { const contacts = await db.getAll('contacts'); const c = contacts.find(x => x.id == clientId); if(c && c.address) { const fullAddr = `${c.address}, ${c.number || ''} - ${c.district || ''}, ${c.city || ''}`; document.getElementById('evt-address').value = fullAddr; } } },
            calcFinancials: () => { const total = parseFloat(document.getElementById('evt-val-total').value || 0); const signal = parseFloat(document.getElementById('evt-val-signal').value || 0); const rest = total - signal; document.getElementById('evt-val-rest').value = rest.toFixed(2); },
            dayClick: (dateStr) => { agendaManager.openModal(dateStr); },
            saveEvent: async (e) => { e.preventDefault(); const id = document.getElementById('evt-id').value; const clientId = document.getElementById('evt-client').value; const clientName = clientId ? document.getElementById('evt-client').options[document.getElementById('evt-client').selectedIndex].text : ''; const eventData = { id: id ? parseInt(id) : Date.now(), title: document.getElementById('evt-title').value, clientId: clientId, clientName: clientName, address: document.getElementById('evt-address').value, typeId: document.getElementById('evt-type').value, visitTypeId: document.getElementById('evt-visit-type').value, date: document.getElementById('evt-date').value, time: document.getElementById('evt-time').value, valTotal: document.getElementById('evt-val-total').value, valSignal: document.getElementById('evt-val-signal').value, valRest: document.getElementById('evt-val-rest').value, notes: document.getElementById('evt-notes').value }; await db.put('events', eventData); await agendaManager.syncFinancials(eventData); document.getElementById('event-modal').style.display = 'none'; agendaManager.render(); calendarManager.render(); },
            syncFinancials: async (eventData) => { const allTrans = await db.getAll('transactions'); const linkedTrans = allTrans.filter(t => t.eventId === eventData.id); for(let t of linkedTrans) { await db.delete('transactions', t.id); } const today = new Date().toISOString().split('T')[0]; if(parseFloat(eventData.valSignal) > 0) { const transSignal = { id: Date.now(), eventId: eventData.id, type: 'in', desc: `Sinal: ${eventData.title} - ${eventData.clientName}`, category: 'Venda de Serviço', value: parseFloat(eventData.valSignal), date: today, status: 'paid' }; await db.put('transactions', transSignal); } if(parseFloat(eventData.valRest) > 0) { const transRest = { id: Date.now() + 1, eventId: eventData.id, type: 'in', desc: `Restante: ${eventData.title} - ${eventData.clientName}`, category: 'Venda de Serviço', value: parseFloat(eventData.valRest), date: eventData.date, status: 'pending' }; await db.put('transactions', transRest); } },
            deleteEvent: async () => { const id = document.getElementById('evt-id').value; if(id && confirm("Tem certeza? Os dados financeiros vinculados também serão removidos.")) { const eventId = parseInt(id); await db.delete('events', eventId); const allTrans = await db.getAll('transactions'); const linkedTrans = allTrans.filter(t => t.eventId === eventId); for(let t of linkedTrans) { await db.delete('transactions', t.id); } document.getElementById('event-modal').style.display = 'none'; agendaManager.render(); calendarManager.render(); } },
            viewEvent: async (id) => { const evt = agendaManager.events.find(x => x.id === id); if(evt) { await agendaManager.openModal(); document.getElementById('evt-modal-title').innerText = "Editar Agendamento"; document.getElementById('btn-delete-event').style.display = 'block'; document.getElementById('evt-id').value = evt.id; document.getElementById('evt-title').value = evt.title; document.getElementById('evt-client').value = evt.clientId || ''; document.getElementById('evt-address').value = evt.address || ''; document.getElementById('evt-type').value = evt.typeId; document.getElementById('evt-visit-type').value = evt.visitTypeId; document.getElementById('evt-date').value = evt.date; document.getElementById('evt-time').value = evt.time; document.getElementById('evt-val-total').value = evt.valTotal || ''; document.getElementById('evt-val-signal').value = evt.valSignal || ''; document.getElementById('evt-val-rest').value = evt.valRest || ''; document.getElementById('evt-notes').value = evt.notes; } },
            openSettings: async () => { await agendaManager.renderSettingsLists(); document.getElementById('agenda-settings-modal').style.display = 'flex'; },
            switchSettingsTab: (tab) => { document.querySelectorAll('.modal-tab-btn').forEach(b => b.classList.remove('active')); event.currentTarget.classList.add('active'); document.querySelectorAll('#agenda-settings-modal .inner-tab').forEach(t => t.classList.remove('active')); document.getElementById('set-tab-'+tab).classList.add('active'); },
            renderSettingsLists: async () => { const tBody = document.getElementById('agenda-types-list'); tBody.innerHTML = ''; agendaManager.types.forEach(t => { tBody.innerHTML += `<tr><td>${t.name}</td><td><div style="width:20px;height:20px;background:${t.color};border-radius:4px;"></div></td><td><button class="btn btn-sm btn-danger-outline" onclick="agendaManager.delType(${t.id})"><i class="fas fa-trash"></i></button></td></tr>`; }); const vBody = document.getElementById('agenda-visits-list'); vBody.innerHTML = ''; agendaManager.visits.forEach(v => { vBody.innerHTML += `<tr><td>${v.name}</td><td><button class="btn btn-sm btn-danger-outline" onclick="agendaManager.delVisit(${v.id})"><i class="fas fa-trash"></i></button></td></tr>`; }); },
            addType: async () => { const name = document.getElementById('new-type-name').value; const color = document.getElementById('new-type-color').value; if(name) { await db.put('eventTypes', {id: Date.now(), name, color}); document.getElementById('new-type-name').value = ''; await agendaManager.loadSettings(); agendaManager.renderSettingsLists(); agendaManager.render(); } },
            delType: async (id) => { if(confirm("Remover este tipo?")) { await db.delete('eventTypes', id); await agendaManager.loadSettings(); agendaManager.renderSettingsLists(); } },
            addVisitType: async () => { const name = document.getElementById('new-visit-name').value; if(name) { await db.put('visitTypes', {id: Date.now(), name}); document.getElementById('new-visit-name').value = ''; await agendaManager.loadSettings(); agendaManager.renderSettingsLists(); } },
            delVisit: async (id) => { if(confirm("Remover este tipo de visita?")) { await db.delete('visitTypes', id); await agendaManager.loadSettings(); agendaManager.renderSettingsLists(); } }
        };

        // --- MSG MANAGER ---
        const msgManager = {
            templates: [ { id: 1, title: 'Boas Vindas', text: 'Olá [Nome], seja bem-vindo à Legacy! Como podemos ajudar?' }, { id: 2, title: 'Confirmação Agenda', text: 'Olá [Nome], confirmando nosso agendamento para [Data] às [Hora]. O endereço é [Endereco].' }, { id: 3, title: 'Cobrança Financeira', text: 'Olá [Nome], segue lembrete sobre o pagamento restante de R$ [Restante] referente ao serviço total de R$ [Total].' } ],
            contacts: [], viewMode: 'contacts', activeChatContact: null,
            init: () => { const saved = localStorage.getItem('waTemplates'); if(saved) msgManager.templates = JSON.parse(saved); },
            openModal: async () => { document.getElementById('whatsapp-modal').style.display = 'flex'; msgManager.contacts = await db.getAll('contacts'); msgManager.switchView('contacts'); },
            switchView: (mode) => { msgManager.viewMode = mode; document.getElementById('btn-wa-view-contacts').classList.toggle('active', mode === 'contacts'); document.getElementById('btn-wa-view-templates').classList.toggle('active', mode === 'templates'); document.getElementById('wa-view-chat').style.display = 'flex'; document.getElementById('wa-view-new-template').style.display = 'none'; msgManager.renderList(); },
            renderList: () => { const listContainer = document.getElementById('wa-list-container'); listContainer.innerHTML = ''; const searchTerm = document.getElementById('wa-search-input').value.toLowerCase(); if (msgManager.viewMode === 'contacts') { const filtered = msgManager.contacts.filter(c => c.name.toLowerCase().includes(searchTerm) || (c.phone && c.phone.includes(searchTerm))); if (filtered.length === 0) { listContainer.innerHTML = '<div style="padding:15px; color:#999; text-align:center;">Nenhum contato encontrado.</div>'; return; } filtered.forEach(c => { const isActive = (msgManager.activeChatContact && msgManager.activeChatContact.id === c.id) ? 'active' : ''; listContainer.innerHTML += `<div class="wa-list-item ${isActive}" onclick="msgManager.selectContact(${c.id})"><div class="wa-avatar"><i class="fas fa-user"></i></div><div style="flex:1;"><div style="font-weight:600; font-size:0.9rem;">${c.name}</div><div style="font-size:0.8rem; color:#667781;">${c.phone || 'Sem telefone'}</div></div></div>`; }); } else { const filtered = msgManager.templates.filter(t => t.title.toLowerCase().includes(searchTerm)); listContainer.innerHTML += `<div style="padding:10px; text-align:center; border-bottom:1px solid #f1f5f9;"><button class="btn btn-sm btn-primary" onclick="msgManager.openTemplateEditor()">+ Novo Modelo</button></div>`; filtered.forEach(t => { listContainer.innerHTML += `<div class="wa-list-item" onclick="msgManager.selectTemplate('${t.id}')"><div class="wa-avatar" style="background:#f0f2f5; color:#54656f; font-size:1rem;"><i class="fas fa-file-alt"></i></div><div style="flex:1;"><div style="font-weight:600; font-size:0.9rem;">${t.title}</div><div style="font-size:0.8rem; color:#667781; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:140px;">${t.text}</div></div><i class="fas fa-pencil-alt wa-list-action-btn" title="Editar" onclick="event.stopPropagation(); msgManager.editTemplate(${t.id})"></i><i class="fas fa-trash wa-list-action-btn" title="Excluir" onclick="event.stopPropagation(); msgManager.deleteTemplate(${t.id})"></i></div>`; }); } },
            search: () => { msgManager.renderList(); },
            selectContact: (id) => { const contact = msgManager.contacts.find(c => c.id === id); if (contact) { msgManager.activeChatContact = contact; document.getElementById('wa-chat-name').innerText = contact.name; document.getElementById('wa-chat-phone').innerText = contact.phone || 'Sem telefone registrado'; document.getElementById('wa-view-chat').style.display = 'flex'; document.getElementById('wa-view-new-template').style.display = 'none'; msgManager.renderList(); } },
            openTemplateEditor: () => { document.getElementById('wa-view-chat').style.display = 'none'; document.getElementById('wa-view-new-template').style.display = 'flex'; document.getElementById('tpl-editor-title').innerText = "Novo Modelo"; document.getElementById('tpl-edit-id').value = ""; document.getElementById('tpl-new-title').value = ''; document.getElementById('tpl-new-text').value = ''; },
            editTemplate: (id) => { const t = msgManager.templates.find(x => x.id == id); if(!t) return; document.getElementById('wa-view-chat').style.display = 'none'; document.getElementById('wa-view-new-template').style.display = 'flex'; document.getElementById('tpl-editor-title').innerText = "Editar Modelo"; document.getElementById('tpl-edit-id').value = t.id; document.getElementById('tpl-new-title').value = t.title; document.getElementById('tpl-new-text').value = t.text; },
            cancelTemplateCreation: () => { document.getElementById('wa-view-chat').style.display = 'flex'; document.getElementById('wa-view-new-template').style.display = 'none'; },
            deleteTemplate: (id) => { if(confirm("Excluir este modelo?")) { msgManager.templates = msgManager.templates.filter(t => t.id != id); localStorage.setItem('waTemplates', JSON.stringify(msgManager.templates)); msgManager.renderList(); } },
            insertVar: (varName) => { const textarea = document.getElementById('tpl-new-text'); const tag = `[${varName}]`; const startPos = textarea.selectionStart; const endPos = textarea.selectionEnd; textarea.value = textarea.value.substring(0, startPos) + tag + textarea.value.substring(endPos, textarea.value.length); textarea.focus(); textarea.selectionStart = startPos + tag.length; textarea.selectionEnd = startPos + tag.length; },
            saveNewTemplate: () => { const id = document.getElementById('tpl-edit-id').value; const title = document.getElementById('tpl-new-title').value; const text = document.getElementById('tpl-new-text').value; if(!title || !text) return alert("Preencha título e conteúdo."); if(id) { const t = msgManager.templates.find(x => x.id == id); if(t) { t.title = title; t.text = text; } } else { msgManager.templates.push({ id: Date.now(), title, text }); } localStorage.setItem('waTemplates', JSON.stringify(msgManager.templates)); msgManager.cancelTemplateCreation(); msgManager.renderList(); },
            getNextEventData: async (contactId) => { if(!contactId) return null; const allEvents = await db.getAll('events'); const today = new Date().toISOString().split('T')[0]; const clientEvents = allEvents.filter(e => e.clientId == contactId && e.date >= today); clientEvents.sort((a, b) => { if (a.date === b.date) return a.time.localeCompare(b.time); return a.date.localeCompare(b.date); }); return clientEvents.length > 0 ? clientEvents[0] : null; },
            selectTemplate: async (id) => { const t = msgManager.templates.find(x => x.id == id); if(t) { let text = t.text; if (msgManager.activeChatContact) { text = text.replaceAll('[Nome]', msgManager.activeChatContact.name.split(' ')[0]); text = text.replaceAll('[Telefone]', msgManager.activeChatContact.phone || ''); text = text.replaceAll('[Empresa]', 'RC Sistemas'); const nextEvt = await msgManager.getNextEventData(msgManager.activeChatContact.id); if(nextEvt) { const dataFmt = new Date(nextEvt.date).toLocaleDateString('pt-BR'); text = text.replaceAll('[Data]', dataFmt); text = text.replaceAll('[Hora]', nextEvt.time); text = text.replaceAll('[Endereco]', nextEvt.address || 'Endereço não informado'); const total = parseFloat(nextEvt.valTotal || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2}); const sinal = parseFloat(nextEvt.valSignal || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2}); const rest = parseFloat(nextEvt.valRest || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2}); text = text.replaceAll('[Total]', total); text = text.replaceAll('[Sinal]', sinal); text = text.replaceAll('[Restante]', rest); } else { text = text.replaceAll('[Data]', '(Data?)'); text = text.replaceAll('[Hora]', '(Hora?)'); text = text.replaceAll('[Endereco]', '(Endereço?)'); text = text.replaceAll('[Total]', '0,00'); text = text.replaceAll('[Sinal]', '0,00'); text = text.replaceAll('[Restante]', '0,00'); } } document.getElementById('wa-input-msg').value = text; msgManager.checkInput(); document.getElementById('wa-view-chat').style.display = 'flex'; document.getElementById('wa-view-new-template').style.display = 'none'; } },
            checkInput: () => { const val = document.getElementById('wa-input-msg').value; const btn = document.getElementById('wa-btn-send'); if(val.trim().length > 0) btn.classList.add('ready'); else btn.classList.remove('ready'); },
            sendMessage: () => { const text = document.getElementById('wa-input-msg').value; if(!text) return; let phone = ""; if (msgManager.activeChatContact && msgManager.activeChatContact.phone) { phone = msgManager.activeChatContact.phone; } else { phone = prompt("Digite o número do WhatsApp:", ""); } if(phone) { const cleanPhone = phone.replace(/\D/g, ''); window.open(`https://wa.me/55${cleanPhone}?text=${encodeURIComponent(text)}`, '_blank'); const body = document.getElementById('wa-chat-body'); body.innerHTML += `<div class="wa-msg sent">${text}<span class="wa-msg-meta">${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} <i class="fas fa-check"></i></span></div>`; document.getElementById('wa-input-msg').value = ''; body.scrollTop = body.scrollHeight; } else { alert("Telefone inválido."); } }
        };

        // --- CALENDÁRIO MANAGER ---
        const calendarManager = {
            currentDate: new Date(), init: () => { calendarManager.render(); }, changeMonth: (delta) => { if (delta === 0) calendarManager.currentDate = new Date(); else calendarManager.currentDate.setMonth(calendarManager.currentDate.getMonth() + delta); calendarManager.render(); },
            render: async () => { const events = await db.getAll('events'); const types = await db.getAll('eventTypes'); const dt = calendarManager.currentDate; const year = dt.getFullYear(), month = dt.getMonth(); const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"]; document.getElementById('cal-month-year').innerText = `${monthNames[month]} ${year}`; const firstDay = new Date(year, month, 1); const lastDay = new Date(year, month + 1, 0); const startDayIndex = firstDay.getDay(); const totalDays = lastDay.getDate(); const prevMonthLastDay = new Date(year, month, 0).getDate(); let html = ''; for (let i = startDayIndex; i > 0; i--) html += `<div class="cal-cell other-month"><span class="cal-cell-num">${prevMonthLastDay - i + 1}</span></div>`; const today = new Date(); for (let i = 1; i <= totalDays; i++) { let isToday = (i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) ? 'today' : ''; const dayStr = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`; const dayEvents = events.filter(e => e.date === dayStr); let dotsHtml = ''; if(dayEvents.length > 0) { dotsHtml = '<div style="margin-top:5px;">'; dayEvents.forEach(e => { const t = types.find(x => x.id == e.typeId) || {color: '#ccc'}; dotsHtml += `<span class="cal-event-dot" style="background:${t.color}"></span>`; }); dotsHtml += '</div>'; } html += `<div class="cal-cell ${isToday}"><span class="cal-cell-num">${i}</span>${dotsHtml}</div>`; } const totalSlots = startDayIndex + totalDays; const remaining = 42 - totalSlots; if(remaining < 7) for(let j = 1; j <= remaining; j++) html += `<div class="cal-cell other-month"><span class="cal-cell-num">${j}</span></div>`; document.getElementById('calendar-grid').innerHTML = html; calendarManager.updateHomeWidget(events); },
            updateHomeWidget: (events) => { const widget = document.getElementById('home-agenda-widget'); const todayStr = new Date().toISOString().split('T')[0]; const upcoming = events.filter(e => e.date >= todayStr).sort((a,b) => a.date.localeCompare(b.date)).slice(0, 5); if(upcoming.length === 0) { widget.innerHTML = `<div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 150px; color: var(--text-muted); text-align: center;"><i class="far fa-calendar-check" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.3;"></i><p style="font-size: 0.9rem;">Tudo limpo por aqui.</p></div>`; } else { widget.innerHTML = ''; upcoming.forEach(e => { widget.innerHTML += `<div style="padding:10px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;"><div><div style="font-weight:600; font-size:0.9rem;">${e.title}</div><div style="font-size:0.75rem; color:#64748b;">${new Date(e.date).toLocaleDateString()} - ${e.time}</div></div><div style="font-size:0.8rem; background:#eff6ff; color:#2563eb; padding:2px 8px; border-radius:12px;">Agenda</div></div>`; }); } }
        };

        // --- OPORTUNIDADES MANAGER ---
        const oppManager = {
            opps: [],
            load: async () => { oppManager.opps = await db.getAll('opps'); oppManager.render(); },
            render: () => { const tbody = document.getElementById('opps-list'); tbody.innerHTML = ''; if(oppManager.opps.length === 0){ tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#64748b;">Nenhuma oportunidade registrada.</td></tr>'; return; } oppManager.opps.forEach(o => { const statusMap = { 'Prospect': 'Prospecção', 'Proposal': 'Proposta', 'Negotiation': 'Negociação', 'Closed': 'Fechado', 'Lost': 'Perdido' }; tbody.innerHTML += `<tr><td>${o.title}</td><td>${o.client}</td><td>R$ ${parseFloat(o.value).toFixed(2)}</td><td><span class="status-badge lead">${statusMap[o.status]}</span></td><td><button class="btn btn-sm btn-danger-outline" onclick="oppManager.del(${o.id})"><i class="fas fa-trash"></i></button></td></tr>`; }); },
            openModal: () => { document.getElementById('opp-modal').style.display = 'flex'; }, closeModal: () => { document.getElementById('opp-modal').style.display = 'none'; },
            save: async (e) => { e.preventDefault(); const newOpp = { id: Date.now(), title: document.getElementById('opp-title').value, client: document.getElementById('opp-client').value, value: document.getElementById('opp-value').value, status: document.getElementById('opp-status').value }; await db.put('opps', newOpp); oppManager.load(); oppManager.closeModal(); document.getElementById('opp-form').reset(); },
            del: async(id) => { if(confirm("Deseja excluir?")) { await db.delete('opps', id); oppManager.load(); } }
        };

        // --- ESTOQUE MANAGER ---
        const stockManager = {
            products: [],
            load: async () => { stockManager.products = await db.getAll('products'); stockManager.render(); stockManager.renderKPIs(); },
            render: () => { const tbody = document.getElementById('stock-list'); tbody.innerHTML = ''; const search = document.getElementById('stock-search').value.toLowerCase(); const filtered = stockManager.products.filter(p => p.name.toLowerCase().includes(search) || (p.sku && p.sku.toLowerCase().includes(search))); if(filtered.length === 0) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:#64748b;">Nenhum produto no estoque.</td></tr>'; return; } filtered.forEach(p => { const stock = parseInt(p.stock || 0); const min = parseInt(p.minStock || 0); let statusHtml = '<span class="status-badge active">OK</span>'; if(stock <= min) statusHtml = '<span class="status-badge pending">Baixo</span>'; if(stock === 0) statusHtml = '<span class="status-badge closed">Zerado</span>'; tbody.innerHTML += `<tr><td><strong>${p.name}</strong><br><small style="color:#94a3b8">${p.sku || '-'}</small></td><td>${p.category || 'Geral'}</td><td>${stock}</td><td>R$ ${parseFloat(p.price || 0).toFixed(2)}</td><td>${statusHtml}</td><td><button class="btn btn-sm btn-outline" onclick="stockManager.editProduct(${p.id})"><i class="fas fa-edit"></i></button> <button class="btn btn-sm btn-danger-outline" onclick="stockManager.deleteProduct(${p.id})"><i class="fas fa-trash"></i></button></td></tr>`; }); },
            renderKPIs: () => { const totalItems = stockManager.products.length; let lowStock = 0; let valuation = 0; stockManager.products.forEach(p => { if((p.stock || 0) <= (p.minStock || 0)) lowStock++; valuation += (p.stock || 0) * (p.cost || 0); }); document.getElementById('stk-total-count').innerText = totalItems; document.getElementById('stk-low-alert').innerText = lowStock; document.getElementById('stk-valuation').innerText = "R$ " + valuation.toFixed(2); },
            openProductModal: () => { document.getElementById('product-form').reset(); document.getElementById('prod-id').value = ''; document.getElementById('prod-modal-title').innerText = "Novo Produto"; document.getElementById('product-modal').style.display = 'flex'; },
            editProduct: (id) => { const p = stockManager.products.find(x => x.id === id); if(p) { document.getElementById('prod-id').value = p.id; document.getElementById('prod-name').value = p.name; document.getElementById('prod-sku').value = p.sku || ''; document.getElementById('prod-category').value = p.category || ''; document.getElementById('prod-cost').value = p.cost || ''; document.getElementById('prod-price').value = p.price || ''; document.getElementById('prod-min').value = p.minStock || 5; document.getElementById('prod-supplier').value = p.supplier || ''; document.getElementById('prod-desc').value = p.description || ''; document.getElementById('prod-modal-title').innerText = "Editar Produto"; document.getElementById('product-modal').style.display = 'flex'; } },
            saveProduct: async (e) => { e.preventDefault(); const id = document.getElementById('prod-id').value; let product = {}; if(id) { const old = stockManager.products.find(x => x.id == id); product = { ...old }; } else { product = { id: Date.now(), stock: 0 }; } product.name = document.getElementById('prod-name').value; product.sku = document.getElementById('prod-sku').value; product.category = document.getElementById('prod-category').value; product.cost = parseFloat(document.getElementById('prod-cost').value || 0); product.price = parseFloat(document.getElementById('prod-price').value || 0); product.minStock = parseInt(document.getElementById('prod-min').value || 5); product.supplier = document.getElementById('prod-supplier').value; product.description = document.getElementById('prod-desc').value; await db.put('products', product); document.getElementById('product-modal').style.display = 'none'; stockManager.load(); },
            deleteProduct: async (id) => { if(confirm("Tem certeza que deseja excluir este produto?")) { await db.delete('products', id); stockManager.load(); } },
            openMovementModal: () => { const select = document.getElementById('mov-product'); select.innerHTML = '<option value="">Selecione...</option>'; stockManager.products.forEach(p => { select.innerHTML += `<option value="${p.id}">${p.name}</option>`; }); document.getElementById('movement-form').reset(); document.getElementById('mov-current-stock-display').innerText = 'Saldo Atual: -'; document.getElementById('movement-modal').style.display = 'flex'; },
            updateCurrentStockDisplay: () => { const id = document.getElementById('mov-product').value; if(id) { const p = stockManager.products.find(x => x.id == id); document.getElementById('mov-current-stock-display').innerText = `Saldo Atual: ${p.stock}`; } else { document.getElementById('mov-current-stock-display').innerText = 'Saldo Atual: -'; } },
            saveMovement: async (e) => { e.preventDefault(); const prodId = parseInt(document.getElementById('mov-product').value); const type = document.getElementById('mov-type').value; const qty = parseInt(document.getElementById('mov-qty').value); const reason = document.getElementById('mov-reason').value; if(!prodId) return; const product = stockManager.products.find(x => x.id === prodId); let newStock = parseInt(product.stock || 0); if(type === 'entry') newStock += qty; if(type === 'exit') newStock -= qty; if(type === 'adjust') newStock = qty; product.stock = newStock; await db.put('products', product); const movement = { id: Date.now(), productId: prodId, type: type, qty: qty, reason: reason, date: new Date(), stockAfter: newStock }; await db.put('movements', movement); document.getElementById('movement-modal').style.display = 'none'; stockManager.load(); }
        };

        // --- CONTACT MANAGER ---
        const contactManager = {
            contacts: [],
            load: async () => { contactManager.contacts = await db.getAll('contacts'); contactManager.render(contactManager.contacts); },
            render: (list) => { const tbody = document.getElementById('contacts-list'); tbody.innerHTML = ''; if(list.length === 0) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px;">Nenhum contato encontrado.</td></tr>'; return; } list.sort((a,b) => b.id - a.id).forEach(c => { const tr = document.createElement('tr'); const badgeClass = c.status === 'Ativo' ? 'active' : (c.status === 'Negociacao' ? 'lead' : 'pending'); tr.innerHTML = `<td><strong>${c.name}</strong><br><small style="color:#64748b">${c.email || ''}</small></td><td>${c.type}</td><td>${c.phone || '-'}</td><td><span class="status-badge ${badgeClass}">${c.status}</span></td><td><button class="btn btn-sm btn-outline" onclick="contactManager.edit(${c.id})"><i class="fas fa-edit"></i></button> <button class="btn btn-sm btn-danger-outline" onclick="contactManager.del(${c.id})"><i class="fas fa-trash"></i></button></td>`; tbody.appendChild(tr); }); },
            search: () => { const term = document.getElementById('searchContact').value.toLowerCase(); const type = document.getElementById('filterType').value; const filtered = contactManager.contacts.filter(c => { return (c.name.toLowerCase().includes(term) || (c.phone && c.phone.includes(term))) && (type ? c.type === type : true); }); contactManager.render(filtered); },
            switchTab: (tabName) => { document.querySelectorAll('.modal-tab-btn').forEach(btn => btn.classList.remove('active')); event.currentTarget.classList.add('active'); document.querySelectorAll('.inner-tab').forEach(tab => tab.classList.remove('active')); document.getElementById(`modal-tab-${tabName}`).classList.add('active'); },
            openModal: (isEdit = false) => { document.getElementById('contact-modal').style.display = 'flex'; document.getElementById('header-name').innerText = "Novo Contato"; document.getElementById('header-id').innerText = "ID: #NOVO"; document.getElementById('header-avatar').innerHTML = '<i class="fas fa-user"></i>'; document.querySelectorAll('.modal-tab-btn').forEach(b => b.classList.remove('active')); document.querySelectorAll('.inner-tab').forEach(t => t.classList.remove('active')); document.querySelector('.modal-tab-btn').classList.add('active'); document.getElementById('modal-tab-basic').classList.add('active'); if(!isEdit) { document.getElementById('contact-form').reset(); document.getElementById('c-id').value = ''; document.getElementById('c-timeline-display').innerHTML = '<p style="color:#94a3b8; font-size:0.85rem;">Salve o contato para iniciar o histórico.</p>'; document.getElementById('timeline-controls').style.display = 'none'; } },
            closeModal: () => { document.getElementById('contact-modal').style.display = 'none'; },
            save: async (e) => { e.preventDefault(); const id = document.getElementById('c-id').value; let existingData = {}; if(id) existingData = contactManager.contacts.find(c => c.id == id) || {}; const contact = { id: id ? parseInt(id) : Date.now(), name: document.getElementById('c-name').value, cpf: document.getElementById('c-cpf').value, job: document.getElementById('c-job').value, type: document.getElementById('c-type').value, status: document.getElementById('c-status').value, phone: document.getElementById('c-phone').value, email: document.getElementById('c-email').value, cep: document.getElementById('c-cep').value, city: document.getElementById('c-city').value, address: document.getElementById('c-address').value, number: document.getElementById('c-number').value, district: document.getElementById('c-district').value, complement: document.getElementById('c-complement').value, insta: document.getElementById('c-insta').value, social2: document.getElementById('c-social2').value, birth: document.getElementById('c-birth').value, source: document.getElementById('c-source').value, notes: document.getElementById('c-notes').value, timeline: existingData.timeline || [] }; if(!id) contact.timeline.push({ date: new Date(), type: 'note', text: "Cadastro criado no sistema." }); await db.put('contacts', contact); contactManager.closeModal(); contactManager.load(); },
            edit: (id) => { const c = contactManager.contacts.find(x => x.id === id); if(c) { contactManager.openModal(true); document.getElementById('header-name').innerText = c.name; document.getElementById('header-id').innerText = "ID: #" + c.id; document.getElementById('c-id').value = c.id; document.getElementById('c-name').value = c.name; document.getElementById('c-cpf').value = c.cpf || ''; document.getElementById('c-job').value = c.job || ''; document.getElementById('c-type').value = c.type; document.getElementById('c-status').value = c.status; document.getElementById('c-phone').value = c.phone; document.getElementById('c-email').value = c.email; document.getElementById('c-cep').value = c.cep || ''; document.getElementById('c-city').value = c.city || ''; document.getElementById('c-address').value = c.address || ''; document.getElementById('c-number').value = c.number || ''; document.getElementById('c-district').value = c.district || ''; document.getElementById('c-complement').value = c.complement || ''; document.getElementById('c-insta').value = c.insta || ''; document.getElementById('c-social2').value = c.social2 || ''; document.getElementById('c-birth').value = c.birth || ''; document.getElementById('c-source').value = c.source || 'Outro'; document.getElementById('c-notes').value = c.notes || ''; document.getElementById('timeline-controls').style.display = 'block'; contactManager.renderTimeline(c.timeline || []); } },
            renderTimeline: (timeline) => { const tArea = document.getElementById('c-timeline-display'); tArea.innerHTML = ''; if(!timeline || timeline.length === 0) { tArea.innerHTML = '<p style="color:#94a3b8; font-size:0.85rem;">Nenhuma interação registrada ainda.</p>'; return; } const icons = { 'call': 'fa-phone', 'whatsapp': 'fab fa-whatsapp', 'meeting': 'fa-handshake', 'email': 'fa-envelope', 'note': 'fa-sticky-note' }; const classes = { 'call': 't-call', 'whatsapp': 't-whatsapp', 'meeting': 't-meeting', 'email': 't-email', 'note': 't-note' }; [...timeline].sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(t => { const iconClass = icons[t.type] || icons['note']; const colorClass = classes[t.type] || classes['note']; const dateStr = new Date(t.date).toLocaleDateString(); tArea.innerHTML += `<div class="timeline-item"><div class="timeline-icon ${colorClass}"><i class="${iconClass}"></i></div><div class="timeline-header"><span class="timeline-type">${t.type || 'Nota'}</span><span class="timeline-date">${dateStr}</span></div><div class="timeline-content">${t.text}</div></div>`; }); },
            addTimeline: async () => { const text = document.getElementById('new-note').value; const type = document.getElementById('note-type').value; const id = parseInt(document.getElementById('c-id').value); if(text && id) { const c = contactManager.contacts.find(x => x.id === id); if(!c.timeline) c.timeline = []; c.timeline.push({ date: new Date(), type: type, text: text }); await db.put('contacts', c); document.getElementById('new-note').value = ''; contactManager.renderTimeline(c.timeline); contactManager.load(); } },
            del: async (id) => { if(confirm('Tem certeza?')) { await db.delete('contacts', id); contactManager.load(); } }
        };

        // =========================================================================
        // ALBUM & WORKFLOW MANAGER
        // =========================================================================
        const albumManager = {
            albums: [],
            types: [],
            
            init: async () => {
                const savedTypes = localStorage.getItem('projectTypes');
                if(savedTypes) {
                    albumManager.types = JSON.parse(savedTypes);
                } else {
                    albumManager.types = [
                        { id: 1, name: 'Álbum de Casamento', stages: ['Seleção', 'Edição', 'Diagramação', 'Aprovação', 'Impressão', 'Entregue'] },
                        { id: 2, name: 'Ensaio Fotográfico', stages: ['Agendado', 'Realizado', 'Edição', 'Galeria Online', 'Finalizado'] }
                    ];
                    localStorage.setItem('projectTypes', JSON.stringify(albumManager.types));
                }
            },

            load: async () => {
                await albumManager.init();
                albumManager.albums = await db.getAll('albums');
                
                const container = document.getElementById('albums-container'); 
                container.innerHTML = '';
                
                if(albumManager.albums.length === 0) { 
                    container.innerHTML = '<p style="text-align:center; color:#64748b; grid-column: 1/-1; padding: 40px;">Nenhum projeto em andamento. Inicie um novo clicando no botão acima.</p>'; 
                    return; 
                }

                albumManager.albums.forEach(a => {
                    const type = albumManager.types.find(t => t.id == a.typeId);
                    const stages = type ? type.stages : (a.stages || ['Início', 'Fim']);
                    const currentStageIdx = parseInt(a.currentStageIdx || 0);
                    const totalStages = stages.length;
                    const progressPct = Math.min(Math.round(((currentStageIdx + 1) / totalStages) * 100), 100);
                    const isFinished = currentStageIdx >= totalStages - 1;

                    // Design Premium Enterprise Card
                    const html = `
                    <div class="project-card-premium">
                        <div class="pcp-stripe"></div>
                        <div class="pcp-header">
                            <div class="pcp-info">
                                <h4>${a.name}</h4>
                                <div class="pcp-client"><i class="fas fa-user-circle"></i> ${a.clientName}</div>
                            </div>
                            <div class="pcp-actions">
                                <div class="pcp-btn-action" onclick="albumManager.edit('${a.id}')" title="Editar"><i class="fas fa-pencil-alt"></i></div>
                                <div class="pcp-btn-action delete" onclick="albumManager.delete('${a.id}')" title="Excluir"><i class="fas fa-trash-alt"></i></div>
                            </div>
                        </div>
                        <div class="pcp-body">
                            <div class="pcp-stage-info">
                                <span class="pcp-stage-label">Etapa Atual</span>
                                <span class="pcp-stage-current">${stages[currentStageIdx]}</span>
                            </div>
                            <div class="pcp-progress-track">
                                <div class="pcp-progress-fill" style="width: ${progressPct}%"></div>
                            </div>
                        </div>
                        <div class="pcp-footer">
                            <div class="pcp-date"><i class="far fa-clock"></i> ID: #${a.id}</div>
                             ${isFinished ? 
                                '<span class="status-badge active"><i class="fas fa-check"></i> Concluído</span>' : 
                                `<button class="pcp-btn-advance" onclick="albumManager.nextStage('${a.id}')">Avançar <i class="fas fa-chevron-right"></i></button>`
                             }
                        </div>
                    </div>
                    `;
                    container.insertAdjacentHTML('beforeend', html);
                });
            },

            openConfig: () => {
                document.getElementById('album-modal').style.display = 'flex';
                document.getElementById('alb-modal-subtitle').innerText = "Configuração de Tipos e Workflows";
                document.getElementById('alb-view-config').style.display = 'block';
                document.getElementById('alb-view-project').style.display = 'none';
                albumManager.renderTypesList();
            },

            openModal: async (editId = null) => {
                document.getElementById('album-modal').style.display = 'flex';
                document.getElementById('alb-modal-subtitle').innerText = editId ? "Editar Projeto" : "Novo Projeto";
                document.getElementById('alb-view-config').style.display = 'none';
                document.getElementById('alb-view-project').style.display = 'block';
                document.getElementById('album-form').reset();
                
                const clients = await db.getAll('contacts');
                const clientSel = document.getElementById('alb-client-select');
                clientSel.innerHTML = '<option value="">Selecione o Cliente...</option>';
                clients.forEach(c => clientSel.innerHTML += `<option value="${c.name}">${c.name}</option>`);

                const typeSel = document.getElementById('alb-type-select');
                typeSel.innerHTML = '';
                albumManager.types.forEach(t => typeSel.innerHTML += `<option value="${t.id}">${t.name}</option>`);
                
                if(editId) {
                    const a = albumManager.albums.find(x => x.id == editId);
                    document.getElementById('alb-id').value = a.id;
                    document.getElementById('alb-name').value = a.name;
                    document.getElementById('alb-client-select').value = a.clientName;
                    document.getElementById('alb-type-select').value = a.typeId;
                    albumManager.renderProjectTimelinePreview(a.typeId, a.currentStageIdx);
                } else {
                    document.getElementById('alb-id').value = '';
                    albumManager.updateStagesPreview();
                }
            },

            renderTypesList: () => {
                const container = document.getElementById('alb-types-list');
                container.innerHTML = '';
                albumManager.types.forEach(t => {
                    const div = document.createElement('div');
                    div.className = 'type-card';
                    div.innerHTML = `
                        <div class="type-icon"><i class="fas fa-stream"></i></div>
                        <div class="type-info">
                            <h4>${t.name}</h4>
                            <p>${t.stages.length} etapas definidas</p>
                        </div>
                    `;
                    div.onclick = () => albumManager.selectTypeConfig(t.id, div);
                    container.appendChild(div);
                });
            },

            newType: () => {
                const name = prompt("Nome do novo tipo de projeto:");
                if(!name) return;
                const newId = Date.now();
                albumManager.types.push({ id: newId, name: name, stages: ['Início', 'Conclusão'] });
                localStorage.setItem('projectTypes', JSON.stringify(albumManager.types));
                albumManager.renderTypesList();
            },

            selectTypeConfig: (id, el) => {
                document.querySelectorAll('.type-card').forEach(c => c.classList.remove('selected'));
                el.classList.add('selected');

                const type = albumManager.types.find(t => t.id == id);
                const content = document.getElementById('alb-config-content');
                
                let stagesHtml = '';
                type.stages.forEach((stage, idx) => {
                    stagesHtml += `
                        <li class="step-item-edit">
                            <div class="step-num-badge">${idx+1}</div>
                            <div class="step-content-edit">
                                <input type="text" value="${stage}" onchange="albumManager.updateStageName(${id}, ${idx}, this.value)">
                            </div>
                            <button class="btn btn-sm btn-danger-outline" onclick="albumManager.removeStage(${id}, ${idx})"><i class="fas fa-times"></i></button>
                        </li>
                    `;
                });

                content.innerHTML = `
                    <div style="padding:20px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:20px; border-bottom:1px solid #e2e8f0; padding-bottom:10px;">
                            <h3>${type.name}</h3>
                            <button class="btn btn-sm btn-danger-outline" onclick="albumManager.deleteType(${id})">Excluir Tipo</button>
                        </div>
                        <h4 style="margin-bottom:15px; font-size:0.9rem; color:#64748b;">Etapas do Workflow</h4>
                        <ul class="step-list-editable" id="stage-list-ul">
                            ${stagesHtml}
                        </ul>
                        <button class="btn btn-outline btn-sm" style="margin-top:15px; width:100%;" onclick="albumManager.addStage(${id})">+ Adicionar Etapa</button>
                    </div>
                `;
            },

            updateStageName: (typeId, stageIdx, newVal) => {
                const type = albumManager.types.find(t => t.id == typeId);
                type.stages[stageIdx] = newVal;
                localStorage.setItem('projectTypes', JSON.stringify(albumManager.types));
            },

            addStage: (typeId) => {
                const type = albumManager.types.find(t => t.id == typeId);
                type.stages.push("Nova Etapa");
                localStorage.setItem('projectTypes', JSON.stringify(albumManager.types));
                const selectedEl = document.querySelector('.type-card.selected');
                if(selectedEl) albumManager.selectTypeConfig(typeId, selectedEl);
            },

            removeStage: (typeId, stageIdx) => {
                const type = albumManager.types.find(t => t.id == typeId);
                if(type.stages.length <= 1) return alert("O workflow deve ter pelo menos 1 etapa.");
                type.stages.splice(stageIdx, 1);
                localStorage.setItem('projectTypes', JSON.stringify(albumManager.types));
                const selectedEl = document.querySelector('.type-card.selected');
                if(selectedEl) albumManager.selectTypeConfig(typeId, selectedEl);
            },

            deleteType: (id) => {
                if(confirm("Excluir este tipo de projeto?")) {
                    albumManager.types = albumManager.types.filter(t => t.id != id);
                    localStorage.setItem('projectTypes', JSON.stringify(albumManager.types));
                    albumManager.renderTypesList();
                    document.getElementById('alb-config-content').innerHTML = '';
                }
            },

            updateStagesPreview: () => {
                const typeId = document.getElementById('alb-type-select').value;
                albumManager.renderProjectTimelinePreview(typeId, 0);
            },

            renderProjectTimelinePreview: (typeId, currentIdx) => {
                const type = albumManager.types.find(t => t.id == typeId);
                const container = document.getElementById('alb-timeline-preview');
                container.innerHTML = '';
                
                if(!type) return;

                type.stages.forEach((stage, idx) => {
                    const isCompleted = idx < currentIdx;
                    const isActive = idx === parseInt(currentIdx);
                    
                    let statusClass = '';
                    if(isCompleted) statusClass = 'completed';
                    if(isActive) statusClass = 'active';

                    container.innerHTML += `
                        <div class="prj-event ${statusClass}">
                            <div class="prj-dot">${idx + 1}</div>
                            <div class="prj-card">
                                <div class="prj-info">
                                    <h4>${stage}</h4>
                                    <p>${isActive ? 'Etapa Atual' : (isCompleted ? 'Concluído' : 'Aguardando')}</p>
                                </div>
                                ${isActive ? `<button type="button" class="prj-action-btn" onclick="albumManager.setStageManually(${idx})">Atual</button>` : ''}
                                ${!isActive && !isCompleted ? `<button type="button" class="btn-clean" onclick="albumManager.setStageManually(${idx})"><i class="fas fa-check"></i> Definir aqui</button>` : ''}
                            </div>
                        </div>
                    `;
                });
            },

            setStageManually: (idx) => {
                const typeId = document.getElementById('alb-type-select').value;
                albumManager.tempStageIdx = idx;
                albumManager.renderProjectTimelinePreview(typeId, idx);
            },

            saveMainForm: async () => {
                if(document.getElementById('alb-view-config').style.display === 'block') {
                    document.getElementById('album-modal').style.display = 'none';
                    return;
                }

                const id = document.getElementById('alb-id').value;
                const typeId = document.getElementById('alb-type-select').value;
                const currentIdx = albumManager.tempStageIdx !== undefined ? albumManager.tempStageIdx : 0; 

                let finalIdx = currentIdx;
                if(id && albumManager.tempStageIdx === undefined) {
                    const existing = albumManager.albums.find(a => a.id == id);
                    if(existing) finalIdx = existing.currentStageIdx;
                }

                const project = {
                    id: id ? id : Date.now().toString(),
                    name: document.getElementById('alb-name').value,
                    clientName: document.getElementById('alb-client-select').value,
                    typeId: typeId,
                    currentStageIdx: finalIdx,
                    stages: albumManager.types.find(t => t.id == typeId).stages
                };

                await db.put('albums', project);
                albumManager.tempStageIdx = undefined;
                document.getElementById('album-modal').style.display = 'none';
                albumManager.load();
            },

            edit: (id) => {
                albumManager.openModal(id);
            },
            
            delete: async (id) => {
                if(confirm("Deseja realmente excluir este projeto?")) {
                    await db.delete('albums', id);
                    albumManager.load();
                }
            },

            nextStage: async (id) => {
                const project = albumManager.albums.find(a => a.id == id);
                const type = albumManager.types.find(t => t.id == project.typeId);
                const stages = type ? type.stages : project.stages;

                if(project.currentStageIdx < stages.length - 1) {
                    project.currentStageIdx++;
                    await db.put('albums', project);
                    albumManager.load();
                } else {
                    alert("Projeto já concluído!");
                }
            }
        };

      // ===============================
// APP INIT
// ===============================
const app = {
    initialized: false,

    async init() {
        this.initClock();

        await db.connect();

        // Configurações globais
        globalConfig.load();

        // Módulos
        contactManager.load();

        await albumManager.init();
        albumManager.load();

        await agendaManager.init();
        calendarManager.init();

        oppManager.load();
        stockManager.load();
        msgManager.init();

        dashboardManager.init();

        this.initialized = true;
    },

    initClock() {
        setInterval(() => {
            const now = new Date();

            document.getElementById('clock').innerText =
                now.toLocaleTimeString([], {
                    hour: '2-digit',
                    minute: '2-digit'
                });

            document.getElementById('date-display').innerText =
                now.toLocaleDateString('pt-BR', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
        }, 1000);
    },

    nav(tabId) {
        document
            .querySelectorAll('.tab-content')
            .forEach(t => t.classList.remove('active'));

        document
            .querySelectorAll('nav button')
            .forEach(b => b.classList.remove('active'));

        document.getElementById(`tab-${tabId}`).classList.add('active');
        event.currentTarget.classList.add('active');

        switch (tabId) {
            case 'contacts':
                contactManager.load();
                break;

            case 'management':
                albumManager.load();
                break;

            case 'agenda':
                agendaManager.render();
                break;

            case 'home':
                calendarManager.render();
                dashboardManager.applySettings();
                break;
        }
    }
};

// Inicialização controlada pelo authManager
// window.onload = app.init;

/* ===============================
   CONFIGURAÇÕES GLOBAIS DO SISTEMA
================================ */

const globalConfig = {
    defaults: {
        primary: '#2563eb',
        secondary: '#22c55e',
        font: '16',
        theme: 'light'
    },

    load() {
        const cfg = JSON.parse(localStorage.getItem('rc_global_config')) || this.defaults;

        document.documentElement.style.setProperty('--primary-color', cfg.primary);
        document.documentElement.style.setProperty('--secondary-color', cfg.secondary);
        document.documentElement.style.fontSize = cfg.font + 'px';

        if (cfg.theme === 'dark') {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }

        document.getElementById('cfg-primary').value = cfg.primary;
        document.getElementById('cfg-secondary').value = cfg.secondary;
        document.getElementById('cfg-font').value = cfg.font;
        document.getElementById('cfg-theme').value = cfg.theme;
    },

    save() {
        const cfg = {
            primary: document.getElementById('cfg-primary').value,
            secondary: document.getElementById('cfg-secondary').value,
            font: document.getElementById('cfg-font').value,
            theme: document.getElementById('cfg-theme').value
        };

        localStorage.setItem('rc_global_config', JSON.stringify(cfg));
        this.load();

        alert('✔️ Configurações globais salvas com sucesso!');
    }
};

function toggleMobileMenu() {
    const sidebar = document.querySelector('aside');
    const overlay = document.getElementById('mobile-overlay');
    const trigger = document.getElementById('mobile-menu-trigger');

    const isOpen = sidebar.classList.contains('open');

    if (isOpen) {
        sidebar.classList.remove('open');
        overlay.style.display = 'none';
        document.body.style.overflow = '';
        trigger.style.transform = 'rotate(0deg)';
    } else {
        sidebar.classList.add('open');
        overlay.style.display = 'block';
        document.body.style.overflow = 'hidden';
        trigger.style.transform = 'rotate(90deg)';
    }
}

function showSection(sectionId) {
    // Exemplo básico de feedback na Tab Bar
    document.querySelectorAll('.tab-item')
        .forEach(i => i.classList.remove('active'));

    event.currentTarget.classList.add('active');
}

// Ajuste fino para evitar que o menu lateral do desktop interfira no mobile no carregamento
window.addEventListener('resize', () => {
    if (window.innerWidth > 768) {
        const aside = document.querySelector('aside');
        if (aside) aside.classList.remove('open');

        const overlay = document.getElementById('mobile-overlay');
        if (overlay) overlay.style.display = 'none';

        document.body.style.overflow = '';
    }
});
</script>
<script>

(function () {

    const SYNC_TABLE = 'lg_crm_supadb';
    const CANONICAL_DB = 'lg_crmDB';
  
    let storedId = sessionStorage.getItem('sync_device_id');
    if (!storedId) {
        storedId = crypto.randomUUID();
        sessionStorage.setItem('sync_device_id', storedId);
    }
    const DEVICE_ID = storedId;
    
    let isReplicating = false; 
    let syncInterval = null;

  
    const syncCache = new Map();

    const getClient = () => window.supabaseClient || window.supabase;

    const waitForSupabase = () => new Promise(resolve => {
        const check = () => getClient() ? resolve(getClient()) : setTimeout(check, 100);
        check();
    });

    async function getUserId() {
        const client = await waitForSupabase();
        const { data } = await client.auth.getSession();
        return data?.session?.user?.id || null;
    }

    function generateSignature(value) {
        // Garante que null/undefined sejam tratados iguais
        if (value === null || value === undefined) return 'null';
        return JSON.stringify(value);
    }

    const original = {
        put: IDBObjectStore.prototype.put,
        add: IDBObjectStore.prototype.add,
        delete: IDBObjectStore.prototype.delete
    };

    async function scheduleRealtimeUpload(storeName, method, key, value) {
        if (isReplicating) return; 

        const client = getClient();
        const userId = await getUserId();
        if (!client || !userId) return;

        const cacheKey = `${storeName}-${key}`;
        
        // Atualiza cache local imediatamente
        if (method === 'delete') {
            syncCache.delete(cacheKey);
        } else {
            syncCache.set(cacheKey, generateSignature(value));
        }

        client.from(SYNC_TABLE).upsert({
            user_id: userId,
            db_name: CANONICAL_DB,
            store_name: storeName,
            record_key: String(key),
            record_value: method === 'delete' ? null : value,
            is_deleted: method === 'delete',
            device_id: DEVICE_ID,
            updated_at: new Date().toISOString()
        }, { onConflict: 'user_id,db_name,store_name,record_key' })
        .then(({ error }) => {
            if (error) console.warn(`⚠️ Sync Upload Falhou:`, error.message);
        });
    }

    IDBObjectStore.prototype.put = function (v, k) {
        const req = original.put.apply(this, arguments);
        const storeName = this.name;
        req.onsuccess = (e) => scheduleRealtimeUpload(storeName, 'put', k || e.target.result, v);
        return req;
    };

    IDBObjectStore.prototype.add = function (v, k) {
        const req = original.add.apply(this, arguments);
        const storeName = this.name;
        req.onsuccess = (e) => scheduleRealtimeUpload(storeName, 'add', k || e.target.result, v);
        return req;
    };

    IDBObjectStore.prototype.delete = function (k) {
        const req = original.delete.apply(this, arguments);
        const storeName = this.name;
        req.onsuccess = (e) => scheduleRealtimeUpload(storeName, 'delete', k, null);
        return req;
    };

    console.log(' .)');

    async function smartUploadLoop() {
        const userId = await getUserId();
        const client = getClient();
        if (!userId || !client) return;

        const req = indexedDB.open(CANONICAL_DB);
        
        req.onsuccess = (e) => {
            const db = e.target.result;
            const storeNames = Array.from(db.objectStoreNames);

            storeNames.forEach(storeName => {
                const tx = db.transaction([storeName], 'readonly');
                const store = tx.objectStore(storeName);
                
                Promise.all([
                    new Promise(r => store.getAll().onsuccess = (ev) => r(ev.target.result)),
                    new Promise(r => store.getAllKeys().onsuccess = (ev) => r(ev.target.result))
                ]).then(async ([records, keys]) => {
                    if (!records.length) return;

                    const changedRecords = [];

                    records.forEach((item, index) => {
                        const key = String(keys[index]);
                        const cacheKey = `${storeName}-${key}`;
                        const currentSig = generateSignature(item);

                       
                        if (syncCache.get(cacheKey) !== currentSig) {
                            changedRecords.push({
                                user_id: userId,
                                db_name: CANONICAL_DB,
                                store_name: storeName,
                                record_key: key,
                                record_value: item,
                                is_deleted: false,
                                device_id: DEVICE_ID,
                                updated_at: new Date().toISOString()
                            });
                            syncCache.set(cacheKey, currentSig);
                        }
                    });

                    if (changedRecords.length > 0) {
                        console.log(`.: ${changedRecords.length} itens`);
                        await client.from(SYNC_TABLE).upsert(changedRecords, { 
                            onConflict: 'user_id,db_name,store_name,record_key' 
                        });
                    }
                });
            });
        };
    }

    async function smartDownloadLoop() {
        const userId = await getUserId();
        const client = getClient();
        if (!userId || !client) return;

        const { data, error } = await client
            .from(SYNC_TABLE)
            .select('*')
            .eq('user_id', userId)
            .eq('db_name', CANONICAL_DB);

        if (error || !data || !data.length) return;

        const req = indexedDB.open(CANONICAL_DB);
        req.onsuccess = (e) => {
            const db = e.target.result;
            const localStores = Array.from(db.objectStoreNames);
            
            const validRecords = data.filter(r => localStores.includes(r.store_name));
            if (!validRecords.length) return;

            const tx = db.transaction([...new Set(validRecords.map(r => r.store_name))], 'readwrite');
            isReplicating = true;

            let writes = 0;

            validRecords.forEach(r => {
               
                if (r.device_id === DEVICE_ID) return;

                const store = tx.objectStore(r.store_name);
               
                const key = !isNaN(r.record_key) ? Number(r.record_key) : r.record_key;
                const cacheKey = `${r.store_name}-${r.record_key}`;
                
                
                if (r.is_deleted) {
                   
                    store.delete(key);
                    
                    if (syncCache.has(cacheKey)) {
                        syncCache.delete(cacheKey);
                        writes++;
                    }
                    return;
                }

                
                const incomingSig = generateSignature(r.record_value);
                const localSig = syncCache.get(cacheKey);

                if (incomingSig === localSig) {
                    return; 
                }

                
                const val = r.record_value;
                if (store.keyPath && val && typeof val === 'object') {
                    // Se a store usa keyPath inline, injetamos a chave se necessário
                    if (!val[store.keyPath]) val[store.keyPath] = key;
                    store.put(val);
                } else {
                    store.put(val, key);
                }
                
                syncCache.set(cacheKey, incomingSig);
                writes++;
            });

            tx.oncomplete = () => {
                isReplicating = false;
                if (writes > 0) console.log(`📥 Download Sync: ${writes} alterações aplicadas.`);
            };
            
            tx.onerror = () => isReplicating = false;
        };
    }

       async function startService() {
        const userId = await getUserId();
        if (!userId) return;

        console.log('. ', userId);
        const client = getClient();

        client.channel('global-sync-live')
            .on('postgres_changes', { 
                event: '*', schema: 'public', table: SYNC_TABLE, filter: `user_id=eq.${userId}` 
            }, payload => {
                // Só dispara download se o evento veio de OUTRO device
                if (payload.new && payload.new.device_id !== DEVICE_ID) {
                    smartDownloadLoop();
                }
            })
            .subscribe();

      
        await smartUploadLoop(); 
        setTimeout(smartDownloadLoop, 500); // Pequeno delay para garantir que o Upload populou o cache

        if (syncInterval) clearInterval(syncInterval);
        syncInterval = setInterval(async () => {
            await smartUploadLoop();
            await smartDownloadLoop();
        }, 10000);
    }

    waitForSupabase().then(client => {
        client.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN' && session) startService();
        });
        getUserId().then(id => { if (id) startService(); });
    });

})();
</script>

</body>
</html>
