<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legacy CRM - Enterprise Suite</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
 
    <style>
        :root {
            /* Enterprise Palette - Dark Blue Theme */
            --primary: #2563eb;       
            --primary-dark: #1e40af;
            --primary-light: #eff6ff;
            
            --secondary: #475569;     
            --surface-100: #ffffff;
            --surface-200: #f1f5f9;
            --surface-300: #e2e8f0;
            
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #cbd5e1;
            
            --success: #16a34a;
            --success-bg: #dcfce7;
            --danger: #dc2626;
            --danger-bg: #fee2e2;
            --warning: #ca8a04;
            --warning-bg: #fef9c3;

            /* UI Constants */
            --sidebar-width: 280px;
            --header-height: 70px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-modal: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; outline: none; }
        
        body { 
            background-color: var(--surface-200); 
            color: var(--text-main); 
            height: 100vh; 
            display: flex; 
            overflow: hidden; 
        }

        /* --- Auth States Handling --- */
        /* Se estiver assinando (publico), esconde login e app principal */
        body.signing-mode #login-overlay,
        body.signing-mode #intro-overlay,
        body.signing-mode aside,
        body.signing-mode main { display: none !important; }
        
        body.signing-mode #signing-page-overlay { display: block !important; }

        /* Estados Normais de Autenticação */
        body.not-authenticated main, 
        body.not-authenticated aside,
        body.not-authenticated #intro-overlay { display: none !important; }
        
        body.authenticated #login-overlay { display: none; }

        /* --- Login Moderno --- */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #0f172a;
            display: flex; align-items: center; justify-content: center; z-index: 10000;
            background-image: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
        }
        .login-card {
            background: white; width: 100%; max-width: 400px; padding: 40px;
            border-radius: var(--radius-lg); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            animation: slideUp 0.5s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* --- Sidebar & Layout --- */
        aside {
            width: var(--sidebar-width); background: #0f172a; color: white;
            display: flex; flex-direction: column; z-index: 20;
            box-shadow: 4px 0 24px rgba(0,0,0,0.1);
        }
        .brand {
            height: var(--header-height); display: flex; align-items: center; padding: 0 24px;
            font-size: 1.25rem; font-weight: 700; color: white; border-bottom: 1px solid rgba(255,255,255,0.1);
            gap: 12px;
        }
        .brand i { color: var(--primary); }

        .nav-menu { padding: 20px 16px; flex: 1; display: flex; flex-direction: column; gap: 4px; }
        .nav-btn {
            width: 100%; padding: 12px 16px; background: transparent; border: none;
            color: #94a3b8; text-align: left; cursor: pointer; font-size: 0.9rem; font-weight: 500;
            display: flex; align-items: center; gap: 12px; border-radius: var(--radius-md);
            transition: all 0.2s;
        }
        .nav-btn:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(37,99,235,0.3); }

        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: var(--surface-200); }

        /* --- Header & Views --- */
        header {
            height: var(--header-height); background: white; border-bottom: 1px solid var(--border);
            padding: 0 32px; display: flex; align-items: center; justify-content: space-between;
        }
        .view { flex: 1; padding: 32px; overflow-y: auto; display: none; }
        .view.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- Components: Buttons & Cards --- */
        .btn {
            padding: 10px 20px; border: none; border-radius: var(--radius-md); font-weight: 600;
            cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-size: 0.9rem;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-secondary { background: white; border: 1px solid var(--border); color: var(--text-main); }
        
        .card {
            background: white; border-radius: var(--radius-lg); padding: 24px;
            box-shadow: var(--shadow-card); margin-bottom: 24px; border: 1px solid var(--border);
        }
        
        /* --- Forms & Tables --- */
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; margin-bottom: 6px; font-size: 0.85rem; font-weight: 600; color: var(--text-secondary); }
        .form-input, .form-select, .form-textarea {
            width: 100%; padding: 10px 12px; border: 1px solid var(--border);
            border-radius: var(--radius-md); font-size: 0.95rem; transition: border 0.2s;
        }
        .form-input:focus { border-color: var(--primary); ring: 2px var(--primary-light); }

        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { text-align: left; padding: 12px 16px; background: var(--surface-200); color: var(--text-muted); font-weight: 600; }
        td { padding: 12px 16px; border-bottom: 1px solid var(--border); }
        tr:hover td { background: var(--surface-300); }

        /* --- Dashboard Stats --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 24px; margin-bottom: 32px; }
        .stat-card { background: white; padding: 24px; border-radius: var(--radius-lg); border: 1px solid var(--border); display: flex; flex-direction: column; }
        .stat-value { font-size: 2rem; font-weight: 700; color: var(--text-main); margin: 8px 0; }
        .stat-label { font-size: 0.85rem; color: var(--text-muted); font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }

        /* --- Modals (New Implementation) --- */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
            z-index: 50; display: none; align-items: center; justify-content: center;
        }
        .modal-backdrop.open { display: flex; }
        .modal-content {
            background: white; width: 90%; max-width: 500px;
            border-radius: var(--radius-lg); padding: 32px;
            box-shadow: var(--shadow-modal); position: relative;
            animation: modalPop 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes modalPop { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- Contract Editor & Signing --- */
        #contract-editor {
            min-height: 500px; padding: 40px; border: 1px solid var(--border);
            background: white; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        
        /* Signing Page Specifics */
        .signing-container { max-width: 800px; margin: 40px auto; padding: 0 20px; }
        .signing-paper { background: white; padding: 40px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-radius: 4px; }
    </style>
</head>
<body class="not-authenticated">

    <div id="login-overlay">
        <div class="login-card">
            <h2 style="margin-bottom: 8px; color: var(--text-main);">Bem-vindo</h2>
            <p style="color: var(--text-muted); margin-bottom: 24px;">Acesse o Legacy CRM Enterprise</p>
            <div id="login-error" style="color: var(--danger); font-size: 0.9rem; margin-bottom: 16px; display:none;"></div>
            <form onsubmit="authManager.login(event)">
                <div class="form-group">
                    <label class="form-label">Email Corporativo</label>
                    <input type="email" id="login-email" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Senha de Acesso</label>
                    <input type="password" id="login-password" class="form-input" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center; padding: 12px;">Entrar no Sistema</button>
            </form>
        </div>
    </div>

    <div id="modal-client" class="modal-backdrop">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px;">Novo Cliente</h3>
            <form id="form-client" onsubmit="clientManager.submitForm(event)">
                <div class="form-group">
                    <label class="form-label">Nome Completo *</label>
                    <input type="text" name="name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">CPF / CNPJ</label>
                    <input type="text" name="doc" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" name="email" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Telefone (WhatsApp)</label>
                    <input type="text" name="phone" class="form-input">
                </div>
                <div class="form-group" style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px;">
                    <div>
                        <label class="form-label">Endereço</label>
                        <input type="text" name="address" class="form-input">
                    </div>
                    <div>
                        <label class="form-label">Cidade</label>
                        <input type="text" name="city" class="form-input">
                    </div>
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 24px;">
                    <button type="button" class="btn btn-secondary" onclick="ui.closeModal('modal-client')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Cliente</button>
                </div>
            </form>
        </div>
    </div>

    <aside>
        <div class="brand"><i class="fas fa-cube"></i> Legacy CRM</div>
        <div class="nav-menu">
            <button class="nav-btn active" onclick="app.nav('dashboard')"><i class="fas fa-chart-pie"></i> Visão Geral</button>
            <button class="nav-btn" onclick="app.nav('clients')"><i class="fas fa-users"></i> Carteira de Clientes</button>
            <button class="nav-btn" onclick="app.nav('create')"><i class="fas fa-file-signature"></i> Novo Contrato</button>
            <button class="nav-btn" onclick="app.nav('history')"><i class="fas fa-history"></i> Histórico & Status</button>
            <button class="nav-btn" onclick="app.nav('templates')"><i class="fas fa-layer-group"></i> Modelos</button>
            <button class="nav-btn" onclick="app.nav('config')"><i class="fas fa-sliders-h"></i> Configurações</button>
        </div>
        <div style="padding: 20px;">
            <button class="btn btn-danger" onclick="authManager.logout()" style="width: 100%; justify-content: center; font-size: 0.8rem;">
                <i class="fas fa-sign-out-alt"></i> Sair
            </button>
        </div>
    </aside>

    <main>
        <div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px;"></div>

        <div id="view-dashboard" class="view active">
            <header style="margin: -32px -32px 32px -32px; padding: 24px 32px; background: white; border-bottom: 1px solid var(--border);">
                <h1>Dashboard Operacional</h1>
            </header>
            
            <div class="stats-grid">
                <div class="stat-card" style="border-left: 4px solid var(--primary);">
                    <div class="stat-label">Clientes Ativos</div>
                    <div class="stat-value" id="stat-clients">0</div>
                </div>
                <div class="stat-card" style="border-left: 4px solid var(--success);">
                    <div class="stat-label">Contratos Assinados</div>
                    <div class="stat-value" id="stat-signed">0</div>
                </div>
                <div class="stat-card" style="border-left: 4px solid var(--warning);">
                    <div class="stat-label">Pendentes de Assinatura</div>
                    <div class="stat-value" id="stat-pending">0</div>
                </div>
                <div class="stat-card" style="border-left: 4px solid var(--danger);">
                    <div class="stat-label">Vencendo em 7 dias</div> <div class="stat-value" id="stat-expiring">0</div>
                </div>
            </div>

            <div class="card" id="alert-panel" style="display: none; background: var(--warning-bg); border-color: var(--warning);">
                <h3 style="color: #854d0e; margin-bottom: 15px;"><i class="fas fa-exclamation-triangle"></i> Atenção aos Prazos</h3>
                <div id="expiration-list"></div>
            </div>

            <div class="card">
                <h3>Atividade Recente</h3>
                <div id="recent-activity" style="margin-top: 15px;"></div>
            </div>
        </div>

        <div id="view-clients" class="view">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h1>Gestão de Clientes</h1>
                <button class="btn btn-primary" onclick="clientManager.openModal()">
                    <i class="fas fa-plus"></i> Novo Cliente
                </button>
            </div>
            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>Cliente</th>
                            <th>Contato</th>
                            <th>Cidade</th>
                            <th width="100">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="clients-table-body"></tbody>
                </table>
            </div>
        </div>
<div id="view-create" class="view">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h1>Novo Contrato</h1>
                <div style="display: gap: 10px;">
                    <button class="btn btn-secondary" onclick="contractManager.loadTemplateModal()">
                        <i class="fas fa-folder-open"></i> Templates
                    </button>
                    <button class="btn btn-primary" onclick="contractManager.saveTemplate()">
                        <i class="fas fa-save"></i> Salvar como Modelo
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label class="form-label">Selecione o Cliente</label>
                        <select id="contract-client-select" class="form-select" onchange="contractManager.fillClientData()">
                            <option value="">-- Selecione --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Validade da Proposta</label> <input type="date" id="contract-expires" class="form-input">
                    </div>
                    <div class="form-group" style="display: flex; align-items: flex-end;">
                        <button class="btn btn-success" style="width: 100%; justify-content: center;" onclick="signingLinkManager.generate()">
                            <i class="fab fa-whatsapp"></i> Gerar Link de Assinatura
                        </button>
                    </div>
                </div>
                
                <input type="hidden" id="c-name"> <input type="hidden" id="c-doc"> 
                <input type="hidden" id="c-address"> <input type="hidden" id="c-city">
                
                <div id="contract-editor" contenteditable="true">
                    <h2 style="text-align: center;">CONTRATO DE PRESTAÇÃO DE SERVIÇOS</h2>
                    <p><br></p>
                    <p><strong>CONTRATANTE:</strong> {CLIENTE}, inscrito no CPF/CNPJ {DOCUMENTO}, residente em {ENDERECO}, {CIDADE}.</p>
                    <p><br></p>
                    <p><strong>CLÁUSULA 1:</strong> O presente contrato tem como objeto...</p>
                    <p><br></p>
                    <p style="text-align: center; margin-top: 50px;">_________________________________</p>
                    <p style="text-align: center;">Assinatura do Contratante</p>
                </div>
            </div>
        </div>

        <div id="view-history" class="view">
            <h1>Histórico de Documentos</h1>
            <div class="card" style="margin-top: 24px;">
                <table>
                    <thead>
                        <tr>
                            <th>Cliente</th>
                            <th>Criado em</th>
                            <th>Validade</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body"></tbody>
                </table>
            </div>
        </div>

        <div id="view-templates" class="view"><h1>Modelos</h1><div class="card" id="templates-list"></div></div>
        <div id="view-config" class="view"><h1>Configurações</h1><div class="card"><p>Configurações da empresa aqui.</p></div></div>
    </main>

    <div id="signing-page-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8fafc; overflow-y: auto; z-index: 20000;">
        <div class="signing-container">
            <div style="text-align: center; margin-bottom: 30px; padding-top: 40px;">
                <h1 style="color: var(--primary-dark);">Assinatura Digital</h1>
                <p style="color: var(--text-muted);" id="sp-client-name">Carregando documento...</p>
            </div>

            <div id="document-to-print" class="signing-paper">
                <div id="sp-contract-body"></div>
                
                <div id="sp-signature-result" style="display: none; margin-top: 40px; border-top: 1px solid #ddd; padding-top: 20px;">
                    <p>Assinado Digitalmente por: <strong id="sp-signer-name"></strong></p>
                    <p>Data: <span id="sp-signed-date"></span></p>
                    <p>IP: <span id="sp-signed-ip">Registrado</span></p>
                    <img id="sp-signature-img" style="max-height: 100px; margin-top: 10px;" />
                </div>
            </div>

            <div id="sp-action-area" class="card" style="margin-top: 30px; border: 2px dashed var(--primary);">
                <h3 style="margin-bottom: 15px;">Desenhe sua assinatura abaixo:</h3>
                <canvas id="sp-canvas" style="width: 100%; height: 200px; background: #fff; border: 1px solid #ccc; cursor: crosshair; touch-action: none;"></canvas>
                <div style="display: flex; gap: 15px; margin-top: 15px; justify-content: center;">
                    <button class="btn btn-secondary" onclick="signingPage.clear()">Limpar</button>
                    <button class="btn btn-success" onclick="signingPage.submit()">Confirmar Assinatura</button>
                </div>
            </div>

            <div id="sp-success-area" style="display: none; text-align: center; margin-top: 40px; padding-bottom: 40px;">
                <div style="color: var(--success); font-size: 1.5rem; margin-bottom: 20px;">
                    <i class="fas fa-check-circle"></i> Documento Assinado com Sucesso!
                </div>
                <button class="btn btn-primary" onclick="signingPage.downloadPDF()">
                    <i class="fas fa-file-pdf"></i> Baixar Cópia Assinada (PDF)
                </button>
            </div>
        </div>
    </div>

<script>
// CONFIGURAÇÃO SUPABASE
const SUPABASE_URL = 'https://rjyxkouegrropsarrhje.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJqeXhrb3VlZ3Jyb3BzYXJyaGplIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1NjYxNjcsImV4cCI6MjA4NTE0MjE2N30.UjNPnVBVhQcUSirXeWZ3RmYmAhDMqqbbVUChG_Mv57U';
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// UTILS
const ui = {
    toast: (msg, type='info') => {
        const d = document.createElement('div');
        d.style.cssText = `padding: 12px 20px; background: white; border-left: 4px solid var(--${type}); border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-size: 0.9rem; animation: fadeIn 0.3s;`;
        d.innerHTML = `<strong>${type.toUpperCase()}:</strong> ${msg}`;
        document.getElementById('toast-container').appendChild(d);
        setTimeout(() => d.remove(), 4000);
    },
    openModal: (id) => {
        document.getElementById(id).classList.add('open');
    },
    closeModal: (id) => {
        document.getElementById(id).classList.remove('open');
    }
};

// AUTH & ROUTING
const authManager = {
    init: async () => {
        // 1. Checa se é link de assinatura (PRIORIDADE MÁXIMA)
        const params = new URLSearchParams(window.location.search);
        const signId = params.get('sign');
        
        if (signId) {
            document.body.className = 'signing-mode'; // CSS esconde tudo exceto a assinatura
            signingPage.init(signId);
            return; 
        }

        // 2. Fluxo Normal de Admin
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session) {
            authManager.enterApp();
        } else {
            document.body.className = 'not-authenticated';
        }
    },
    login: async (e) => {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-password').value;
        const { error } = await supabaseClient.auth.signInWithPassword({ email, password: pass });
        if (error) {
            document.getElementById('login-error').innerText = 'Credenciais inválidas.';
            document.getElementById('login-error').style.display = 'block';
        } else {
            authManager.enterApp();
        }
    },
    enterApp: () => {
        document.body.className = 'authenticated';
        app.loadData();
    },
    logout: async () => {
        await supabaseClient.auth.signOut();
        location.reload();
    }
};

// DATA MANAGERS
const db = { clients: [], contracts: [] };

const app = {
    nav: (viewId) => {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('view-'+viewId).classList.add('active');
        // Simple logic to find button, optimization omitted for brevity
        event.target.closest('.nav-btn')?.classList.add('active');
    },
    loadData: async () => {
        // Carregar Clientes
        let { data: clients } = await supabaseClient.from('signature_requests').select('*').eq('is_client_record', true);
        db.clients = clients || [];
        clientManager.render();
        
        // Carregar Contratos
        let { data: contracts } = await supabaseClient.from('signature_requests').select('*').eq('is_client_record', false).order('created_at', {ascending: false});
        db.contracts = contracts || [];
        
        dashboard.update();
        contractManager.renderHistory();
        contractManager.populateSelect();
    }
};

const clientManager = {
    openModal: () => {
        document.getElementById('form-client').reset();
        ui.openModal('modal-client');
    },
    submitForm: async (e) => {
        e.preventDefault();
        const f = new FormData(e.target);
        const clientData = {
            client_name: f.get('name'),
            client_document: f.get('doc'),
            client_email: f.get('email'),
            client_phone: f.get('phone'),
            client_address: f.get('address'),
            client_city: f.get('city'),
            is_client_record: true,
            status: 'pending',
            contract_html: 'FICHA_CADASTRAL' // Required field bypass
        };

        const { error } = await supabaseClient.from('signature_requests').insert([clientData]);
        if(error) ui.toast('Erro ao salvar: ' + error.message, 'danger');
        else {
            ui.toast('Cliente salvo com sucesso!', 'success');
            ui.closeModal('modal-client');
            app.loadData(); // Recarrega tudo
        }
    },
    render: () => {
        const tbody = document.getElementById('clients-table-body');
        tbody.innerHTML = db.clients.map(c => `
            <tr>
                <td><strong>${c.client_name}</strong><br><span style="font-size:0.8em; color:#666">${c.client_email || ''}</span></td>
                <td>${c.client_phone || '-'}</td>
                <td>${c.client_city || '-'}</td>
                <td><button class="btn btn-secondary btn-sm"><i class="fas fa-edit"></i></button></td>
            </tr>
        `).join('');
    }
};

const contractManager = {
    populateSelect: () => {
        const sel = document.getElementById('contract-client-select');
        sel.innerHTML = '<option value="">-- Selecione o Cliente --</option>' + 
            db.clients.map(c => `<option value="${c.id}">${c.client_name}</option>`).join('');
    },
    fillClientData: () => {
        const id = document.getElementById('contract-client-select').value;
        const c = db.clients.find(x => x.id === id);
        if(c) {
            // Atualiza HTML do editor com replace simples
            const editor = document.getElementById('contract-editor');
            let html = editor.innerHTML;
            html = html.replace('{CLIENTE}', c.client_name)
                       .replace('{DOCUMENTO}', c.client_document || '...')
                       .replace('{ENDERECO}', c.client_address || '...')
                       .replace('{CIDADE}', c.client_city || '...');
            editor.innerHTML = html;
            // Guardar dados ocultos para usar no insert
            document.getElementById('c-name').value = c.client_name;
        }
    },
    renderHistory: () => {
        const tbody = document.getElementById('history-table-body');
        tbody.innerHTML = db.contracts.map(c => {
            const statusMap = {
                'signed': '<span style="color:green; font-weight:bold">Assinado</span>',
                'pending': '<span style="color:orange">Pendente</span>',
                'expired': '<span style="color:red">Vencido</span>'
            };
            // Checagem de validade visual
            let validade = c.expires_at ? new Date(c.expires_at).toLocaleDateString('pt-BR') : '-';
            
            return `
            <tr>
                <td>${c.client_name}</td>
                <td>${new Date(c.created_at).toLocaleDateString('pt-BR')}</td>
                <td>${validade}</td>
                <td>${statusMap[c.status] || c.status}</td>
                <td>
                     <button class="btn btn-secondary" onclick="window.open('${window.location.origin + window.location.pathname}?sign=${c.id}', '_blank')"><i class="fas fa-link"></i></button>
                </td>
            </tr>`;
        }).join('');
    }
};

const signingLinkManager = {
    generate: async () => {
        const clientName = document.getElementById('c-name').value;
        if(!clientName) return ui.toast('Selecione um cliente primeiro', 'warning');
        
        const html = document.getElementById('contract-editor').innerHTML;
        const expires = document.getElementById('contract-expires').value; // DATA DE VALIDADE

        const payload = {
            client_name: clientName,
            contract_html: html,
            is_client_record: false,
            status: 'pending',
            expires_at: expires ? new Date(expires).toISOString() : null
        };

        const { data, error } = await supabaseClient.from('signature_requests').insert([payload]).select().single();
        
        if(error) {
            ui.toast('Erro ao criar contrato: ' + error.message, 'danger');
        } else {
            const link = `${window.location.origin}${window.location.pathname}?sign=${data.id}`;
            // Simular envio ou copiar
            prompt("Link gerado com sucesso! Copie e envie ao cliente:", link);
            app.loadData();
        }
    }
};

const dashboard = {
    update: () => {
        document.getElementById('stat-clients').innerText = db.clients.length;
        document.getElementById('stat-signed').innerText = db.contracts.filter(c => c.status === 'signed').length;
        document.getElementById('stat-pending').innerText = db.contracts.filter(c => c.status === 'pending').length;
        
        // Logica de Expiração (Próximos 7 dias e Pendentes)
        const now = new Date();
        const nextWeek = new Date();
        nextWeek.setDate(now.getDate() + 7);
        
        const expiring = db.contracts.filter(c => {
            if(!c.expires_at || c.status === 'signed') return false;
            const d = new Date(c.expires_at);
            return d > now && d <= nextWeek;
        });
        
        document.getElementById('stat-expiring').innerText = expiring.length;
        
        if(expiring.length > 0) {
            const alertPanel = document.getElementById('alert-panel');
            alertPanel.style.display = 'block';
            document.getElementById('expiration-list').innerHTML = expiring.map(c => 
                `<div><strong>${c.client_name}</strong> vence dia ${new Date(c.expires_at).toLocaleDateString('pt-BR')}</div>`
            ).join('');
        }
    }
};

// --- SIGNING PAGE LOGIC (PUBLIC) ---
const signingPage = {
    id: null,
    canvas: null,
    ctx: null,
    
    init: async (id) => {
        signingPage.id = id;
        
        // Setup Canvas
        signingPage.canvas = document.getElementById('sp-canvas');
        signingPage.ctx = signingPage.canvas.getContext('2d');
        signingPage.resizeCanvas();
        window.addEventListener('resize', signingPage.resizeCanvas);
        signingPage.addEvents();

        // Load Data (PUBLIC READ assumed via Anon Key)
        const { data, error } = await supabaseClient.from('signature_requests').select('*').eq('id', id).single();
        
        if(error || !data) {
            alert('Documento não encontrado ou acesso restrito.');
            return;
        }

        document.getElementById('sp-client-name').innerText = data.client_name;
        document.getElementById('sp-contract-body').innerHTML = data.contract_html;

        // Se já assinado
        if(data.status === 'signed') {
            document.getElementById('sp-action-area').style.display = 'none';
            document.getElementById('sp-success-area').style.display = 'block';
            document.getElementById('sp-signature-result').style.display = 'block';
            document.getElementById('sp-signature-img').src = data.signature_data;
            document.getElementById('sp-signed-date').innerText = new Date(data.signed_at).toLocaleString();
            document.getElementById('sp-signer-name').innerText = data.client_name;
        }
    },

    resizeCanvas: () => {
        const c = signingPage.canvas;
        c.width = c.offsetWidth;
        c.height = 200;
        signingPage.ctx.lineWidth = 2;
        signingPage.ctx.strokeStyle = '#000';
    },

    addEvents: () => {
        let isDrawing = false;
        const c = signingPage.canvas;
        const ctx = signingPage.ctx;

        const getPos = (e) => {
            const rect = c.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: clientX - rect.left, y: clientY - rect.top };
        };

        const start = (e) => { isDrawing = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); };
        const move = (e) => { if(!isDrawing) return; e.preventDefault(); const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); };
        const end = () => { isDrawing = false; };

        c.addEventListener('mousedown', start); c.addEventListener('touchstart', start);
        c.addEventListener('mousemove', move); c.addEventListener('touchmove', move);
        c.addEventListener('mouseup', end); c.addEventListener('touchend', end);
    },

    clear: () => {
        signingPage.ctx.clearRect(0,0, signingPage.canvas.width, signingPage.canvas.height);
    },

    submit: async () => {
        const signData = signingPage.canvas.toDataURL();
        // Verificar se está vazio (lógica simples)
        if(signData.length < 1000) return alert('Por favor, assine antes de confirmar.');

        const { error } = await supabaseClient.from('signature_requests').update({
            status: 'signed',
            signature_data: signData,
            signed_at: new Date().toISOString(),
            ip_address: 'CLIENT_IP' // Supabase não pega IP no client-side direto, precisa de Edge Function, mas deixamos placeholder
        }).eq('id', signingPage.id);

        if(error) alert('Erro ao salvar: ' + error.message);
        else location.reload(); // Recarrega para mostrar estado de sucesso
    },

    downloadPDF: () => {
        const element = document.getElementById('document-to-print');
        const opt = {
            margin: 10,
            filename: 'contrato_assinado.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(element).save();
    }
};

// Inicializa
authManager.init();

</script>
</body>
</html>
